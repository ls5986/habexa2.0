import{u as Te,r as p,af as De,W as Be,M as Ue,j as e,B as n,T as a,C as I,b as R,ac as ge,q as P,a as m,h as g,p as Q,Z as fe,a8 as me,a9 as be,aa as ye,ab as U,F as Ee,d as F,D as je,e as qe,o as X}from"./index-CWAbI_84.js";import{R as Me,a as _e,h as ve}from"./errorHandler-BhGbC50L.js";import{T as Je}from"./trash-2-BTpuFs4Y.js";import{P as Ae}from"./plus-BJNftltY.js";import{R as Ce}from"./refresh-cw-BTS2mDLZ.js";import{D as Oe}from"./dollar-sign-XoVrNkqM.js";import{E as Ge}from"./external-link-CQb_kU7C.js";import{G as we}from"./Grid-DTR2KApN.js";const es=()=>{const j=Te(),[E,Ie]=p.useState("single"),[k,H]=p.useState(""),[C,K]=p.useState(""),[ee,se]=p.useState(1),[W,q]=p.useState(""),[t,b]=p.useState(null),[M,_]=p.useState(null),[A,u]=p.useState(!1),[te,re]=p.useState(!1),[N,S]=p.useState([]),h=p.useRef(null),[f,T]=p.useState([{asin:"",buy_cost:"",moq:1}]),[x,D]=p.useState(null),{analyzeSingle:ke,analyzeBatch:Se,loading:J}=De(),{suppliers:ne}=Be(),{showToast:c}=Ue();p.useEffect(()=>{try{const s=localStorage.getItem("recentAnalyses");s&&S(JSON.parse(s))}catch(s){console.error("Failed to load recent analyses:",s)}},[]),p.useEffect(()=>{if(N.length>0)try{localStorage.setItem("recentAnalyses",JSON.stringify(N.slice(0,10)))}catch(s){console.error("Failed to save recent analyses:",s)}},[N]),p.useEffect(()=>()=>{h.current&&(h.current(),h.current=null)},[]);const ze=async()=>{E==="single"?await Re():await oe()},Re=async()=>{if(!k||!C){c("Please enter ASIN and buy cost","error");return}b(null),_(null),u(!0),h.current&&(h.current(),h.current=null);try{const s=await ke(k,parseFloat(C),ee,W||null);if(console.log("âœ… Analysis API response:",s),s&&s.result&&s.status==="completed"){console.log("âœ… Analysis completed synchronously:",s.result);const o={asin:s.asin,title:s.result.title||"Unknown",deal_score:s.result.deal_score??"N/A",net_profit:s.result.net_profit??0,roi:s.result.roi??0,gating_status:s.result.gating_status||"unknown",meets_threshold:s.result.meets_threshold??!1,is_profitable:(s.result.net_profit||0)>0,sell_price:s.result.sell_price,buy_cost:s.result.buy_cost||parseFloat(C),product_id:s.product_id,image_url:s.result.image_url,brand:s.result.brand,category:s.result.category};b(o),u(!1),c("Analysis complete!","success"),S(r=>[o,...r].slice(0,10));return}if(s&&s.job_id){console.log("âš ï¸ Got job_id response (should only happen for batch):",s.job_id),c("Analysis started! Waiting for results...","info");const o=()=>{let r=1e3;const v=1e4;let B,le=!1;const ie=s.job_id,L=async()=>{var ce,de,ue,pe,he,xe;if(le){console.log("âŒ Polling cancelled");return}try{console.log(`ðŸ”„ Polling job: ${ie} (interval: ${r}ms)`);const i=(await X.get(`/jobs/${ie}`)).data;if(console.log(`ðŸ“Š Job status: ${i.status}`,i),i.status==="completed"){console.log("âœ… Job completed! Fetching results...");try{const w=s.product_id||((ce=i.metadata)==null?void 0:ce.product_id),Y=s.asin||((de=i.metadata)==null?void 0:de.asin);console.log("ðŸ“¦ Fetching data for product_id:",w,"asin:",Y);try{const y=await X.get(`/deals?asin=${Y}`),l=(Array.isArray(y.data)?y.data:Array.isArray((ue=y.data)==null?void 0:ue.deals)?y.data.deals:[]).find(z=>z.asin===Y);if(l&&(l.deal_score!==void 0||l.roi!==void 0)){const z={asin:l.asin,title:l.title||l.product_title||"Unknown",deal_score:l.deal_score??"N/A",net_profit:l.net_profit??l.profit??0,roi:l.roi??0,gating_status:l.gating_status||"unknown",meets_threshold:l.meets_threshold??!1,is_profitable:(l.net_profit||l.profit||0)>0,sell_price:l.sell_price,buy_cost:l.buy_cost||parseFloat(C),product_id:w,image_url:l.image_url,brand:l.brand,category:l.category};b(z),u(!1),c("Analysis complete!","success"),S(We=>[z,...We].slice(0,10));return}}catch(y){console.warn("Could not fetch from deals endpoint:",y)}if(w){const d=(await X.get(`/products/${w}`)).data,l={asin:d.asin,title:d.title||"Unknown",deal_score:d.deal_score||"N/A",net_profit:d.net_profit||d.profit||0,roi:d.roi||0,gating_status:d.gating_status||"unknown",meets_threshold:d.meets_threshold??!1,is_profitable:(d.net_profit||d.profit||0)>0,sell_price:d.sell_price,buy_cost:d.buy_cost||parseFloat(C),product_id:w,image_url:d.image_url,brand:d.brand,category:d.category};b(l),u(!1),c("Analysis complete!","success"),S(z=>[l,...z].slice(0,10));return}if(i.result){console.log("âœ… Using job.result:",i.result);const y={asin:i.result.asin||((pe=i.metadata)==null?void 0:pe.asin)||k,title:i.result.title||i.result.product_title||"Unknown",deal_score:i.result.deal_score??"N/A",net_profit:i.result.net_profit??i.result.profit??0,roi:i.result.roi??0,gating_status:i.result.gating_status||"unknown",meets_threshold:i.result.meets_threshold??!1,is_profitable:(i.result.net_profit||i.result.profit||0)>0,product_id:s.product_id};b(y),u(!1),c("Analysis complete!","success"),S(d=>[y,...d].slice(0,10));return}console.log("âš ï¸ No product/deal data found, showing basic info"),b({asin:s.asin||k,title:"Analysis completed - check Products page for details",product_id:s.product_id}),u(!1),c("Analysis complete! Check Products page for full details.","success")}catch(w){console.error("Failed to fetch analysis results:",w),u(!1),c("Analysis completed but could not load results. Check Products page.","warning")}return}else if(i.status==="failed"){u(!1),c("Analysis failed. Please try again.","error"),_("Analysis job failed");return}r=Math.min(r*2,v),B=setTimeout(L,r)}catch($){if(console.error("âŒ Error polling job:",$),console.error("Error details:",(he=$.response)==null?void 0:he.data,$.message),((xe=$.response)==null?void 0:xe.status)===404){console.error("âŒ Job not found (404)"),u(!1),c("Job not found","warning"),_("Analysis job not found");return}console.log(`âš ï¸ Retrying poll in ${r}ms after error`),B=setTimeout(L,r)}};return L(),()=>{le=!0,B&&clearTimeout(B)}};h.current=o(),console.log("âœ… Polling function started, cleanup stored");return}s.asin||s.product_id?(console.log("âœ… Direct result (no job_id):",s),b(s),u(!1),c("Analysis complete!","success"),S(o=>[s,...o].slice(0,10))):(console.error("âŒ Unexpected response format:",s),u(!1),_("Unexpected response format from analysis API. Expected job_id or product data."))}catch(s){console.error("âŒ Analysis error:",s),u(!1);const o=ve(s,c);_(o)}},oe=async()=>{const s=f.filter(o=>o.asin&&o.buy_cost);if(s.length===0){c("Please enter at least one ASIN and buy cost","error");return}D(null),_(null),u(!0),h.current&&(h.current(),h.current=null);try{const o=s.map(v=>({asin:v.asin.trim().toUpperCase(),buy_cost:parseFloat(v.buy_cost),moq:parseInt(v.moq)||1,supplier_id:W||null})),r=await Se(o);if(console.log("âœ… Batch analysis response:",r),r.mode==="sync")console.log("âœ… Synchronous batch analysis - instant results!"),D({mode:"sync",total:r.total,results:r.results||[]}),u(!1),c(`âœ… Analyzed ${r.total} product${r.total>1?"s":""} instantly!`,"success");else if(r.mode==="async")console.log("â³ Async batch analysis - polling job:",r.job_id),c(`â³ Analyzing ${r.total} products in background...`,"info"),j(`/jobs/${r.job_id}`),u(!1);else throw new Error("Unexpected response format")}catch(o){console.error("âŒ Batch analysis error:",o),u(!1);const r=ve(o,c);_(r)}},Pe=()=>{T([...f,{asin:"",buy_cost:"",moq:1}])},Fe=s=>{f.length>1&&T(f.filter((o,r)=>r!==s))},O=(s,o,r)=>{const v=[...f];v[s]={...v[s],[o]:r},T(v)},G=()=>{h.current&&(h.current(),h.current=null),b(null),D(null),_(null),u(!1),H(""),K(""),se(1),q(""),T([{asin:"",buy_cost:"",moq:1}])},Ne=async()=>{if(!t){c("No analysis result to add.","warning");return}re(!0);try{c("Product is in your list! Redirecting...","success"),setTimeout(()=>{t.asin?j(`/products?asin=${t.asin}`):j("/products")},1e3)}catch(s){console.error("Failed to navigate to product:",s),c("Redirecting to products page...","info"),setTimeout(()=>{t.asin?j(`/products?asin=${t.asin}`):j("/products")},500)}finally{re(!1)}},ae=s=>{b(s)},$e=()=>{t!=null&&t.asin?j(`/products?asin=${t.asin}`):t!=null&&t.product_id?j(`/products?product_id=${t.product_id}`):j("/products")},V=s=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(s||0),Z=s=>!s&&s!==0?"N/A":`${s>=0?"+":""}${s.toFixed(1)}%`;return e.jsxs(n,{children:[e.jsx(a,{variant:"h4",fontWeight:700,mb:1,children:"Analyze Products"}),e.jsx(a,{variant:"body1",color:"text.secondary",mb:4,children:"Enter an ASIN to get instant profitability analysis"}),e.jsx(I,{sx:{mb:4},children:e.jsx(R,{children:e.jsxs(n,{display:"flex",flexDirection:"column",gap:3,children:[e.jsxs(Me,{value:E,onChange:s=>{Ie(s.target.value),b(null),D(null),_(null)},row:!0,children:[e.jsx(ge,{value:"single",control:e.jsx(_e,{}),label:"Single ASIN"}),e.jsx(ge,{value:"bulk",control:e.jsx(_e,{}),label:"Bulk Analysis"})]}),E==="single"?e.jsxs(e.Fragment,{children:[e.jsxs(n,{display:"flex",gap:2,children:[e.jsx(P,{fullWidth:!0,label:"ASIN",placeholder:"B08XYZ1234",value:k,onChange:s=>H(s.target.value.toUpperCase()),sx:{fontFamily:"monospace"},disabled:!!t}),e.jsx(m,{variant:"contained",startIcon:A?e.jsx(Q,{size:16,color:"inherit"}):e.jsx(fe,{size:16}),onClick:ze,disabled:J||A||!k||!C||!!t,sx:{backgroundColor:g.purple.main,"&:hover":{backgroundColor:g.purple.dark},minWidth:150},children:A?"Analyzing...":J?"Starting...":"Analyze"})]}),e.jsxs(n,{display:"flex",gap:2,children:[e.jsx(P,{label:"Your Cost",type:"number",value:C,onChange:s=>K(s.target.value),InputProps:{startAdornment:"$"},sx:{flex:1},disabled:!!t}),e.jsx(P,{label:"MOQ",type:"number",value:ee,onChange:s=>se(parseInt(s.target.value)||1),sx:{flex:1},disabled:!!t}),e.jsxs(me,{sx:{flex:1},children:[e.jsx(be,{children:"Supplier"}),e.jsxs(ye,{value:W,label:"Supplier",onChange:s=>q(s.target.value),disabled:!!t,children:[e.jsx(U,{value:"",children:"None"}),ne.map(s=>e.jsx(U,{value:s.id,children:s.name},s.id))]})]})]})]}):e.jsx(e.Fragment,{children:e.jsxs(n,{display:"flex",flexDirection:"column",gap:2,children:[f.map((s,o)=>e.jsxs(n,{display:"flex",gap:2,alignItems:"center",children:[e.jsx(P,{label:"ASIN",placeholder:"B08XYZ1234",value:s.asin,onChange:r=>O(o,"asin",r.target.value.toUpperCase()),sx:{fontFamily:"monospace",flex:2},disabled:!!x}),e.jsx(P,{label:"Cost",type:"number",value:s.buy_cost,onChange:r=>O(o,"buy_cost",r.target.value),InputProps:{startAdornment:"$"},sx:{flex:1},disabled:!!x}),e.jsx(P,{label:"MOQ",type:"number",value:s.moq,onChange:r=>O(o,"moq",r.target.value),sx:{width:100},disabled:!!x}),f.length>1&&e.jsx(m,{variant:"outlined",color:"error",onClick:()=>Fe(o),disabled:!!x,sx:{minWidth:40},children:e.jsx(Je,{size:16})})]},o)),e.jsxs(n,{display:"flex",gap:2,alignItems:"center",children:[e.jsx(m,{variant:"outlined",startIcon:e.jsx(Ae,{size:16}),onClick:Pe,disabled:!!x,children:"Add Another ASIN"}),e.jsxs(me,{sx:{flex:1,maxWidth:200},children:[e.jsx(be,{children:"Supplier (All)"}),e.jsxs(ye,{value:W,label:"Supplier (All)",onChange:s=>q(s.target.value),disabled:!!x,children:[e.jsx(U,{value:"",children:"None"}),ne.map(s=>e.jsx(U,{value:s.id,children:s.name},s.id))]})]})]}),e.jsx(m,{variant:"contained",startIcon:A?e.jsx(Q,{size:16,color:"inherit"}):e.jsx(fe,{size:16}),onClick:oe,disabled:J||A||!!x||f.filter(s=>s.asin&&s.buy_cost).length===0,sx:{backgroundColor:g.purple.main,"&:hover":{backgroundColor:g.purple.dark},mt:1},children:A?"Analyzing...":`Analyze ${f.filter(s=>s.asin&&s.buy_cost).length} Product${f.filter(s=>s.asin&&s.buy_cost).length!==1?"s":""}`}),e.jsx(a,{variant:"caption",color:"text.secondary",sx:{mt:-1},children:f.filter(s=>s.asin&&s.buy_cost).length<=10?"âš¡ Results will appear instantly (â‰¤10 products)":"â³ Analysis will run in background (track progress on Jobs page)"})]})})]})})}),M&&e.jsx(I,{sx:{mb:4,borderColor:"error.main",border:1},children:e.jsxs(R,{children:[e.jsxs(Ee,{severity:"error",sx:{mb:2},children:[e.jsx(a,{variant:"body1",fontWeight:600,children:"Analysis Failed"}),e.jsx(a,{variant:"body2",mt:1,children:M})]}),e.jsx(m,{variant:"outlined",startIcon:e.jsx(Ce,{size:16}),onClick:G,children:"Try Again"})]})}),t&&e.jsx(I,{sx:{mb:4,borderColor:t.roi>=30?"success.main":t.roi>0?"warning.main":"error.main",border:2},children:e.jsxs(R,{children:[e.jsxs(n,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(a,{variant:"h5",fontWeight:700,children:"Analysis Results"}),e.jsx(F,{label:t.roi>=30?"Highly Profitable":t.roi>0?"Profitable":"Unprofitable",color:t.roi>=30?"success":t.roi>0?"warning":"error",sx:{fontWeight:600}})]}),e.jsx(je,{sx:{my:2}}),e.jsxs(n,{display:"flex",flexDirection:"column",gap:2,children:[e.jsxs(n,{children:[e.jsx(a,{variant:"body2",color:"text.secondary",mb:.5,children:"Product Title"}),e.jsx(a,{variant:"body1",fontWeight:600,children:t.title||"N/A"})]}),e.jsxs(n,{children:[e.jsx(a,{variant:"body2",color:"text.secondary",mb:.5,children:"ASIN"}),e.jsx(a,{variant:"body1",fontFamily:"monospace",fontWeight:600,children:t.asin||"N/A"})]}),e.jsxs(n,{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:2,mt:2,children:[e.jsxs(n,{sx:{p:2,borderRadius:2,bgcolor:"background.paper",border:"1px solid",borderColor:"divider"},children:[e.jsxs(n,{display:"flex",alignItems:"center",gap:1,mb:1,children:[e.jsx(qe,{size:20,color:t.roi>=30?g.success.main:t.roi>0?g.warning.main:g.error.main}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"ROI"})]}),e.jsx(a,{variant:"h4",fontWeight:700,color:t.roi>=30?"success.main":t.roi>0?"warning.main":"error.main",children:Z(t.roi)})]}),e.jsxs(n,{sx:{p:2,borderRadius:2,bgcolor:"background.paper",border:"1px solid",borderColor:"divider"},children:[e.jsxs(n,{display:"flex",alignItems:"center",gap:1,mb:1,children:[e.jsx(Oe,{size:20,color:t.net_profit>0?g.success.main:g.error.main}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Net Profit"})]}),e.jsx(a,{variant:"h4",fontWeight:700,color:t.net_profit>0?"success.main":"error.main",children:V(t.net_profit)})]})]}),t.deal_score&&e.jsxs(n,{children:[e.jsx(a,{variant:"body2",color:"text.secondary",mb:.5,children:"Deal Score"}),e.jsx(a,{variant:"body1",fontWeight:600,children:t.deal_score})]}),t.gating_status&&e.jsxs(n,{children:[e.jsx(a,{variant:"body2",color:"text.secondary",mb:.5,children:"Gating Status"}),e.jsx(F,{label:t.gating_status,size:"small",color:t.gating_status==="ungated"?"success":"warning"})]}),e.jsxs(n,{display:"flex",gap:2,mt:3,children:[e.jsx(m,{variant:"contained",startIcon:e.jsx(Ae,{size:16}),onClick:Ne,disabled:te||!(t!=null&&t.product_id),sx:{backgroundColor:g.purple.main,"&:hover":{backgroundColor:g.purple.dark},flex:1},children:te?"Adding...":"Add to Products"}),e.jsx(m,{variant:"outlined",startIcon:e.jsx(Ge,{size:16}),onClick:$e,sx:{flex:1},children:"View Full Details"}),e.jsx(m,{variant:"outlined",startIcon:e.jsx(Ce,{size:16}),onClick:G,sx:{flex:1},children:"Analyze Another"})]})]})]})}),x&&x.mode==="sync"&&e.jsx(I,{sx:{mb:4,borderColor:"success.main",border:2},children:e.jsxs(R,{children:[e.jsxs(n,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(a,{variant:"h5",fontWeight:700,children:"Batch Analysis Results"}),e.jsx(F,{label:`${x.results.filter(s=>s.status==="success").length}/${x.total} Successful`,color:"success",sx:{fontWeight:600}})]}),e.jsx(je,{sx:{my:2}}),e.jsx(n,{display:"flex",flexDirection:"column",gap:2,children:x.results.map((s,o)=>e.jsx(I,{sx:{p:2,border:"1px solid",borderColor:s.status==="success"?"success.main":"error.main",bgcolor:s.status==="success"?"success.50":"error.50"},children:e.jsxs(n,{display:"flex",justifyContent:"space-between",alignItems:"start",children:[e.jsxs(n,{sx:{flex:1},children:[e.jsx(a,{variant:"subtitle1",fontWeight:600,children:s.asin}),s.status==="success"&&s.result&&e.jsxs(n,{mt:1,children:[e.jsx(a,{variant:"body2",color:"text.secondary",children:s.result.title||"Unknown"}),e.jsxs(n,{display:"flex",gap:2,mt:1,children:[e.jsxs(a,{variant:"body2",children:[e.jsx("strong",{children:"Profit:"})," ",V(s.result.net_profit||0)]}),e.jsxs(a,{variant:"body2",children:[e.jsx("strong",{children:"ROI:"})," ",Z(s.result.roi||0)]})]})]}),s.status==="failed"&&e.jsx(a,{variant:"body2",color:"error.main",mt:1,children:s.error||"Analysis failed"})]}),e.jsx(F,{label:s.status==="success"?"Success":"Failed",color:s.status==="success"?"success":"error",size:"small"})]})},o))}),e.jsxs(n,{display:"flex",gap:2,mt:3,children:[e.jsx(m,{variant:"contained",onClick:()=>j("/products"),sx:{backgroundColor:g.purple.main,"&:hover":{backgroundColor:g.purple.dark}},children:"View All Products"}),e.jsx(m,{variant:"outlined",onClick:G,children:"Analyze More"})]})]})}),!t&&!x&&!M&&!A&&e.jsxs(e.Fragment,{children:[e.jsx(a,{variant:"h6",fontWeight:600,mb:2,children:"ðŸ“‹ Recent Analyses"}),N.length===0?e.jsx(a,{color:"text.secondary",children:"No recent analyses"}):e.jsx(we,{container:!0,spacing:2,children:N.slice(0,6).map((s,o)=>e.jsx(we,{item:!0,xs:12,md:6,children:e.jsx(I,{sx:{cursor:"pointer","&:hover":{boxShadow:3}},onClick:()=>ae(s),children:e.jsx(R,{children:e.jsxs(n,{display:"flex",gap:2,alignItems:"center",children:[s.image_url&&e.jsx("img",{src:s.image_url,alt:s.title,style:{width:60,height:60,objectFit:"contain",borderRadius:4}}),e.jsxs(n,{sx:{flex:1,minWidth:0},children:[e.jsx(a,{variant:"subtitle2",noWrap:!0,fontWeight:600,children:s.title||"Unknown Product"}),e.jsx(a,{variant:"caption",color:"text.secondary",fontFamily:"monospace",children:s.asin}),e.jsxs(n,{display:"flex",gap:1,mt:1,flexWrap:"wrap",children:[s.net_profit!==void 0&&e.jsx(F,{label:`Profit: ${V(s.net_profit)}`,size:"small",color:s.net_profit>0?"success":"error"}),s.roi!==void 0&&e.jsx(F,{label:`ROI: ${Z(s.roi)}`,size:"small",color:s.roi>=30?"success":s.roi>0?"warning":"error"})]})]}),e.jsx(m,{size:"small",variant:"outlined",onClick:r=>{r.stopPropagation(),ae(s)},children:"View"})]})})})},o))})]}),A&&e.jsx(I,{sx:{mb:4},children:e.jsx(R,{children:e.jsxs(n,{display:"flex",flexDirection:"column",alignItems:"center",gap:2,py:3,children:[e.jsx(Q,{size:40}),e.jsx(a,{variant:"body1",color:"text.secondary",children:"Analyzing product... This may take a few seconds."})]})})})]})};export{es as default};

import{K as E,j as s,r as x,M,o as C,O as U,Q as K,T as a,I as k,V as Q,B as i,p as B,F as P,d as u,x as A,a as T,u as q}from"./index-D5Lu9gvQ.js";import{C as G}from"./Close-aDtmQvkI.js";import{T as V,b as z,c as l,a as W}from"./TableRow-BE0jwtZO.js";import{T as H}from"./TableHead-Cd43flBV.js";import{D as X}from"./DialogActions-hQt4FAcL.js";import{R as N}from"./Refresh-KqO9II_A.js";import{T as Y,a as _}from"./Tabs-DoXgWvWH.js";const O=E(s.jsx("path",{d:"M6 6h12v12H6z"}),"Stop"),Z=E(s.jsx("path",{d:"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5m0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"}),"Visibility");function ss({jobId:n,open:d,onClose:o,onCancel:p,onRetry:j}){var b,w,r;const[e,h]=x.useState(null),[f,m]=x.useState([]),[J,S]=x.useState(!0),{showToast:g}=M();x.useEffect(()=>{if(d&&n){v();const t=setInterval(()=>{(e==null?void 0:e.status)==="processing"&&v()},5e3);return()=>clearInterval(t)}},[d,n,e==null?void 0:e.status]);const v=async()=>{try{const[t,c]=await Promise.all([C.get(`/jobs/upload/${n}`),C.get(`/jobs/upload/${n}/chunks`)]);h(t.data),m(c.data.chunks||[])}catch(t){console.error("Error fetching job details:",t),g("Failed to load job details","error")}finally{S(!1)}};return d?s.jsxs(U,{open:d,onClose:o,maxWidth:"lg",fullWidth:!0,children:[s.jsxs(K,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsx(a,{variant:"h6",children:"Job Details"}),s.jsx(k,{onClick:o,size:"small",children:s.jsx(G,{})})]}),s.jsx(Q,{children:J?s.jsx(i,{sx:{display:"flex",justifyContent:"center",p:4},children:s.jsx(B,{})}):e?s.jsxs(i,{children:[s.jsxs(i,{sx:{mb:3},children:[s.jsx(a,{variant:"subtitle1",gutterBottom:!0,children:e.filename}),s.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[s.jsx(u,{label:e.status,color:e.status==="complete"?"success":e.status==="failed"?"error":"primary"}),e.supplier&&s.jsx(u,{label:e.supplier.name,variant:"outlined"})]}),e.progress&&s.jsxs(i,{sx:{mb:2},children:[s.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[s.jsx(a,{variant:"body2",children:"Progress"}),s.jsxs(a,{variant:"body2",children:[e.progress.percent.toFixed(1),"%"]})]}),s.jsx(A,{variant:"determinate",value:e.progress.percent}),s.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mt:1},children:[s.jsxs(a,{variant:"caption",children:[((b=e.progress.processed_rows)==null?void 0:b.toLocaleString())||0," / ",((w=e.progress.total_rows)==null?void 0:w.toLocaleString())||0," rows"]}),s.jsxs(a,{variant:"caption",color:"success.main",children:["✅ ",((r=e.progress.successful_rows)==null?void 0:r.toLocaleString())||0," successful"]}),e.progress.failed_rows>0&&s.jsxs(a,{variant:"caption",color:"error.main",children:["❌ ",e.progress.failed_rows," failed"]})]})]}),e.chunks&&s.jsxs(i,{sx:{mb:2},children:[s.jsx(a,{variant:"subtitle2",gutterBottom:!0,children:"Chunks"}),s.jsxs(i,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[s.jsx(u,{label:`Total: ${e.chunks.total}`,size:"small"}),s.jsx(u,{label:`Complete: ${e.chunks.complete}`,size:"small",color:"success"}),s.jsx(u,{label:`Processing: ${e.chunks.processing}`,size:"small",color:"primary"}),s.jsx(u,{label:`Pending: ${e.chunks.pending}`,size:"small"}),e.chunks.failed>0&&s.jsx(u,{label:`Failed: ${e.chunks.failed}`,size:"small",color:"error"})]})]}),e.error_summary&&e.error_summary.total_errors>0&&s.jsxs(P,{severity:"warning",sx:{mb:2},children:[s.jsxs(a,{variant:"subtitle2",children:["Errors: ",e.error_summary.total_errors]}),e.error_summary.by_type&&s.jsx(i,{sx:{mt:1},children:Object.entries(e.error_summary.by_type).map(([t,c])=>s.jsxs(a,{variant:"caption",display:"block",children:[t,": ",c]},t))})]})]}),f.length>0&&s.jsxs(i,{children:[s.jsx(a,{variant:"subtitle2",gutterBottom:!0,children:"Chunk Details"}),s.jsxs(V,{size:"small",children:[s.jsx(H,{children:s.jsxs(z,{children:[s.jsx(l,{children:"Chunk"}),s.jsx(l,{children:"Rows"}),s.jsx(l,{children:"Status"}),s.jsx(l,{children:"Success"}),s.jsx(l,{children:"Errors"})]})}),s.jsx(W,{children:f.slice(0,20).map(t=>s.jsxs(z,{children:[s.jsxs(l,{children:["#",t.chunk_index+1]}),s.jsxs(l,{children:[t.start_row,"-",t.end_row]}),s.jsx(l,{children:s.jsx(u,{label:t.status,size:"small"})}),s.jsx(l,{children:t.success_count||0}),s.jsx(l,{children:t.error_count||0})]},t.id))})]}),f.length>20&&s.jsxs(a,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:["Showing first 20 of ",f.length," chunks"]})]})]}):s.jsx(P,{severity:"error",children:"Job not found"})}),s.jsxs(X,{children:[(e==null?void 0:e.status)==="processing"&&s.jsx(T,{startIcon:s.jsx(O,{}),onClick:()=>{p(n),o()},color:"error",children:"Cancel Job"}),(e==null?void 0:e.status)==="failed"&&s.jsx(T,{startIcon:s.jsx(N,{}),onClick:()=>{j(n),o()},children:"Retry Failed"}),s.jsx(T,{onClick:o,children:"Close"})]})]}):null}function es(n){if(!n)return"—";const d=new Date(n),p=new Date-d,j=Math.floor(p/6e4),e=Math.floor(p/36e5),h=Math.floor(p/864e5);return j<1?"Just now":j<60?`${j}m ago`:e<24?`${e}h ago`:h<7?`${h}d ago`:d.toLocaleDateString()}function rs({status:n}){const d={pending:"default",mapping:"info",validating:"info",processing:"primary",complete:"success",failed:"error",cancelled:"warning"};return s.jsx(u,{label:n,color:d[n]||"default",size:"small"})}function ds(){const[n,d]=x.useState([]),[o,p]=x.useState("all"),[j,e]=x.useState(!0),[h,f]=x.useState(null),{showToast:m}=M(),J=q(),S=n.some(r=>["processing","pending","mapping","validating"].includes(r.status));x.useEffect(()=>{g()},[o]),x.useEffect(()=>{if(!S)return;const r=setInterval(g,5e3);return()=>clearInterval(r)},[S]);const g=async()=>{try{const r={};o!=="all"&&(o==="active"?r.status="processing":r.status=o);const t=await C.get("/jobs/upload",{params:r});d(t.data.jobs||[])}catch(r){console.error("Error fetching jobs:",r),m("Failed to load jobs","error")}finally{e(!1)}},v=async r=>{var t,c;if(confirm("Cancel this upload? Products already created will remain."))try{await C.post(`/jobs/upload/${r}/cancel`),m("Job cancelled","success"),g()}catch(y){m(((c=(t=y.response)==null?void 0:t.data)==null?void 0:c.detail)||"Failed to cancel job","error")}},b=async r=>{var t,c;try{await C.post(`/jobs/upload/${r}/retry`),m("Retrying failed chunks","success"),g()}catch(y){m(((c=(t=y.response)==null?void 0:t.data)==null?void 0:c.detail)||"Failed to retry job","error")}},w=o==="active"?n.filter(r=>["processing","pending","mapping","validating"].includes(r.status)):o==="all"?n:n.filter(r=>r.status===o);return s.jsxs(i,{sx:{p:3},children:[s.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[s.jsx(a,{variant:"h4",children:"Upload Jobs"}),s.jsx(T,{variant:"contained",onClick:()=>J("/products?upload=true"),children:"+ New Upload"})]}),s.jsxs(Y,{value:o,onChange:(r,t)=>p(t),sx:{mb:3},children:[s.jsx(_,{label:"All",value:"all"}),s.jsx(_,{label:"Active",value:"active"}),s.jsx(_,{label:"Complete",value:"complete"}),s.jsx(_,{label:"Failed",value:"failed"})]}),j?s.jsx(i,{sx:{display:"flex",justifyContent:"center",p:4},children:s.jsx(B,{})}):w.length===0?s.jsx(i,{sx:{textAlign:"center",p:4},children:s.jsx(a,{variant:"body1",color:"text.secondary",children:"No jobs found"})}):s.jsxs(V,{children:[s.jsx(H,{children:s.jsxs(z,{children:[s.jsx(l,{children:"File / Supplier"}),s.jsx(l,{children:"Status"}),s.jsx(l,{children:"Progress"}),s.jsx(l,{children:"Created"}),s.jsx(l,{children:"Actions"})]})}),s.jsx(W,{children:w.map(r=>{var c,y,D,R,F,$,I,L;const t=((c=r.progress)==null?void 0:c.percent)||0;return s.jsxs(z,{hover:!0,children:[s.jsxs(l,{children:[s.jsx(a,{variant:"body2",fontWeight:600,children:r.filename}),r.supplier&&s.jsx(a,{variant:"caption",color:"text.secondary",children:r.supplier.name})]}),s.jsx(l,{children:s.jsx(rs,{status:r.status})}),s.jsx(l,{children:r.status==="processing"?s.jsxs(i,{children:[s.jsx(A,{variant:"determinate",value:t,sx:{mb:.5}}),s.jsxs(a,{variant:"caption",color:"text.secondary",children:[((D=(y=r.progress)==null?void 0:y.processed_rows)==null?void 0:D.toLocaleString())||0," / ",((F=(R=r.progress)==null?void 0:R.total_rows)==null?void 0:F.toLocaleString())||0]})]}):r.status==="complete"?s.jsxs(a,{variant:"body2",color:"success.main",children:["✅ ",((I=($=r.progress)==null?void 0:$.successful_rows)==null?void 0:I.toLocaleString())||0," products"]}):r.status==="failed"?s.jsxs(a,{variant:"body2",color:"error.main",children:["❌ ",((L=r.progress)==null?void 0:L.failed_rows)||0," errors"]}):s.jsx(a,{variant:"body2",color:"text.secondary",children:"—"})}),s.jsx(l,{children:s.jsx(a,{variant:"caption",children:es(r.created_at)})}),s.jsx(l,{children:s.jsxs(i,{sx:{display:"flex",gap:.5},children:[r.status==="processing"&&s.jsx(k,{size:"small",onClick:()=>v(r.id),title:"Cancel",children:s.jsx(O,{fontSize:"small"})}),r.status==="failed"&&s.jsx(k,{size:"small",onClick:()=>b(r.id),title:"Retry Failed",children:s.jsx(N,{fontSize:"small"})}),s.jsx(k,{size:"small",onClick:()=>f(r.id),title:"View Details",children:s.jsx(Z,{fontSize:"small"})})]})})]},r.id)})})]}),h&&s.jsx(ss,{jobId:h,open:!!h,onClose:()=>f(null),onCancel:v,onRetry:b})]})}export{ds as default};

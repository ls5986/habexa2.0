import{v as Ee,w as Me,r,x as $e,_ as De,j as e,z as Be,y as Re,A as Ue,E as Ne,T as a,c as pe,a2 as Y,n as $,W as ee,X as se,I as X,Y as te,B as x,Q as K,k as w,a3 as ye,a4 as oe,a5 as ce,o as Q,M as ve,a6 as re,a7 as ae,a8 as ne,a9 as G,p as J,$ as We,aa as Le,D as qe,u as Oe,P as be,b as Ve,S as Je,Z as He,ab as Qe,C as ue,R as Ge,d as xe,L as Ke}from"./index-k5Kw9esk.js";import{C as Se}from"./Collapse-BjJNI2CE.js";import{D as le,P as he}from"./plus-DyeIM8kK.js";import{S as Xe}from"./SupplierFormModal-BYF1GpwQ.js";import{T as Ye,a as me}from"./Tabs-BXHcFz71.js";import{C as Ze}from"./clock-B6zaM-pb.js";import{S as es}from"./shopping-cart-MHWTrlK-.js";import{I as Ce,R as ss}from"./refresh-cw-BLfRxQGh.js";import{C as we}from"./Checkbox-C5OmVhOp.js";import{E as ts}from"./external-link-_GANzbDM.js";import"./SwitchBase-ClNa8SuG.js";function rs(o){return Ee("MuiAlertTitle",o)}Me("MuiAlertTitle",["root"]);const as=["className"],ns=o=>{const{classes:f}=o;return Ne({root:["root"]},rs,f)},ls=Be(a,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(o,f)=>f.root})(({theme:o})=>({fontWeight:o.typography.fontWeightMedium,marginTop:-2})),Z=r.forwardRef(function(f,h){const A=$e({props:f,name:"MuiAlertTitle"}),{className:l}=A,m=De(A,as),b=A,c=ns(b);return e.jsx(ls,Re({gutterBottom:!0,component:"div",ownerState:b,ref:h,className:Ue(c.root,l)},m))});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=pe("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=pe("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=pe("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),_e=Y(e.jsx("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),de=Y(e.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),Ae=Y(e.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),ke=Y(e.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),ds=Y(e.jsx("path",{d:"M8 5v14l11-7z"}),"PlayArrow"),ge=Y(e.jsx("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"}),"Upload");function ps({open:o,onClose:f,onComplete:h}){var B,V,P,s,n,g;const[A,l]=r.useState([]),[m,b]=r.useState(""),[c,y]=r.useState(""),[p,d]=r.useState(!1),[k,j]=r.useState(!1),[S,D]=r.useState(null),[U,z]=r.useState(null),[t,T]=r.useState(null),[N,R]=r.useState(!1),[O,I]=r.useState(null),[_,H]=r.useState(!1);r.useEffect(()=>{o&&(E(),W())},[o]),r.useEffect(()=>{if(!U)return;const i=setInterval(async()=>{try{const u=await $.get(`/jobs/${U}`);T(u.data),(u.data.status==="completed"||u.data.status==="failed")&&(clearInterval(i),R(!1),u.data.status==="completed"&&h&&setTimeout(()=>{h(u.data.result)},500))}catch(u){console.error("Error polling job:",u),clearInterval(i),R(!1)}},2e3);return()=>clearInterval(i)},[U,h]);const E=async()=>{try{const i=await $.get("/suppliers");l(i.data.suppliers||i.data||[])}catch(i){console.error("Error fetching suppliers:",i)}},W=()=>{b(""),y(""),d(!1),D(null),z(null),T(null),R(!1),I(null),H(!1)},C=async()=>{var i,u;if(c.trim()){j(!0);try{const q=(await $.post("/suppliers",{name:c.trim()})).data;l([...A,q]),b(q.id),d(!1),y("")}catch(F){I(((u=(i=F.response)==null?void 0:i.data)==null?void 0:u.detail)||"Failed to create supplier")}finally{j(!1)}}},M=i=>{var q;const u=(q=i.target.files)==null?void 0:q[0];if(!u)return;const F=u.name.toLowerCase().slice(u.name.lastIndexOf("."));if(![".csv",".xlsx",".xls"].includes(F)){I("Please upload a .csv or .xlsx file");return}D(u),I(null)},v=async()=>{var i,u;if(!S||!m){I("Please select a supplier and file");return}R(!0),I(null);try{const F=new FormData;F.append("file",S),F.append("supplier_id",m);const q=await $.post("/products/upload",F,{headers:{"Content-Type":"multipart/form-data"}});z(q.data.job_id)}catch(F){I(((u=(i=F.response)==null?void 0:i.data)==null?void 0:u.detail)||"Upload failed"),R(!1)}},L=((B=A.find(i=>i.id===m))==null?void 0:B.name)||"";return e.jsxs(ee,{open:o,onClose:f,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(se,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:["Upload Price List",e.jsx(X,{onClick:f,size:"small",children:e.jsx(de,{fontSize:"small"})})]}),e.jsxs(te,{children:[(t==null?void 0:t.status)==="completed"&&e.jsx(x,{children:e.jsxs(K,{severity:"success",sx:{mb:2},children:[e.jsx(Z,{children:"Upload Complete"}),e.jsxs(a,{variant:"body2",sx:{mt:1},children:["Supplier: ",e.jsx("strong",{children:(V=t.result)==null?void 0:V.supplier_name})]}),e.jsxs(a,{variant:"body2",children:["Products created: ",e.jsx("strong",{children:((P=t.result)==null?void 0:P.products_created)||0})]}),e.jsxs(a,{variant:"body2",children:["Deals processed: ",e.jsx("strong",{children:((s=t.result)==null?void 0:s.deals_processed)||0})]}),((g=(n=t.result)==null?void 0:n.errors)==null?void 0:g.length)>0&&e.jsxs(x,{sx:{mt:2},children:[e.jsxs(w,{size:"small",onClick:()=>H(!_),endIcon:_?e.jsx(Ae,{}):e.jsx(ke,{}),children:[t.result.errors.length," errors"]}),e.jsx(Se,{in:_,children:e.jsx(ye,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:t.result.errors.map((i,u)=>e.jsx(oe,{children:e.jsx(ce,{primary:i,primaryTypographyProps:{variant:"caption"}})},u))})})]})]})}),(t==null?void 0:t.status)==="failed"&&e.jsxs(K,{severity:"error",sx:{mb:2},children:[e.jsx(Z,{children:"Upload Failed"}),e.jsx(a,{variant:"body2",children:t.error})]}),((t==null?void 0:t.status)==="processing"||(t==null?void 0:t.status)==="pending"||(t==null?void 0:t.status)==="parsing")&&e.jsxs(x,{sx:{mb:2},children:[e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(Q,{size:20}),e.jsx(a,{variant:"body1",children:t.status==="parsing"?"Parsing file...":`Processing for ${L}...`})]}),e.jsx(ve,{variant:"determinate",value:t.progress||0,sx:{mb:1,height:8,borderRadius:1}}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:[t.processed_items||0," / ",t.total_items||"?"," rows"]})]}),!t&&e.jsxs(e.Fragment,{children:[e.jsxs(x,{sx:{mb:3},children:[e.jsxs(re,{fullWidth:!0,sx:{mb:2},children:[e.jsx(ae,{children:"Supplier *"}),e.jsxs(ne,{value:m,label:"Supplier *",onChange:i=>b(i.target.value),children:[e.jsx(G,{value:"",children:"Select supplier..."}),A.map(i=>e.jsx(G,{value:i.id,children:i.name},i.id))]})]}),p?e.jsxs(x,{sx:{display:"flex",gap:1},children:[e.jsx(J,{fullWidth:!0,size:"small",label:"New supplier name",value:c,onChange:i=>y(i.target.value),onKeyDown:i=>i.key==="Enter"&&C(),autoFocus:!0}),e.jsx(w,{variant:"contained",size:"small",onClick:C,disabled:k||!c.trim(),children:k?e.jsx(Q,{size:16}):"Add"}),e.jsx(X,{size:"small",onClick:()=>{d(!1),y("")},children:e.jsx(de,{fontSize:"small"})})]}):e.jsx(w,{variant:"outlined",size:"small",startIcon:e.jsx(_e,{}),onClick:()=>d(!0),fullWidth:!0,children:"Add New Supplier"})]}),e.jsxs(x,{sx:{mb:2},children:[e.jsx("input",{type:"file",id:"file-upload",hidden:!0,accept:".csv,.xlsx,.xls",onChange:M}),e.jsx("label",{htmlFor:"file-upload",children:e.jsx(x,{sx:{border:"2px dashed",borderColor:S?"primary.main":"divider",borderRadius:2,p:4,textAlign:"center",cursor:"pointer",bgcolor:S?"primary.50":"background.paper","&:hover":{borderColor:"primary.main",bgcolor:"action.hover"}},children:S?e.jsxs(x,{children:[e.jsx(a,{variant:"body1",fontWeight:"600",children:S.name}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:[(S.size/1024).toFixed(1)," KB"]}),e.jsx(a,{variant:"caption",color:"primary",sx:{display:"block",mt:1},children:"Click to change"})]}):e.jsxs(x,{children:[e.jsx(ge,{sx:{fontSize:32,color:"text.secondary",mb:1}}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Drop CSV or Excel file here"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:".csv, .xlsx, .xls"})]})})})]}),O&&e.jsx(K,{severity:"error",sx:{mb:2},children:O}),e.jsx(a,{variant:"caption",color:"text.secondary",sx:{display:"block",textAlign:"center"},children:"All products in this file will be assigned to the selected supplier"})]})]}),e.jsx(le,{children:(t==null?void 0:t.status)==="completed"?e.jsxs(e.Fragment,{children:[e.jsx(w,{onClick:W,children:"Upload Another"}),e.jsx(w,{variant:"contained",onClick:f,children:"Done"})]}):(t==null?void 0:t.status)==="failed"?e.jsx(w,{onClick:W,children:"Try Again"}):e.jsxs(e.Fragment,{children:[e.jsx(w,{onClick:f,children:"Cancel"}),e.jsx(w,{variant:"contained",onClick:v,disabled:!S||!m||N,startIcon:N?null:e.jsx(ge,{}),children:N?e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Q,{size:16}),"Starting..."]}):`Upload to ${L||"Supplier"}`})]})})]})}function us({open:o,onClose:f,productsWithoutSuppliers:h=[],groupedByFile:A={},productCount:l=0,onConfirm:m}){const{suppliers:b,loading:c,refetch:y}=We(),{showToast:p}=Le(),[d,k]=r.useState(""),[j,S]=r.useState(!1),[D,U]=r.useState(!1);r.useEffect(()=>{o&&b.length>0&&!d&&k(b[0].id)},[o,b,d]);const z=async()=>{var t,T,N,R,O;if(!d){p("Please select a supplier","error");return}U(!0);try{const I=h.map(E=>(E==null?void 0:E.id)||(E==null?void 0:E.product_id)).filter(E=>E&&!E.toString().startsWith("placeholder-"));if(I.length===0){const W=(await $.post("/products/assign-supplier",{supplier_id:d,assign_all_pending:!0})).data.total||h.length;p(`Assigned supplier to ${W} products`,"success"),setTimeout(()=>{m(d),f()},1e3);return}const H=(await $.post("/products/assign-supplier",{product_ids:I,supplier_id:d})).data.total;p(`Assigned supplier to ${H} products`,"success"),setTimeout(()=>{m(d),f()},1e3)}catch(I){console.error("Failed to assign suppliers:",I);const _=((N=(T=(t=I.response)==null?void 0:t.data)==null?void 0:T.detail)==null?void 0:N.message)||((O=(R=I.response)==null?void 0:R.data)==null?void 0:O.detail)||"Failed to assign suppliers";p(_,"error")}finally{U(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(ee,{open:o,onClose:f,maxWidth:"sm",fullWidth:!0,children:[e.jsx(se,{children:e.jsx(a,{variant:"h6",fontWeight:600,children:"Select Supplier for Analysis"})}),e.jsxs(te,{children:[e.jsxs(K,{severity:"warning",sx:{mb:3},children:[e.jsxs(a,{variant:"body2",fontWeight:600,gutterBottom:!0,children:[l||h.length," product",(l||h.length)!==1?"s":""," ",(l||h.length)===1?"has":"have"," no supplier assigned."]}),e.jsx(a,{variant:"body2",children:"Analysis requires a supplier to track where products come from. Please select a supplier to assign to these products."})]}),e.jsx(x,{sx:{mb:2},children:e.jsxs(re,{fullWidth:!0,children:[e.jsx(ae,{children:"Supplier"}),e.jsx(ne,{value:d,onChange:t=>k(t.target.value),label:"Supplier",disabled:D||c,children:b.map(t=>e.jsx(G,{value:t.id,children:t.name},t.id))})]})}),e.jsx(x,{sx:{display:"flex",justifyContent:"center",mb:2},children:e.jsx(w,{startIcon:e.jsx(_e,{}),onClick:()=>S(!0),variant:"outlined",size:"small",children:"Create New Supplier"})}),e.jsx(qe,{sx:{my:2}}),Object.keys(A).length>0?e.jsxs(x,{sx:{mb:2},children:[e.jsx(a,{variant:"body2",fontWeight:600,gutterBottom:!0,children:"Products grouped by file:"}),Object.entries(A).map(([t,T])=>e.jsxs(x,{sx:{mb:1,p:1,bgcolor:"action.hover",borderRadius:1},children:[e.jsxs(a,{variant:"caption",fontWeight:600,display:"block",children:[t,": ",T.length," product",T.length!==1?"s":""]}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:[T.slice(0,5).map(N=>N.asin).join(", "),T.length>5&&` ... and ${T.length-5} more`]})]},t))]}):h.length>0&&e.jsxs(a,{variant:"caption",color:"text.secondary",children:["Products: ",h.slice(0,10).map(t=>t.asin).join(", "),h.length>10&&` ... and ${h.length-10} more`]})]}),e.jsxs(le,{children:[e.jsx(w,{onClick:f,disabled:D,children:"Cancel"}),e.jsx(w,{onClick:z,variant:"contained",disabled:!d||D,children:D?"Assigning...":`Assign to ${l||h.length} Product${(l||h.length)!==1?"s":""}`})]})]}),e.jsx(Xe,{open:j,onClose:async()=>{S(!1),y&&await y()},supplier:null})]})}function je({productIds:o=null,analyzeAllPending:f=!1,onComplete:h=null,buttonText:A="Analyze All",className:l=""}){const[m,b]=r.useState(null),[c,y]=r.useState(null),[p,d]=r.useState(!1),[k,j]=r.useState(!1),[S,D]=r.useState(!1),[U,z]=r.useState(!1),[t,T]=r.useState([]),[N,R]=r.useState({}),[O,I]=r.useState(0);r.useEffect(()=>{if(!m)return;const C=setInterval(async()=>{var M;try{const v=await $.get(`/jobs/${m}`);y(v.data),(v.data.status==="completed"||v.data.status==="failed"||v.data.status==="cancelled")&&(clearInterval(C),v.data.status==="completed"&&h&&h(v.data))}catch(v){console.error("Error polling job:",v),((M=v.response)==null?void 0:M.status)===404&&clearInterval(C)}},2e3);return()=>clearInterval(C)},[m,h]);const _=async()=>{var C,M,v,L,B,V;d(!0);try{const P={};o?P.product_ids=o:f&&(P.analyze_all_pending=!0);const s=await $.post("/batch/analyze",P);b(s.data.job_id),y({status:"pending",total_items:s.data.total,progress:0}),j(!0)}catch(P){console.error("Error starting batch:",P),console.error("Error response:",(C=P.response)==null?void 0:C.data),console.error("Error response detail:",(v=(M=P.response)==null?void 0:M.data)==null?void 0:v.detail);const s=(B=(L=P.response)==null?void 0:L.data)==null?void 0:B.detail;let n=s;if(typeof s=="string")try{n=JSON.parse(s)}catch{n={message:s}}if(console.log("Parsed error object:",n),n&&typeof n=="object"&&n.error==="products_missing_suppliers"){console.log("Products without suppliers:",n.products),console.log("Grouped by file:",n.grouped_by_file),console.log("Count:",n.count);const g=n.count||((V=n.products)==null?void 0:V.length)||0,i=n.products||[];I(g);let u=i;g>0&&i.length===0&&(u=Array(Math.min(g,100)).fill(null).map((F,q)=>({id:`placeholder-${q}`,asin:"...",title:"Product details loading..."}))),T(u),R(n.grouped_by_file||{}),z(!0)}else{const g=(n==null?void 0:n.message)||(s==null?void 0:s.message)||(typeof s=="string"?s:JSON.stringify(s))||"Failed to start analysis";console.error("Showing error alert:",g),alert(g)}}finally{d(!1)}},H=async C=>{z(!1),T([]),setTimeout(()=>{_()},2e3)},E=async()=>{var C,M;if(m)try{await $.post(`/jobs/${m}/cancel`),y(v=>({...v,status:"cancelled"})),setTimeout(()=>{j(!1),W()},1e3)}catch(v){console.error("Error cancelling:",v);const L=((M=(C=v.response)==null?void 0:C.data)==null?void 0:M.detail)||v.message||"Failed to cancel job";alert(`Failed to cancel: ${L}`)}},W=()=>{b(null),y(null),j(!1),D(!1)};if(k&&c){const C=c.status==="processing"||c.status==="pending",M=c.status==="completed",v=c.status==="failed",L=c.status==="cancelled",B=c.errors||[],V=C&&c.processed_items>0?Math.ceil((c.total_items-c.processed_items)/5):0;return e.jsxs(ee,{open:k,onClose:C?void 0:W,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(se,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(a,{variant:"h6",children:[C&&"Analyzing Products...",M&&"Analysis Complete",v&&"Analysis Failed",L&&"Analysis Cancelled"]}),!C&&e.jsx(X,{onClick:W,size:"small",children:e.jsx(de,{})})]}),e.jsxs(te,{children:[e.jsxs(x,{sx:{mb:2},children:[e.jsx(ve,{variant:"determinate",value:c.progress||0,sx:{mb:1,height:8,borderRadius:1},color:M?"success":v?"error":"primary"}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:[c.processed_items||0," / ",c.total_items||0," products"]})]}),e.jsxs(x,{sx:{mb:2},children:[c.success_count>0&&e.jsxs(a,{variant:"body2",color:"success.main",sx:{mb:.5},children:["✓ Success: ",c.success_count]}),c.error_count>0&&e.jsxs(a,{variant:"body2",color:"error.main",sx:{mb:.5},children:["✗ Errors: ",c.error_count]})]}),C&&V>0&&e.jsxs(a,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:2},children:["~",V," seconds remaining"]}),M&&e.jsxs(K,{severity:"success",sx:{mb:2},children:[e.jsx(Z,{children:"Analysis Complete"}),e.jsxs(a,{variant:"body2",children:["Successfully analyzed ",c.success_count," products",c.error_count>0&&", {job.error_count} errors"]})]}),v&&e.jsxs(K,{severity:"error",sx:{mb:2},children:[e.jsx(Z,{children:"Analysis Failed"}),e.jsx(a,{variant:"body2",children:B[0]||"Unknown error"})]}),B.length>0&&e.jsxs(x,{sx:{mt:2},children:[e.jsxs(w,{size:"small",onClick:()=>D(!S),endIcon:S?e.jsx(Ae,{}):e.jsx(ke,{}),children:["View ",B.length," ",B.length===1?"error":"errors"]}),e.jsx(Se,{in:S,children:e.jsxs(ye,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:[B.slice(0,20).map((P,s)=>e.jsx(oe,{children:e.jsx(ce,{primary:P,primaryTypographyProps:{variant:"caption"}})},s)),B.length>20&&e.jsx(oe,{children:e.jsx(ce,{primary:`... and ${B.length-20} more errors`,primaryTypographyProps:{variant:"caption",color:"text.secondary"}})})]})})]})]}),e.jsxs(le,{children:[C&&e.jsx(w,{onClick:E,color:"error",children:"Cancel"}),!C&&e.jsx(w,{onClick:W,variant:"contained",children:M?"Done":"Close"})]})]})}return e.jsxs(e.Fragment,{children:[e.jsx(w,{variant:"contained",onClick:_,disabled:p,startIcon:p?e.jsx(Q,{size:16}):e.jsx(ds,{}),className:l,children:p?"Starting...":A}),e.jsx(us,{open:U,onClose:()=>{z(!1),T([]),R({})},productsWithoutSuppliers:t,groupedByFile:N,productCount:O,onConfirm:H})]})}const xs=[{id:"new",label:"New",icon:be,color:"#7C3AED"},{id:"analyzing",label:"Analyzing",icon:Ze,color:"#F59E0B"},{id:"reviewed",label:"Reviewed",icon:Ve,color:"#3B82F6"},{id:"buy_list",label:"Buy List",icon:es,color:"#10B981"},{id:"ordered",label:"Ordered",icon:is,color:"#6B7280"}];function fe(o,f){const[h,A]=r.useState(o);return r.useEffect(()=>{const l=setTimeout(()=>{A(o)},f);return()=>{clearTimeout(l)}},[o,f]),h}const ze=Ge.memo(({deal:o,selected:f,onSelect:h,onClick:A,onUpdateMoq:l})=>{const m=o.roi||0,b=o.profit||0,c=o.moq||1,y=o.buy_cost||0,p=o.total_investment||c*y,d=c*b,[k,j]=r.useState(!1),[S,D]=r.useState(c),U=()=>{l(o.deal_id,S),j(!1)};return e.jsxs(x,{sx:{display:"grid",gridTemplateColumns:"40px 110px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",alignItems:"center","&:hover":{bgcolor:"action.hover"},cursor:"pointer"},onClick:A,children:[e.jsx(we,{size:"small",checked:f,onClick:z=>z.stopPropagation(),onChange:h}),e.jsx(a,{variant:"body2",fontFamily:"monospace",fontSize:12,children:o.asin}),e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1,minWidth:0},children:[o.image_url?e.jsx(x,{component:"img",src:o.image_url,sx:{width:32,height:32,borderRadius:1,objectFit:"cover",flexShrink:0}}):e.jsx(x,{sx:{width:32,height:32,bgcolor:"#252540",borderRadius:1}}),e.jsx(a,{variant:"body2",noWrap:!0,sx:{minWidth:0},children:o.title||"Pending analysis..."})]}),e.jsx(a,{variant:"body2",color:"text.secondary",noWrap:!0,children:o.supplier_name||"Unknown"}),e.jsx(x,{sx:{textAlign:"right"},onClick:z=>z.stopPropagation(),children:k?e.jsx(J,{size:"small",type:"number",value:S,onChange:z=>D(parseInt(z.target.value)||1),onBlur:U,onKeyDown:z=>z.key==="Enter"&&U(),autoFocus:!0,sx:{width:50},inputProps:{min:1,style:{textAlign:"right",padding:"4px"}}}):e.jsx(xe,{label:c,size:"small",onClick:()=>j(!0),sx:{minWidth:40,cursor:"pointer",bgcolor:"#2D2D4A","&:hover":{bgcolor:"#3D3D5A"}}})}),e.jsxs(a,{variant:"body2",align:"right",color:"text.secondary",children:["$",y.toFixed(2)]}),e.jsxs(a,{variant:"body2",align:"right",fontWeight:"600",color:p>500?"warning.main":"text.primary",children:["$",p.toFixed(2)]}),e.jsx(a,{variant:"body2",align:"right",fontWeight:"600",color:m>=30?"success.main":m>0?"warning.main":"error.main",children:m?`${m.toFixed(0)}%`:"-"}),e.jsx(Ke,{title:`Total: $${d.toFixed(2)}`,children:e.jsxs(a,{variant:"body2",align:"right",color:b>0?"success.main":"error.main",children:["$",b?b.toFixed(2):"-"]})}),e.jsx(xe,{label:o.stage||"new",size:"small",sx:{height:22,fontSize:11}}),e.jsx(X,{size:"small",component:"a",href:`https://amazon.com/dp/${o.asin}`,target:"_blank",onClick:z=>z.stopPropagation(),children:e.jsx(ts,{size:14})})]})});ze.displayName="DealRow";function As(){const o=Oe(),f=r.useRef(!1),[h,A]=r.useState([]),[l,m]=r.useState({stages:{},total:0}),[b,c]=r.useState(!0),[y,p]=r.useState(null),[d,k]=r.useState([]),[j,S]=r.useState({minRoi:"",minProfit:"",search:"",supplier:""}),[D,U]=r.useState([]),[z,t]=r.useState(!1),[T,N]=r.useState(!1),[R,O]=r.useState(!1),I=fe(j.search,500),_=r.useCallback(async()=>{if(!f.current){f.current=!0,c(!0);try{const s=new URLSearchParams;y&&s.append("stage",y),j.minRoi&&s.append("min_roi",j.minRoi),j.minProfit&&s.append("min_profit",j.minProfit),I&&s.append("search",I),j.supplier&&s.append("supplier_id",j.supplier),s.append("limit","100");const[n,g]=await Promise.all([$.get(`/products?${s}`),$.get("/products/stats")]);A(n.data.deals||n.data||[]),m(g.data||{stages:{},total:0})}catch(s){console.error("Failed to fetch:",s)}finally{c(!1),f.current=!1}}},[y,j.minRoi,j.minProfit,I,j.supplier]),H=r.useCallback(async()=>{try{const s=await $.get("/suppliers");U(s.data.suppliers||s.data||[])}catch(s){console.error("Failed to fetch suppliers:",s)}},[]);r.useEffect(()=>{_(),H()},[]);const E=fe(y,300);r.useEffect(()=>{E!==void 0&&_()},[E]);const W=s=>{s.target.checked?k(h.map(n=>n.deal_id)):k([])},C=s=>{k(n=>n.includes(s)?n.filter(g=>g!==s):[...n,s])},M=async()=>{var s,n;if(d.length){O(!0);try{const g=await $.post("/products/bulk-analyze",{deal_ids:d});alert(`Queued ${g.data.queued} products for analysis`),k([]),_()}catch(g){console.error("Bulk analyze failed:",g),alert("Bulk analyze failed: "+(((n=(s=g.response)==null?void 0:s.data)==null?void 0:n.detail)||g.message))}finally{O(!1)}}},v=async s=>{var n,g;if(d.length)try{await $.post("/products/bulk-stage",{deal_ids:d,stage:s}),k([]),_()}catch(i){console.error("Bulk move failed:",i),alert("Failed to move deals: "+(((g=(n=i.response)==null?void 0:n.data)==null?void 0:g.detail)||i.message))}},L=s=>{setTimeout(()=>{_()},2e3),console.log("Upload complete:",s)},B=async()=>{var s,n;try{const g=y?`?stage=${y}`:"",u=(await $.get(`/products/export${g}`)).data.rows||[];if(!u.length)return;const F=Object.keys(u[0]),q=[F.join(","),...u.map(Fe=>F.map(Te=>`"${Fe[Te]||""}"`).join(","))].join(`
`),Ie=new Blob([q],{type:"text/csv"}),Pe=URL.createObjectURL(Ie),ie=document.createElement("a");ie.href=Pe,ie.download=`deals-${y||"all"}-${Date.now()}.csv`,ie.click()}catch(g){console.error("Export failed:",g),alert("Export failed: "+(((n=(s=g.response)==null?void 0:s.data)==null?void 0:n.detail)||g.message))}},V=async(s,n)=>{var g,i;try{await $.patch(`/products/deal/${s}`,{moq:n}),A(u=>u.map(F=>F.deal_id===s?{...F,moq:n,total_investment:(F.buy_cost||0)*n}:F))}catch(u){console.error("Failed to update MOQ:",u),alert("Failed to update MOQ: "+(((i=(g=u.response)==null?void 0:g.data)==null?void 0:i.detail)||u.message))}},P=r.useMemo(()=>h,[h]);return e.jsxs(x,{sx:{p:3},children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(a,{variant:"h4",fontWeight:"700",children:"Products"}),e.jsxs(x,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(je,{analyzeAllPending:!0,buttonText:"Analyze All Pending",onComplete:()=>setTimeout(()=>_(),1e3)}),d.length>0&&e.jsx(je,{productIds:d,buttonText:`Analyze ${d.length} Selected`,onComplete:()=>{k([]),setTimeout(()=>_(),1e3)}}),e.jsx(w,{variant:"outlined",startIcon:e.jsx(cs,{size:16}),onClick:()=>N(!0),children:"Upload File"}),e.jsx(w,{variant:"contained",startIcon:e.jsx(he,{size:16}),onClick:()=>t(!0),children:"Add ASIN"})]})]}),e.jsx(x,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(Ye,{value:y||"all",onChange:(s,n)=>p(n==="all"?null:n),children:[e.jsx(me,{value:"all",label:`All (${l.total||0})`}),xs.map(s=>{var n;return e.jsx(me,{value:s.id,label:`${s.label} (${((n=l.stages)==null?void 0:n[s.id])||0})`,icon:e.jsx(s.icon,{size:14}),iconPosition:"start"},s.id)})]})}),e.jsxs(x,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(J,{size:"small",placeholder:"Search ASIN...",value:j.search,onChange:s=>S({...j,search:s.target.value}),InputProps:{startAdornment:e.jsx(Ce,{position:"start",children:e.jsx(Je,{size:16})})},sx:{width:200}}),e.jsx(J,{size:"small",placeholder:"Min ROI %",type:"number",value:j.minRoi,onChange:s=>S({...j,minRoi:s.target.value}),onBlur:()=>setTimeout(()=>_(),500),sx:{width:100}}),e.jsx(J,{size:"small",placeholder:"Min Profit $",type:"number",value:j.minProfit,onChange:s=>S({...j,minProfit:s.target.value}),onBlur:()=>setTimeout(()=>_(),500),sx:{width:100}}),e.jsxs(re,{size:"small",sx:{width:150},children:[e.jsx(ae,{children:"Supplier"}),e.jsxs(ne,{value:j.supplier,label:"Supplier",onChange:s=>{S({...j,supplier:s.target.value}),setTimeout(()=>_(),500)},children:[e.jsx(G,{value:"",children:"All"}),D.map(s=>e.jsx(G,{value:s.id,children:s.name},s.id))]})]}),e.jsx(x,{sx:{flex:1}}),d.length>0&&e.jsxs(x,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsxs(a,{variant:"body2",color:"text.secondary",children:[d.length," selected"]}),e.jsx(w,{size:"small",variant:"contained",startIcon:R?e.jsx(Q,{size:14}):e.jsx(He,{size:14}),onClick:M,disabled:R,children:"Analyze"}),e.jsx(w,{size:"small",variant:"outlined",onClick:()=>v("buy_list"),children:"Move to Buy List"}),e.jsx(w,{size:"small",variant:"outlined",color:"error",onClick:()=>k([]),children:e.jsx(Qe,{size:14})})]}),e.jsx(X,{onClick:_,children:e.jsx(ss,{size:18})}),e.jsx(X,{onClick:B,children:e.jsx(os,{size:18})})]}),b?e.jsx(x,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(Q,{})}):P.length===0?e.jsxs(ue,{sx:{p:4,textAlign:"center"},children:[e.jsx(be,{size:48,color:"#666"}),e.jsx(a,{variant:"h6",sx:{mt:2},children:"No deals found"}),e.jsx(a,{color:"text.secondary",sx:{mb:2},children:"Upload a CSV or Excel file or add ASINs manually to get started"}),e.jsx(w,{variant:"contained",startIcon:e.jsx(he,{size:16}),onClick:()=>t(!0),children:"Add Your First ASIN"})]}):e.jsxs(ue,{children:[e.jsxs(x,{sx:{display:"grid",gridTemplateColumns:"40px 110px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.paper"},children:[e.jsx(we,{size:"small",checked:d.length===P.length&&P.length>0,indeterminate:d.length>0&&d.length<P.length,onChange:W}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"ASIN"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Product"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Supplier"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"MOQ"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"Unit $"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"Total $"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"ROI"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"Profit"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Stage"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Actions"})]}),P.map(s=>e.jsx(ze,{deal:s,selected:d.includes(s.deal_id),onSelect:()=>C(s.deal_id),onClick:()=>o(`/deals/${s.deal_id}`),onUpdateMoq:V},s.deal_id))]}),e.jsx(hs,{open:z,onClose:()=>t(!1),onAdded:()=>{t(!1),_()},suppliers:D}),e.jsx(ps,{open:T,onClose:()=>N(!1),onComplete:L})]})}function hs({open:o,onClose:f,onAdded:h,suppliers:A}){const[l,m]=r.useState({asin:"",buy_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),[b,c]=r.useState(!1),y=async()=>{var p,d;if(l.asin){c(!0);try{await $.post("/products",{asin:l.asin,buy_cost:l.buy_cost?parseFloat(l.buy_cost):null,supplier_id:l.supplier_id||null,supplier_name:l.supplier_name||null,moq:parseInt(l.moq)||1,notes:l.notes}),m({asin:"",buy_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),h()}catch(k){alert(((d=(p=k.response)==null?void 0:p.data)==null?void 0:d.detail)||"Failed to add product")}finally{c(!1)}}};return e.jsxs(ee,{open:o,onClose:f,maxWidth:"sm",fullWidth:!0,children:[e.jsx(se,{children:"Add Product"}),e.jsx(te,{children:e.jsxs(x,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(J,{label:"ASIN",value:l.asin,onChange:p=>m({...l,asin:p.target.value.toUpperCase()}),placeholder:"B08VBVBS7N",required:!0}),e.jsx(J,{label:"Buy Cost",type:"number",value:l.buy_cost,onChange:p=>m({...l,buy_cost:p.target.value}),InputProps:{startAdornment:e.jsx(Ce,{position:"start",children:"$"})}}),e.jsxs(re,{children:[e.jsx(ae,{children:"Supplier"}),e.jsxs(ne,{value:l.supplier_id,label:"Supplier",onChange:p=>m({...l,supplier_id:p.target.value,supplier_name:""}),children:[e.jsx(G,{value:"",children:"Select existing..."}),A.map(p=>e.jsx(G,{value:p.id,children:p.name},p.id))]})]}),e.jsx(J,{label:"Or New Supplier Name",value:l.supplier_name,onChange:p=>m({...l,supplier_name:p.target.value,supplier_id:""}),placeholder:"Enter new supplier name"}),e.jsx(J,{label:"MOQ",type:"number",value:l.moq,onChange:p=>m({...l,moq:p.target.value})}),e.jsx(J,{label:"Notes",multiline:!0,rows:2,value:l.notes,onChange:p=>m({...l,notes:p.target.value})})]})}),e.jsxs(le,{children:[e.jsx(w,{onClick:f,children:"Cancel"}),e.jsx(w,{variant:"contained",onClick:y,disabled:b||!l.asin,children:b?e.jsx(Q,{size:20}):"Add Product"})]})]})}export{As as default};

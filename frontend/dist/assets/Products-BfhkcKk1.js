import{_ as bs,$ as Ss,r as o,a0 as _s,a1 as Cs,a2 as qe,j as e,a3 as ls,E as ws,a4 as ks,c as Xe,K as Fe,B as c,T as s,C as he,b as We,d as de,F as oe,x as cs,h as ee,A as ds,o as O,O as me,Q as ge,I as Se,V as pe,a as C,a5 as ps,a6 as Ge,a7 as Qe,p as ue,a8 as be,a9 as Ce,aa as we,ab as Y,q as re,W as As,M as Ne,D as Ps,k as us,s as Ve,u as zs,P as xs,e as Is,y as Fs,t as Ns,ac as Oe,ad as Ie,Z as $s,ae as Ts,w as ze,R as Us}from"./index-CWAbI_84.js";import{S as Ms,a as Rs,b as Es,c as De,d as Be}from"./Stepper-C55H4-wY.js";import{C as Je}from"./Collapse-CVKMQePr.js";import{G as q}from"./Grid-DTR2KApN.js";import{T as Ws,a as Ds,b as es,c as ae}from"./TableRow-C7FEYZNH.js";import{C as Ze}from"./clock-DUSUxA-O.js";import{C as Bs}from"./check-circle-BmT67hmn.js";import{C as Ye}from"./Close-DRCdT96E.js";import{A as He}from"./AlertTitle-B1JAP1vF.js";import{D as je}from"./DialogActions-CSIKrx3Z.js";import{S as Ls}from"./SupplierFormModal-D9Ksu5xp.js";import{h as ss,R as qs,a as ts}from"./errorHandler-BhGbC50L.js";import{P as rs}from"./plus-BJNftltY.js";import{T as Os,a as ns}from"./Tabs-CLK7YeYR.js";import{R as Vs}from"./refresh-cw-BTS2mDLZ.js";import{T as hs}from"./trash-2-BTpuFs4Y.js";import{E as Hs}from"./external-link-CQb_kU7C.js";function Js(i){return bs("MuiStepContent",i)}Ss("MuiStepContent",["root","last","transition"]);const Ks=["children","className","TransitionComponent","transitionDuration","TransitionProps"],Gs=i=>{const{classes:u,last:l}=i;return ks({root:["root",l&&"last"],transition:["transition"]},Js,u)},Qs=ls("div",{name:"MuiStepContent",slot:"Root",overridesResolver:(i,u)=>{const{ownerState:l}=i;return[u.root,l.last&&u.last]}})(({ownerState:i,theme:u})=>qe({marginLeft:12,paddingLeft:20,paddingRight:8,borderLeft:u.vars?`1px solid ${u.vars.palette.StepContent.border}`:`1px solid ${u.palette.mode==="light"?u.palette.grey[400]:u.palette.grey[600]}`},i.last&&{borderLeft:"none"})),Zs=ls(Je,{name:"MuiStepContent",slot:"Transition",overridesResolver:(i,u)=>u.transition})({}),Le=o.forwardRef(function(u,l){const g=_s({props:u,name:"MuiStepContent"}),{children:n,className:p,TransitionComponent:P=Je,transitionDuration:I="auto",TransitionProps:S}=g,L=Cs(g,Ks),{orientation:r}=o.useContext(Ms),{active:h,last:d,expanded:f}=o.useContext(Rs),F=qe({},g,{last:d}),B=Gs(F);let w=I;return I==="auto"&&!P.muiSupportAuto&&(w=void 0),e.jsx(Qs,qe({className:ws(B.root,p),ref:l,ownerState:F},L,{children:e.jsx(Zs,qe({as:P,in:h||f,className:B.transition,ownerState:F,timeout:w,unmountOnExit:!0},S,{children:n}))}))});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ys=Xe("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xs=Xe("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=Xe("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),ms=Fe(e.jsx("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),gs=Fe(e.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),js=Fe(e.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),st=Fe(e.jsx("path",{d:"M8 5v14l11-7z"}),"PlayArrow"),as=Fe(e.jsx("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"}),"Upload");function tt({job:i,parsedData:u,conversionData:l,pricingData:g,keepaData:n}){var I,S,L;const p=r=>{var d;if(!i)return"pending";if(i.status==="completed")return"completed";if(i.status==="failed")return"error";const h=((d=i.metadata)==null?void 0:d.current_stage)||i.stage||"parse";return r==="parse"?h==="parse"?"active":"completed":r==="convert"?h==="parse"?"pending":h==="convert"?"active":"completed":r==="pricing"?["parse","convert"].includes(h)?"pending":h==="pricing"||h==="analyzing"?"active":"completed":r==="keepa"?["parse","convert","pricing","analyzing"].includes(h)?"pending":h==="keepa"?"active":"completed":"pending"},P=r=>{switch(r){case"completed":return e.jsx(Bs,{size:20,color:ee.success.main});case"active":return e.jsx(Ze,{size:20,color:ee.warning.main});case"error":return e.jsx(ds,{size:20,color:ee.error.main});default:return e.jsx(Ze,{size:20,color:ee.gray[400]})}};return e.jsxs(c,{sx:{mt:2},children:[e.jsxs(Es,{orientation:"vertical",children:[e.jsxs(De,{active:p("parse")==="active",completed:p("parse")==="completed",children:[e.jsx(Be,{StepIconComponent:()=>P(p("parse")),error:p("parse")==="error",children:e.jsx(s,{variant:"subtitle1",fontWeight:600,children:"Stage 0: Parse Excel"})}),e.jsx(Le,{children:u?e.jsx(he,{variant:"outlined",sx:{mt:1,bgcolor:"background.paper"},children:e.jsxs(We,{children:[e.jsxs(q,{container:!0,spacing:2,children:[e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Total Rows"}),e.jsx(s,{variant:"h6",children:u.total_rows||0})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Valid UPCs"}),e.jsx(s,{variant:"h6",children:u.valid_upcs||0})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Products with Promo"}),e.jsx(s,{variant:"h6",children:u.products_with_promo||0})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Format Detected"}),e.jsx(de,{label:u.format||"Standard",size:"small"})]}),u.pack_distribution&&e.jsxs(q,{item:!0,xs:12,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Pack Sizes"}),e.jsx(s,{variant:"body2",children:u.pack_distribution})]})]}),u.preview&&u.preview.length>0&&e.jsxs(c,{sx:{mt:2},children:[e.jsxs(s,{variant:"caption",color:"text.secondary",sx:{mb:1,display:"block"},children:["Preview (First ",Math.min(5,u.preview.length)," rows):"]}),e.jsx(Ws,{size:"small",children:e.jsxs(Ds,{children:[e.jsxs(es,{children:[e.jsx(ae,{children:e.jsx("strong",{children:"UPC"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Brand"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Pack"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Buy Cost"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Promo"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Promo Qty"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Promo %"})})]}),u.preview.slice(0,5).map((r,h)=>{var d,f,F;return e.jsxs(es,{children:[e.jsx(ae,{children:(d=r.upc)==null?void 0:d.slice(0,12)}),e.jsx(ae,{children:(f=r.brand)==null?void 0:f.slice(0,15)}),e.jsx(ae,{children:r.pack_size}),e.jsxs(ae,{children:["$",((F=r.buy_cost)==null?void 0:F.toFixed(4))||"N/A"]}),e.jsx(ae,{children:r.has_promo?"✓":"—"}),e.jsx(ae,{children:r.promo_qty||"—"}),e.jsx(ae,{children:r.promo_percent?`${r.promo_percent}%`:"—"})]},h)})]})})]})]})}):e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Parsing file..."})})]}),e.jsxs(De,{active:p("convert")==="active",completed:p("convert")==="completed",children:[e.jsx(Be,{StepIconComponent:()=>P(p("convert")),error:p("convert")==="error",children:e.jsx(s,{variant:"subtitle1",fontWeight:600,children:"Stage 1: UPC → ASIN Conversion"})}),e.jsx(Le,{children:l?e.jsx(he,{variant:"outlined",sx:{mt:1,bgcolor:"background.paper"},children:e.jsxs(We,{children:[e.jsxs(q,{container:!0,spacing:2,children:[e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Total UPCs"}),e.jsx(s,{variant:"h6",children:l.total_upcs||0})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"ASINs Found"}),e.jsxs(s,{variant:"h6",color:"success.main",children:[l.asins_found||0," ✅"]})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Not Found"}),e.jsxs(s,{variant:"h6",color:"warning.main",children:[l.not_found||0," ⚠️"]})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Conversion Rate"}),e.jsxs(s,{variant:"h6",children:[((I=l.conversion_rate)==null?void 0:I.toFixed(1))||0,"%"]})]})]}),l.not_found>0&&e.jsxs(oe,{severity:"warning",sx:{mt:2},children:[l.not_found," products need manual ASIN entry"]})]})}):e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Converting UPCs to ASINs..."})})]}),e.jsxs(De,{active:p("pricing")==="active",completed:p("pricing")==="completed",children:[e.jsx(Be,{StepIconComponent:()=>P(p("pricing")),error:p("pricing")==="error",children:e.jsx(s,{variant:"subtitle1",fontWeight:600,children:"Stage 2: SP-API Pricing & Fees"})}),e.jsx(Le,{children:g?e.jsx(he,{variant:"outlined",sx:{mt:1,bgcolor:"background.paper"},children:e.jsx(We,{children:e.jsxs(q,{container:!0,spacing:2,children:[e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Products Analyzed"}),e.jsx(s,{variant:"h6",children:g.analyzed||0})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Profitable (ROI ≥ 30%)"}),e.jsxs(s,{variant:"h6",color:"success.main",children:[g.profitable||0," ✅"]})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Not Profitable"}),e.jsxs(s,{variant:"h6",color:"error.main",children:[g.not_profitable||0," ✗"]})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Average ROI"}),e.jsxs(s,{variant:"h6",children:[((S=g.avg_roi)==null?void 0:S.toFixed(1))||0,"%"]})]}),g.best_roi&&e.jsxs(q,{item:!0,xs:12,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Best ROI"}),e.jsxs(s,{variant:"body2",children:[(L=g.best_roi.value)==null?void 0:L.toFixed(1),"% (ASIN: ",g.best_roi.asin,")"]})]})]})})}):e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Fetching pricing and fees..."})})]}),e.jsxs(De,{active:p("keepa")==="active",completed:p("keepa")==="completed",children:[e.jsx(Be,{StepIconComponent:()=>P(p("keepa")),error:p("keepa")==="error",children:e.jsx(s,{variant:"subtitle1",fontWeight:600,children:"Stage 3: Keepa Deep Analysis"})}),e.jsx(Le,{children:n?e.jsx(he,{variant:"outlined",sx:{mt:1,bgcolor:"background.paper"},children:e.jsx(We,{children:e.jsxs(q,{container:!0,spacing:2,children:[e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Products Analyzed"}),e.jsx(s,{variant:"h6",children:n.analyzed||0})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Still Profitable at Worst"}),e.jsxs(s,{variant:"h6",color:"success.main",children:[n.still_profitable||0," ✅"]})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Risky"}),e.jsxs(s,{variant:"h6",color:"warning.main",children:[n.risky||0," ⚠️"]})]}),e.jsxs(q,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Amazon is Seller"}),e.jsxs(s,{variant:"h6",color:"warning.main",children:[n.amazon_seller||0," ⚠️"]})]})]})})}):e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Fetching Keepa data for profitable products..."})})]})]}),i&&i.progress!==void 0&&e.jsxs(c,{sx:{mt:3},children:[e.jsx(cs,{variant:"determinate",value:i.progress||0,sx:{height:8,borderRadius:1}}),e.jsxs(s,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:[i.processed_items||0," / ",i.total_items||"?"," items processed"]})]})]})}function rt({open:i,onClose:u,onComplete:l}){var _,R,A,se,j,T,Z,y,V,ce,fe,xe,ke,_e,$e,Te,Ue,Me,Ae,Re;const[g,n]=o.useState([]),[p,P]=o.useState(""),[I,S]=o.useState(""),[L,r]=o.useState(!1),[h,d]=o.useState(!1),[f,F]=o.useState(null),[B,w]=o.useState(null),[a,z]=o.useState(null),[M,G]=o.useState(!1),[H,N]=o.useState(null),[$,v]=o.useState(!1);o.useEffect(()=>{i&&(Q(),E())},[i]),o.useEffect(()=>{if(!i||!B||(a==null?void 0:a.status)==="completed"||(a==null?void 0:a.status)==="failed")return;const b=setInterval(async()=>{var W,D,te,Pe;try{const t=(await O.get(`/jobs/${B}`)).data;if(z(t),t.status==="completed"||t.status==="failed"){if(clearInterval(b),G(!1),t.status==="failed"){const x=((W=t.errors)==null?void 0:W[0])||t.error||"Upload failed. Please check the errors.";N(x)}t.status==="completed"&&l&&setTimeout(()=>{l(t.result)},500)}}catch(ye){if(console.error("Error polling job:",ye),((D=ye.response)==null?void 0:D.status)===404){clearInterval(b),G(!1),z(null),N("Job not found. The upload may have been cancelled or deleted.");return}clearInterval(b),G(!1),N(((Pe=(te=ye.response)==null?void 0:te.data)==null?void 0:Pe.detail)||"Failed to check job status. Please refresh the page.")}},3e3);return()=>clearInterval(b)},[i,B,a==null?void 0:a.status,l]);const Q=async()=>{try{const b=await O.get("/suppliers");n(b.data.suppliers||b.data||[])}catch(b){console.error("Error fetching suppliers:",b)}},E=()=>{P(""),S(""),r(!1),F(null),w(null),z(null),G(!1),N(null),v(!1)},le=async()=>{var b,W;if(I.trim()){d(!0);try{const te=(await O.post("/suppliers",{name:I.trim()})).data;n([...g,te]),P(te.id),r(!1),S("")}catch(D){N(((W=(b=D.response)==null?void 0:b.data)==null?void 0:W.detail)||"Failed to create supplier")}finally{d(!1)}}},ne=b=>{var te;const W=(te=b.target.files)==null?void 0:te[0];if(!W)return;const D=W.name.toLowerCase().slice(W.name.lastIndexOf("."));if(![".csv",".xlsx",".xls"].includes(D)){N("Please upload a .csv or .xlsx file");return}F(W),N(null)},ie=async()=>{var b,W;if(console.log("handleUpload called"),console.log("file:",f),console.log("selectedSupplier:",p),console.log("Button should be enabled:",!!f&&!!p),!f||!p){N("Please select a supplier and file");return}G(!0),N(null);try{const D=new FormData;D.append("file",f),D.append("supplier_id",p);const te=await O.post("/products/upload",D,{headers:{"Content-Type":"multipart/form-data"}});w(te.data.job_id)}catch(D){console.error("Upload error:",D);const te=((W=(b=D.response)==null?void 0:b.data)==null?void 0:W.detail)||D.message||"Upload failed. Please try again.";N(te),G(!1),w(null)}},J=((_=g.find(b=>b.id===p))==null?void 0:_.name)||"";return e.jsxs(me,{open:i,onClose:u,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ge,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:["Upload Price List",e.jsx(Se,{onClick:u,size:"small",children:e.jsx(Ye,{fontSize:"small"})})]}),e.jsxs(pe,{children:[(a==null?void 0:a.status)==="completed"&&e.jsx(c,{children:e.jsxs(oe,{severity:a.error_count>0&&a.success_count===0?"error":a.error_count>0?"warning":"success",sx:{mb:2},children:[e.jsx(He,{children:a.error_count>0&&a.success_count===0?"Upload Completed with Errors":a.error_count>0?"Upload Completed with Some Errors":"Upload Complete"}),e.jsxs(s,{variant:"body2",sx:{mt:1},children:["Supplier: ",e.jsx("strong",{children:((R=a.metadata)==null?void 0:R.supplier_name)||((A=a.result)==null?void 0:A.supplier_name)||"Unknown"})]}),e.jsxs(s,{variant:"body2",children:["Products created: ",e.jsx("strong",{children:((se=a.result)==null?void 0:se.products_created)||a.success_count||0})]}),e.jsxs(s,{variant:"body2",children:["Deals processed: ",e.jsx("strong",{children:((j=a.result)==null?void 0:j.deals_processed)||a.success_count||0})]}),(a.error_count>0||((T=a.errors)==null?void 0:T.length)>0||((y=(Z=a.result)==null?void 0:Z.errors)==null?void 0:y.length)>0)&&e.jsxs(c,{sx:{mt:2},children:[e.jsxs(s,{variant:"body2",color:"text.secondary",sx:{mb:1},children:[a.error_count||((V=a.errors)==null?void 0:V.length)||((fe=(ce=a.result)==null?void 0:ce.errors)==null?void 0:fe.length)," row(s) had errors"]}),e.jsxs(C,{size:"small",onClick:()=>v(!$),endIcon:$?e.jsx(gs,{}):e.jsx(js,{}),children:[$?"Hide":"Show"," Errors"]}),e.jsx(Je,{in:$,children:e.jsx(ps,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:(a.errors||((xe=a.result)==null?void 0:xe.errors)||[]).map((b,W)=>e.jsx(Ge,{children:e.jsx(Qe,{primary:b,primaryTypographyProps:{variant:"caption"}})},W))})})]})]})}),(a==null?void 0:a.status)==="failed"&&e.jsxs(oe,{severity:"error",sx:{mb:2},children:[e.jsx(He,{children:"Upload Failed"}),e.jsx(s,{variant:"body2",children:a.error})]}),((a==null?void 0:a.status)==="processing"||(a==null?void 0:a.status)==="pending"||(a==null?void 0:a.status)==="parsing"||(a==null?void 0:a.status)==="analyzing")&&e.jsxs(c,{sx:{mb:2},children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(ue,{size:20}),e.jsx(s,{variant:"body1",children:a.status==="parsing"?"Parsing file...":a.status==="analyzing"?"Analyzing products...":`Processing for ${J}...`})]}),e.jsx(tt,{job:a,parsedData:((ke=a.metadata)==null?void 0:ke.parsed_data)||((_e=a.result)==null?void 0:_e.parsed_data),conversionData:(($e=a.metadata)==null?void 0:$e.conversion_data)||((Te=a.result)==null?void 0:Te.conversion_data),pricingData:((Ue=a.metadata)==null?void 0:Ue.pricing_data)||((Me=a.result)==null?void 0:Me.pricing_data),keepaData:((Ae=a.metadata)==null?void 0:Ae.keepa_data)||((Re=a.result)==null?void 0:Re.keepa_data)})]}),!a&&e.jsxs(e.Fragment,{children:[e.jsxs(c,{sx:{mb:3},children:[e.jsxs(be,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Ce,{children:"Supplier *"}),e.jsxs(we,{value:p,label:"Supplier *",onChange:b=>{const W=b.target.value;console.log("Selected supplier ID:",W),P(W)},renderValue:b=>{if(!b)return e.jsx("em",{style:{color:"#999"},children:"Select supplier..."});const W=g.find(D=>D.id===b);return(W==null?void 0:W.name)||"Unknown"},sx:{width:"100%","& .MuiSelect-select":{overflow:"visible",textOverflow:"ellipsis",whiteSpace:"nowrap",paddingRight:"32px"}},MenuProps:{PaperProps:{sx:{maxHeight:300,"& .MuiMenuItem-root":{whiteSpace:"normal",wordBreak:"break-word"}}}},children:[e.jsx(Y,{value:"",children:"Select supplier..."}),g.map(b=>e.jsx(Y,{value:b.id,children:b.name},b.id))]})]}),L?e.jsxs(c,{sx:{display:"flex",gap:1},children:[e.jsx(re,{fullWidth:!0,size:"small",label:"New supplier name",value:I,onChange:b=>S(b.target.value),onKeyDown:b=>b.key==="Enter"&&le(),autoFocus:!0}),e.jsx(C,{variant:"contained",size:"small",onClick:le,disabled:h||!I.trim(),children:h?e.jsx(ue,{size:16}):"Add"}),e.jsx(Se,{size:"small",onClick:()=>{r(!1),S("")},children:e.jsx(Ye,{fontSize:"small"})})]}):e.jsx(C,{variant:"outlined",size:"small",startIcon:e.jsx(ms,{}),onClick:()=>r(!0),fullWidth:!0,children:"Add New Supplier"})]}),e.jsxs(c,{sx:{mb:2},children:[e.jsx("input",{type:"file",id:"file-upload",hidden:!0,accept:".csv,.xlsx,.xls",onChange:ne}),e.jsx("label",{htmlFor:"file-upload",children:e.jsx(c,{sx:{border:"2px dashed",borderColor:f?"primary.main":"divider",borderRadius:2,p:4,textAlign:"center",cursor:"pointer",bgcolor:f?"primary.50":"background.paper","&:hover":{borderColor:"primary.main",bgcolor:"action.hover"}},children:f?e.jsxs(c,{children:[e.jsx(s,{variant:"body1",fontWeight:"600",children:f.name}),e.jsxs(s,{variant:"caption",color:"text.secondary",children:[(f.size/1024).toFixed(1)," KB"]}),e.jsx(s,{variant:"caption",color:"primary",sx:{display:"block",mt:1},children:"Click to change"})]}):e.jsxs(c,{children:[e.jsx(as,{sx:{fontSize:32,color:"text.secondary",mb:1}}),e.jsx(s,{variant:"body2",color:"text.secondary",children:"Drop CSV or Excel file here"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:".csv, .xlsx, .xls"})]})})})]}),H&&e.jsx(oe,{severity:"error",sx:{mb:2},children:H}),e.jsx(s,{variant:"caption",color:"text.secondary",sx:{display:"block",textAlign:"center"},children:"All products in this file will be assigned to the selected supplier"})]})]}),e.jsx(je,{children:(a==null?void 0:a.status)==="completed"?e.jsxs(e.Fragment,{children:[e.jsx(C,{onClick:E,children:"Upload Another"}),e.jsx(C,{variant:"contained",onClick:u,children:"Done"})]}):(a==null?void 0:a.status)==="failed"?e.jsx(C,{onClick:E,children:"Try Again"}):e.jsxs(e.Fragment,{children:[e.jsx(C,{onClick:u,children:"Cancel"}),e.jsx(C,{variant:"contained",onClick:ie,disabled:!f||!p||M,startIcon:M?null:e.jsx(as,{}),sx:{"&:disabled":{opacity:.5}},children:M?e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ue,{size:16}),"Starting..."]}):`Upload to ${J||"Supplier"}`})]})})]})}function nt({open:i,onClose:u,productsWithoutSuppliers:l=[],groupedByFile:g={},productCount:n=0,onConfirm:p}){const{suppliers:P,loading:I,createSupplier:S,refreshSuppliers:L}=As(),{showToast:r}=Ne(),[h,d]=o.useState(""),[f,F]=o.useState(!1),[B,w]=o.useState(!1);o.useEffect(()=>{i&&P.length>0&&!h&&d(P[0].id)},[i,P,h]);const a=async()=>{var z,M,G,H,N;if(!h){r("Please select a supplier","error");return}w(!0);try{const $=l.map(E=>(E==null?void 0:E.id)||(E==null?void 0:E.product_id)).filter(E=>E&&!E.toString().startsWith("placeholder-"));if($.length===0){const le=(await O.post("/products/assign-supplier",{supplier_id:h,assign_all_pending:!0})).data.total||l.length;r(`Assigned supplier to ${le} products`,"success"),setTimeout(()=>{p(h),u()},1e3);return}const Q=(await O.post("/products/assign-supplier",{product_ids:$,supplier_id:h})).data.total;r(`Assigned supplier to ${Q} products`,"success"),setTimeout(()=>{p(h),u()},1e3)}catch($){console.error("Failed to assign suppliers:",$);const v=((G=(M=(z=$.response)==null?void 0:z.data)==null?void 0:M.detail)==null?void 0:G.message)||((N=(H=$.response)==null?void 0:H.data)==null?void 0:N.detail)||"Failed to assign suppliers";r(v,"error")}finally{w(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(me,{open:i,onClose:u,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ge,{children:e.jsx(s,{variant:"h6",fontWeight:600,children:"Select Supplier for Analysis"})}),e.jsxs(pe,{children:[e.jsxs(oe,{severity:"warning",sx:{mb:3},children:[e.jsxs(s,{variant:"body2",fontWeight:600,gutterBottom:!0,children:[n||l.length," product",(n||l.length)!==1?"s":""," ",(n||l.length)===1?"has":"have"," no supplier assigned."]}),e.jsx(s,{variant:"body2",children:"Analysis requires a supplier to track where products come from. Please select a supplier to assign to these products."})]}),e.jsx(c,{sx:{mb:2},children:e.jsxs(be,{fullWidth:!0,children:[e.jsx(Ce,{children:"Supplier"}),e.jsx(we,{value:h,onChange:z=>d(z.target.value),label:"Supplier",disabled:B||I,children:P.map(z=>e.jsx(Y,{value:z.id,children:z.name},z.id))})]})}),e.jsx(c,{sx:{display:"flex",justifyContent:"center",mb:2},children:e.jsx(C,{startIcon:e.jsx(ms,{}),onClick:()=>F(!0),variant:"outlined",size:"small",children:"Create New Supplier"})}),e.jsx(Ps,{sx:{my:2}}),Object.keys(g).length>0?e.jsxs(c,{sx:{mb:2},children:[e.jsx(s,{variant:"body2",fontWeight:600,gutterBottom:!0,children:"Products grouped by file:"}),Object.entries(g).map(([z,M])=>e.jsxs(c,{sx:{mb:1,p:1,bgcolor:"action.hover",borderRadius:1},children:[e.jsxs(s,{variant:"caption",fontWeight:600,display:"block",children:[z,": ",M.length," product",M.length!==1?"s":""]}),e.jsxs(s,{variant:"caption",color:"text.secondary",children:[M.slice(0,5).map(G=>G.asin).join(", "),M.length>5&&` ... and ${M.length-5} more`]})]},z))]}):l.length>0&&e.jsxs(s,{variant:"caption",color:"text.secondary",children:["Products: ",l.slice(0,10).map(z=>z.asin).join(", "),l.length>10&&` ... and ${l.length-10} more`]})]}),e.jsxs(je,{children:[e.jsx(C,{onClick:u,disabled:B,children:"Cancel"}),e.jsx(C,{onClick:a,variant:"contained",disabled:!h||B,children:B?"Assigning...":`Assign to ${n||l.length} Product${(n||l.length)!==1?"s":""}`})]})]}),e.jsx(Ls,{open:f,onClose:async()=>{F(!1),L&&await L()},supplier:null})]})}function is({productIds:i=null,analyzeAllPending:u=!1,onComplete:l=null,buttonText:g="Analyze All",className:n=""}){const{hasFeature:p,promptUpgrade:P}=us(),{showToast:I}=Ne(),[S,L]=o.useState(null),[r,h]=o.useState(null),[d,f]=o.useState(!1),[F,B]=o.useState(!1),[w,a]=o.useState(!1),[z,M]=o.useState(!1),[G,H]=o.useState([]),[N,$]=o.useState({}),[v,Q]=o.useState(0);o.useEffect(()=>{if(!S)return;const _=setInterval(async()=>{var R;try{const A=await O.get(`/jobs/${S}`);h(A.data),(A.data.status==="completed"||A.data.status==="failed"||A.data.status==="cancelled")&&(clearInterval(_),A.data.status==="completed"&&l&&l(A.data))}catch(A){console.error("Error polling job:",A),((R=A.response)==null?void 0:R.status)===404&&clearInterval(_)}},2e3);return()=>clearInterval(_)},[S,l]);const E=async()=>{var _,R,A,se,j,T;if(!p("bulk_analyze")){P("bulk_analyze");return}f(!0);try{const Z={};i?Z.product_ids=i:u&&(Z.analyze_all_pending=!0);const y=await O.post("/batch/analyze",Z);L(y.data.job_id),h({status:"pending",total_items:y.data.total,progress:0}),B(!0)}catch(Z){console.error("Error starting batch:",Z),console.error("Error response:",(_=Z.response)==null?void 0:_.data),console.error("Error response detail:",(A=(R=Z.response)==null?void 0:R.data)==null?void 0:A.detail);const y=(j=(se=Z.response)==null?void 0:se.data)==null?void 0:j.detail;let V=y;if(typeof y=="string")try{V=JSON.parse(y)}catch{V={message:y}}if(console.log("Parsed error object:",V),V&&typeof V=="object"&&V.error==="products_missing_suppliers"){console.log("Products without suppliers:",V.products),console.log("Grouped by file:",V.grouped_by_file),console.log("Count:",V.count);const ce=V.count||((T=V.products)==null?void 0:T.length)||0,fe=V.products||[];Q(ce);let xe=fe;ce>0&&fe.length===0&&(xe=Array(Math.min(ce,100)).fill(null).map((ke,_e)=>({id:`placeholder-${_e}`,asin:"...",title:"Product details loading..."}))),H(xe),$(V.grouped_by_file||{}),M(!0)}else{const ce=(V==null?void 0:V.message)||(y==null?void 0:y.message)||(typeof y=="string"?y:JSON.stringify(y))||"Failed to start analysis";console.error("Showing error toast:",ce),I(ce,"error")}}finally{f(!1)}},le=async _=>{M(!1),H([]),setTimeout(()=>{E()},2e3)},ne=async()=>{var _,R;if(S)try{await O.post(`/jobs/${S}/cancel`),h(A=>({...A,status:"cancelled"})),setTimeout(()=>{B(!1),ie()},1e3)}catch(A){console.error("Error cancelling:",A);const se=((R=(_=A.response)==null?void 0:_.data)==null?void 0:R.detail)||A.message||"Failed to cancel job";I(`Failed to cancel: ${se}`,"error")}},ie=()=>{L(null),h(null),B(!1),a(!1)};if(F&&r){const _=r.status==="processing"||r.status==="pending",R=r.status==="completed",A=r.status==="failed",se=r.status==="cancelled",j=r.errors||[],T=_&&r.processed_items>0?Math.ceil((r.total_items-r.processed_items)/5):0;return e.jsxs(me,{open:F,onClose:_?void 0:ie,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ge,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(s,{variant:"h6",children:[_&&"Analyzing Products...",R&&"Analysis Complete",A&&"Analysis Failed",se&&"Analysis Cancelled"]}),!_&&e.jsx(Se,{onClick:ie,size:"small",children:e.jsx(Ye,{})})]}),e.jsxs(pe,{children:[e.jsxs(c,{sx:{mb:2},children:[e.jsx(cs,{variant:"determinate",value:r.progress||0,sx:{mb:1,height:8,borderRadius:1},color:R?"success":A?"error":"primary"}),e.jsxs(s,{variant:"body2",color:"text.secondary",children:[r.processed_items||0," / ",r.total_items||0," products"]})]}),e.jsxs(c,{sx:{mb:2},children:[r.success_count>0&&e.jsxs(s,{variant:"body2",color:"success.main",sx:{mb:.5},children:["✓ Success: ",r.success_count]}),r.error_count>0&&e.jsxs(s,{variant:"body2",color:"error.main",sx:{mb:.5},children:["✗ Errors: ",r.error_count]})]}),_&&T>0&&e.jsxs(s,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:2},children:["~",T," seconds remaining"]}),R&&e.jsxs(oe,{severity:"success",sx:{mb:2},children:[e.jsx(He,{children:"Analysis Complete"}),e.jsxs(s,{variant:"body2",children:["Successfully analyzed ",r.success_count," products",r.error_count>0&&", {job.error_count} errors"]})]}),A&&e.jsxs(oe,{severity:"error",sx:{mb:2},children:[e.jsx(He,{children:"Analysis Failed"}),e.jsx(s,{variant:"body2",children:j[0]||"Unknown error"})]}),j.length>0&&e.jsxs(c,{sx:{mt:2},children:[e.jsxs(C,{size:"small",onClick:()=>a(!w),endIcon:w?e.jsx(gs,{}):e.jsx(js,{}),children:["View ",j.length," ",j.length===1?"error":"errors"]}),e.jsx(Je,{in:w,children:e.jsxs(ps,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:[j.slice(0,20).map((Z,y)=>e.jsx(Ge,{children:e.jsx(Qe,{primary:Z,primaryTypographyProps:{variant:"caption"}})},y)),j.length>20&&e.jsx(Ge,{children:e.jsx(Qe,{primary:`... and ${j.length-20} more errors`,primaryTypographyProps:{variant:"caption",color:"text.secondary"}})})]})})]})]}),e.jsxs(je,{children:[_&&e.jsx(C,{onClick:ne,color:"error",children:"Cancel"}),!_&&e.jsx(C,{onClick:ie,variant:"contained",children:R?"Done":"Close"})]})]})}const J=p("bulk_analyze");return e.jsxs(e.Fragment,{children:[e.jsx(C,{variant:"contained",onClick:E,disabled:d||!J,startIcon:d?e.jsx(ue,{size:16}):e.jsx(st,{}),className:n,title:J?"":"Bulk analysis requires Starter or higher",children:d?"Starting...":g}),e.jsx(nt,{open:z,onClose:()=>{M(!1),H([]),$({})},productsWithoutSuppliers:G,groupedByFile:N,productCount:v,onConfirm:le})]})}const at=({open:i,onClose:u,deal:l,analysis:g,onSave:n})=>{var f,F,B;const[p,P]=o.useState(""),[I,S]=o.useState(!1),{showToast:L}=Ne(),r=o.useMemo(()=>{var v,Q;if(!p||!l)return null;const w=parseFloat(p);if(isNaN(w)||w<=0)return null;const a=l.buy_cost||((Q=(v=l.product_sources)==null?void 0:v[0])==null?void 0:Q.buy_cost)||0,z=w*.15+4.5,M=.35*.5,H=a+M+.1,N=w-z-H,$=H>0?N/H*100:0;return{fees:z,profit:N,roi:$,landed:H}},[p,l]),h=async()=>{var w,a;if(!(!p||!(g!=null&&g.id))){S(!0);try{await O.patch(`/analysis/${g.id}/manual-price`,{sell_price:parseFloat(p)}),L("Manual price saved successfully","success"),n(),u(),P("")}catch(z){L(((a=(w=z.response)==null?void 0:w.data)==null?void 0:a.detail)||"Failed to save manual price","error")}finally{S(!1)}}},d=w=>({no_active_offers:"No active sellers on Amazon",no_response:"No response from Amazon API",gated:"Product is gated/restricted",invalid_asin:"ASIN may be invalid",unknown:"Unknown reason"})[w]||w||"Unknown";return e.jsxs(me,{open:i,onClose:u,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ge,{children:"Enter Manual Sell Price"}),e.jsxs(pe,{children:[e.jsx(oe,{severity:"warning",sx:{mb:2},children:"No pricing data available from Amazon. You can enter a manual sell price based on your research."}),e.jsx(s,{variant:"subtitle2",gutterBottom:!0,children:(l==null?void 0:l.title)||"Unknown Product"}),e.jsxs(s,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:["ASIN: ",l==null?void 0:l.asin," | Buy Cost: $",(l==null?void 0:l.buy_cost)||((F=(f=l==null?void 0:l.product_sources)==null?void 0:f[0])==null?void 0:F.buy_cost)||"0.00"]}),(g==null?void 0:g.pricing_status_reason)&&e.jsx(de,{label:`Reason: ${d(g.pricing_status_reason)}`,size:"small",color:"warning",sx:{mb:2}}),(g==null?void 0:g.fba_lowest_365d)&&e.jsxs(oe,{severity:"info",sx:{mb:2},children:["Keepa shows historical FBA low of $",(B=g.fba_lowest_365d)==null?void 0:B.toFixed(2),g.amazon_was_seller&&" (Amazon was a seller)"]}),e.jsx(re,{label:"Sell Price",type:"number",step:"0.01",value:p,onChange:w=>P(w.target.value),fullWidth:!0,InputProps:{startAdornment:e.jsx(Ve,{position:"start",children:"$"})},sx:{mt:2},autoFocus:!0}),r&&e.jsxs(c,{sx:{mt:2,p:2,bgcolor:"grey.100",borderRadius:1},children:[e.jsx(s,{variant:"subtitle2",gutterBottom:!0,children:"Estimated (fees are approximate):"}),e.jsxs(s,{variant:"body2",children:["Fees: ~$",r.fees.toFixed(2)]}),e.jsxs(s,{variant:"body2",children:["Landed Cost: $",r.landed.toFixed(2)]}),e.jsxs(s,{variant:"body2",children:["Profit: $",r.profit.toFixed(2)]}),e.jsxs(s,{variant:"body1",fontWeight:"bold",color:r.roi>=30?"success.main":r.roi>0?"warning.main":"error.main",sx:{mt:1},children:["ROI: ",r.roi.toFixed(1),"%"]})]}),e.jsx(s,{variant:"caption",color:"text.secondary",sx:{mt:2,display:"block"},children:"Note: Fees are estimated at ~15% referral + $4.50 FBA. Re-analyze when product has active offers for accurate fees."})]}),e.jsxs(je,{children:[e.jsx(C,{onClick:u,children:"Cancel"}),e.jsx(C,{onClick:h,variant:"contained",disabled:!p||I||isNaN(parseFloat(p))||parseFloat(p)<=0,children:I?e.jsx(ue,{size:20}):"Save Manual Price"})]})]})},it=[{id:"new",label:"New",icon:xs,color:ee.purple.main},{id:"analyzing",label:"Analyzing",icon:Ze,color:ee.warning.main},{id:"reviewed",label:"Reviewed",icon:Is,color:ee.info.main},{id:"buy_list",label:"Buy List",icon:Fs,color:ee.success.main},{id:"ordered",label:"Ordered",icon:Ys,color:ee.gray[400]}];function os(i,u){const[l,g]=o.useState(i);return o.useEffect(()=>{const n=setTimeout(()=>{g(i)},u);return()=>{clearTimeout(n)}},[i,u]),l}const fs=Us.memo(({deal:i,selected:u,onSelect:l,onClick:g,onUpdateMoq:n,onDelete:p,onSetAsin:P,onOpenManualPrice:I,onSelectAsin:S,onEnterAsin:L,analysis:r})=>{const h=i.roi||0,d=i.profit||0,f=i.moq||1,F=i.buy_cost||0,B=i.total_investment||f*F,w=f*d,a=i.asin_status||"found",z=a==="not_found"||!i.asin,M=a==="multiple_found",G=i.potential_asins||[],H=i.is_variation&&i.variation_count>1,N=r||{},$=N.pricing_status||"complete",v=N.needs_review||$==="no_pricing",[Q,E]=o.useState(!1),[le,ne]=o.useState(f),[ie,J]=o.useState(!1),[_,R]=o.useState(""),A=()=>{n(i.deal_id,le),E(!1)},se=()=>{_.length===10&&(P(i.product_id,_),J(!1),R(""))};return e.jsxs(c,{sx:{display:"grid",gridTemplateColumns:"40px 140px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",alignItems:"center","&:hover":{bgcolor:"action.hover"},cursor:"pointer"},onClick:g,children:[e.jsx(Ie,{size:"small",checked:u,onClick:j=>j.stopPropagation(),onChange:l}),e.jsx(c,{sx:{display:"flex",flexDirection:"column",gap:.5},children:M?e.jsxs(c,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[e.jsx(de,{label:`Choose ASIN (${G.length})`,color:"warning",size:"small",onClick:j=>{j.stopPropagation(),S&&S(i)},sx:{fontSize:10,height:20,cursor:"pointer","&:hover":{bgcolor:"warning.dark"}}}),i.upc&&e.jsxs(s,{variant:"caption",color:"text.secondary",fontSize:9,children:["UPC: ",i.upc]})]}):z?e.jsxs(e.Fragment,{children:[ie?e.jsxs(c,{sx:{display:"flex",gap:.5,alignItems:"center"},children:[e.jsx(re,{size:"small",placeholder:"Enter ASIN",value:_,onChange:j=>R(j.target.value.toUpperCase().slice(0,10)),onClick:j=>j.stopPropagation(),sx:{width:100,fontSize:11},inputProps:{style:{fontSize:11,fontFamily:"monospace"}}}),e.jsx(C,{size:"small",variant:"contained",onClick:j=>{j.stopPropagation(),se()},disabled:_.length!==10,sx:{minWidth:40,height:28,fontSize:10},children:"Save"})]}):e.jsx(c,{sx:{display:"flex",gap:.5,alignItems:"center"},children:e.jsx(de,{label:"Enter ASIN",color:"error",size:"small",onClick:j=>{j.stopPropagation(),L&&L(i)},sx:{fontSize:10,height:20,cursor:"pointer","&:hover":{bgcolor:"error.dark"}}})}),i.upc&&e.jsxs(s,{variant:"caption",color:"text.secondary",fontSize:10,children:["UPC: ",i.upc]})]}):e.jsxs(e.Fragment,{children:[e.jsx(s,{variant:"body2",fontFamily:"monospace",fontSize:12,children:i.asin}),H&&e.jsx(de,{label:`Variation (${i.variation_count})`,size:"small",variant:"outlined",sx:{fontSize:9,height:18,mt:.5}}),i.upc&&e.jsxs(s,{variant:"caption",color:"text.secondary",fontSize:9,children:["UPC: ",i.upc]})]})}),e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,minWidth:0},children:[i.image_url?e.jsx(c,{component:"img",src:i.image_url,sx:{width:32,height:32,borderRadius:1,objectFit:"cover",flexShrink:0}}):e.jsx(c,{sx:{width:32,height:32,bgcolor:ee.navy.light,borderRadius:1}}),e.jsx(s,{variant:"body2",noWrap:!0,sx:{minWidth:0},children:i.title||(i.roi===void 0&&i.profit===void 0?"Pending analysis...":"Unknown Product")})]}),e.jsx(s,{variant:"body2",color:"text.secondary",noWrap:!0,children:i.supplier_name||"Unknown"}),e.jsx(c,{sx:{textAlign:"right"},onClick:j=>j.stopPropagation(),children:Q?e.jsx(re,{size:"small",type:"number",value:le,onChange:j=>ne(parseInt(j.target.value)||1),onBlur:A,onKeyDown:j=>j.key==="Enter"&&A(),autoFocus:!0,sx:{width:50},inputProps:{min:1,style:{textAlign:"right",padding:"4px"}}}):e.jsx(de,{label:f,size:"small",onClick:()=>E(!0),sx:{minWidth:40,cursor:"pointer",bgcolor:ee.gray[300],"&:hover":{bgcolor:ee.navy.light}}})}),e.jsxs(c,{sx:{textAlign:"right"},children:[e.jsxs(s,{variant:"body2",color:"text.secondary",children:["$",(F||0).toFixed(2)]}),i.has_promo&&i.promo_percent&&e.jsx(de,{label:`${i.promo_percent}% OFF`,color:"success",size:"small",sx:{fontWeight:"bold",fontSize:9,height:18,mt:.5}})]}),e.jsxs(s,{variant:"body2",align:"right",fontWeight:"600",color:(B||0)>500?"warning.main":"text.primary",children:["$",(B||0).toFixed(2)]}),e.jsx(s,{variant:"body2",align:"right",fontWeight:"600",color:h>=30?"success.main":h>0?"warning.main":"error.main",children:h?`${h.toFixed(0)}%`:"-"}),e.jsx(ze,{title:`Total: $${(w||0).toFixed(2)}`,children:e.jsxs(s,{variant:"body2",align:"right",color:(d||0)>0?"success.main":"error.main",children:["$",d?d.toFixed(2):"-"]})}),e.jsxs(c,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[v&&e.jsx(ze,{title:`Reason: ${N.pricing_status_reason||"No pricing data"}`,children:e.jsx(de,{label:$==="manual"?"Manual":"No Pricing",color:$==="manual"?"info":"warning",size:"small",onClick:j=>{j.stopPropagation(),$==="no_pricing"&&I&&I(i,N)},sx:{height:18,fontSize:9,cursor:$==="no_pricing"?"pointer":"default","&:hover":$==="no_pricing"?{bgcolor:"warning.dark"}:{}}})}),e.jsx(de,{label:i.stage||"new",size:"small",sx:{height:22,fontSize:11}})]}),e.jsxs(c,{sx:{display:"flex",gap:.5,alignItems:"center"},onClick:j=>j.stopPropagation(),children:[e.jsx(ze,{title:"View on Amazon",children:e.jsx(Se,{size:"small",component:"a",href:`https://amazon.com/dp/${i.asin}`,target:"_blank",children:e.jsx(Hs,{size:14})})}),e.jsx(ze,{title:"Delete product",children:e.jsx(Se,{size:"small",onClick:j=>{j.stopPropagation(),p(i)},sx:{color:"error.main"},children:e.jsx(hs,{size:14})})})]})]})});fs.displayName="DealRow";function wt(){var te,Pe,ye;const i=zs(),u=o.useRef(!1),[l,g]=o.useState([]),[n,p]=o.useState({stages:{},total:0}),[P,I]=o.useState(!0),[S,L]=o.useState(null),[r,h]=o.useState([]),[d,f]=o.useState({minRoi:"",minProfit:"",search:"",supplier:"",asinStatus:"all",pricingStatus:"all"}),[F,B]=o.useState(!1),[w,a]=o.useState([]),[z,M]=o.useState(!1),[G,H]=o.useState(!1),[N,$]=o.useState(!1),[v,Q]=o.useState({open:!1,deal:null}),[E,le]=o.useState({open:!1,deal:null,analysis:null}),[ne,ie]=o.useState({open:!1,product:null}),[J,_]=o.useState({open:!1,product:null,asinInput:""}),[R,A]=o.useState({all:0,found:0,not_found:0,multiple_found:0,manual:0}),{hasFeature:se,promptUpgrade:j}=us(),{showToast:T}=Ne(),Z=os(d.search,500),y=o.useCallback(async(t=!1)=>{var x,m,U;if(!u.current){u.current=!0,I(!0);try{const k=new URLSearchParams;S&&k.append("stage",S),d.minRoi&&k.append("min_roi",d.minRoi),d.minProfit&&k.append("min_profit",d.minProfit),Z&&k.append("search",Z),d.supplier&&k.append("supplier_id",d.supplier),d.asinStatus&&d.asinStatus!=="all"&&k.append("asin_status",d.asinStatus),k.append("limit","100"),t&&k.append("_t",Date.now().toString());const[X,Ke]=await Promise.all([O.get(`/products?${k}`),O.get(`/products/stats${t?`?_t=${Date.now()}`:""}`)]);let K=[];Array.isArray(X.data)?K=X.data:Array.isArray((x=X.data)==null?void 0:x.deals)?K=X.data.deals:Array.isArray((m=X.data)==null?void 0:m.data)&&(K=X.data.data),g(K);const ve=Ke.data||{stages:{},total:0};p({...ve,stages:{...{new:0,analyzing:0,reviewed:0,top_products:0,buy_list:0,ordered:0},...ve.stages||{}},total:ve.total||0}),(U=X.data)!=null&&U.counts&&A(X.data.counts),console.log("Products loaded:",K.length,"items"),K.length>0&&(console.log("First product fields:",Object.keys(K[0])),console.log("First product sample:",{asin:K[0].asin,title:K[0].title,stage:K[0].stage,status:K[0].status,product_status:K[0].product_status,analysis_status:K[0].analysis_status,roi:K[0].roi,profit:K[0].profit,deal_score:K[0].deal_score})),console.log("Stats data:",ve),K.length===0&&ve.total===0&&console.warn("No products found - view might be empty or missing")}catch(k){console.error("Failed to fetch:",k),T("Failed to load products. Please try refreshing.","error")}finally{I(!1),u.current=!1}}},[S,d.minRoi,d.minProfit,Z,d.supplier,d.asinStatus,T]),V=o.useCallback(async()=>{var t,x;try{const m=await O.get("/suppliers");let U=[];Array.isArray(m.data)?U=m.data:Array.isArray((t=m.data)==null?void 0:t.suppliers)?U=m.data.suppliers:Array.isArray((x=m.data)==null?void 0:x.data)&&(U=m.data.data),a(U)}catch(m){console.error("Failed to fetch suppliers:",m)}},[]);o.useEffect(()=>{y(),V()},[]);const ce=os(S,300);o.useEffect(()=>{ce!==void 0&&y()},[ce]);const fe=t=>{if(t.target.checked){const x=Array.isArray(l)?l:[];h(x.map(m=>m.deal_id))}else h([])},xe=t=>{h(x=>x.includes(t)?x.filter(m=>m!==t):[...x,t])},ke=async()=>{if(r.length){$(!0);try{const t=await O.post("/products/bulk-analyze",{deal_ids:r});T(`Queued ${t.data.queued} products for analysis`,"success"),h([]),y()}catch(t){ss(t,T)}finally{$(!1)}}},_e=async t=>{if(r.length)try{await O.post("/products/bulk-stage",{deal_ids:r,stage:t}),h([]),y()}catch(x){ss(x,T)}},$e=t=>{y(!0),T(`Upload complete! ${(t==null?void 0:t.products_created)||0} products created.`,"success")},Te=async()=>{var t,x;if(!se("export_data")){j("export_data");return}try{const m=S?`?stage=${S}`:"",k=(await O.get(`/products/export${m}`)).data.rows||[];if(!k.length)return;const X=Object.keys(k[0]),Ke=[X.join(","),...k.map(ys=>X.map(vs=>`"${ys[vs]||""}"`).join(","))].join(`
`),K=new Blob([Ke],{type:"text/csv"}),ve=URL.createObjectURL(K),Ee=document.createElement("a");Ee.href=ve,Ee.download=`deals-${S||"all"}-${Date.now()}.csv`,Ee.click()}catch(m){console.error("Export failed:",m),T("Export failed: "+(((x=(t=m.response)==null?void 0:t.data)==null?void 0:x.detail)||m.message),"error")}},Ue=async(t,x)=>{var m,U;try{await O.patch(`/products/deal/${t}`,{moq:x}),g(k=>k.map(X=>X.deal_id===t?{...X,moq:x,total_investment:(X.buy_cost||0)*x}:X))}catch(k){console.error("Failed to update MOQ:",k),T("Failed to update MOQ: "+(((U=(m=k.response)==null?void 0:m.data)==null?void 0:U.detail)||k.message),"error")}},Me=async(t,x)=>{var m,U;try{await O.patch(`/products/${t}/asin`,{asin:x}),T("ASIN set successfully. Product is now ready for analysis.","success"),y(!0)}catch(k){console.error("Failed to set ASIN:",k),T("Failed to set ASIN: "+(((U=(m=k.response)==null?void 0:m.data)==null?void 0:U.detail)||k.message),"error")}},Ae=async(t,x)=>{var m,U;try{await O.post(`/products/${t}/select-asin`,{asin:x}),T("ASIN selected and queued for analysis","success"),ie({open:!1,product:null}),y(!0)}catch(k){console.error("Failed to select ASIN:",k),T("Failed to select ASIN: "+(((U=(m=k.response)==null?void 0:m.data)==null?void 0:U.detail)||k.message),"error")}},Re=async()=>{var t,x;if(!(!J.product||J.asinInput.length!==10))try{await O.patch(`/products/${J.product.product_id||J.product.id}/manual-asin`,{asin:J.asinInput.toUpperCase()}),T("ASIN set and queued for analysis","success"),_({open:!1,product:null,asinInput:""}),y(!0)}catch(m){console.error("Failed to set manual ASIN:",m),T("Failed to set ASIN: "+(((x=(t=m.response)==null?void 0:t.data)==null?void 0:x.detail)||m.message),"error")}},b=t=>{Q({open:!0,deal:t,deleting:!1})},W=async()=>{var t,x;if(v.deal){Q(m=>({...m,deleting:!0}));try{await O.delete(`/products/deal/${v.deal.deal_id}`),T(`Product "${v.deal.asin}" deleted successfully`,"success"),g(m=>m.filter(U=>U.deal_id!==v.deal.deal_id)),h(m=>m.filter(U=>U!==v.deal.deal_id)),setTimeout(()=>y(!0),500),Q({open:!1,deal:null,deleting:!1})}catch(m){console.error("Failed to delete product:",m);const U=((x=(t=m.response)==null?void 0:t.data)==null?void 0:x.detail)||m.message||"Failed to delete product";T(U,"error"),Q(k=>({...k,deleting:!1}))}}},D=o.useMemo(()=>{let t=l;return F&&(t=t.filter(x=>x.has_promo===!0)),d.pricingStatus&&d.pricingStatus!=="all"&&(t=t.filter(x=>{const m=x.analysis||{},U=m.pricing_status||"complete";return d.pricingStatus==="needs_review"?m.needs_review||U==="no_pricing":U===d.pricingStatus})),t},[l,F,d.pricingStatus]);return e.jsxs(c,{sx:{p:3},children:[e.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(s,{variant:"h4",fontWeight:"700",children:"Products"}),e.jsxs(c,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(is,{analyzeAllPending:!0,buttonText:"Analyze All Pending",onComplete:()=>setTimeout(()=>y(),1e3)}),r.length>0&&e.jsx(is,{productIds:r,buttonText:`Analyze ${r.length} Selected`,onComplete:()=>{h([]),setTimeout(()=>y(),1e3)}}),e.jsx(C,{variant:"outlined",startIcon:e.jsx(et,{size:16}),onClick:()=>H(!0),children:"Upload File"}),e.jsx(C,{variant:"contained",startIcon:e.jsx(rs,{size:16}),onClick:()=>M(!0),children:"Add ASIN"})]})]}),e.jsx(c,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(Os,{value:S||"all",onChange:(t,x)=>L(x==="all"?null:x),children:[e.jsx(ns,{value:"all",label:`All (${n.total||0})`}),it.map(t=>{var x;return e.jsx(ns,{value:t.id,label:`${t.label} (${((x=n.stages)==null?void 0:x[t.id])||0})`,icon:e.jsx(t.icon,{size:14}),iconPosition:"start"},t.id)})]})}),e.jsxs(c,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(re,{size:"small",placeholder:"Search ASIN...",value:d.search,onChange:t=>f({...d,search:t.target.value}),InputProps:{startAdornment:e.jsx(Ve,{position:"start",children:e.jsx(Ns,{size:16})})},sx:{width:200}}),e.jsx(re,{size:"small",placeholder:"Min ROI %",type:"number",value:d.minRoi,onChange:t=>f({...d,minRoi:t.target.value}),onBlur:()=>setTimeout(()=>y(),500),sx:{width:100}}),e.jsx(re,{size:"small",placeholder:"Min Profit $",type:"number",value:d.minProfit,onChange:t=>f({...d,minProfit:t.target.value}),onBlur:()=>setTimeout(()=>y(),500),sx:{width:100}}),e.jsxs(be,{size:"small",sx:{width:150},children:[e.jsx(Ce,{children:"Supplier"}),e.jsxs(we,{value:d.supplier,label:"Supplier",onChange:t=>{f({...d,supplier:t.target.value}),setTimeout(()=>y(),500)},children:[e.jsx(Y,{value:"",children:"All"}),w.map(t=>e.jsx(Y,{value:t.id,children:t.name},t.id))]})]}),e.jsxs(be,{size:"small",sx:{width:180},children:[e.jsx(Ce,{children:"ASIN Status"}),e.jsxs(we,{value:d.asinStatus,label:"ASIN Status",onChange:t=>{f({...d,asinStatus:t.target.value}),setTimeout(()=>y(),500)},children:[e.jsxs(Y,{value:"all",children:["All Products (",R.all||0,")"]}),e.jsxs(Y,{value:"found",children:["ASIN Found (",R.found||0,")"]}),e.jsxs(Y,{value:"multiple_found",children:["Needs Selection (",R.multiple_found||0,")"]}),e.jsxs(Y,{value:"not_found",children:["Needs ASIN (",R.not_found||0,")"]}),e.jsxs(Y,{value:"manual",children:["Manual Entry (",R.manual||0,")"]})]})]}),e.jsxs(be,{size:"small",sx:{width:150},children:[e.jsx(Ce,{children:"Pricing Status"}),e.jsxs(we,{value:d.pricingStatus,label:"Pricing Status",onChange:t=>{f({...d,pricingStatus:t.target.value})},children:[e.jsx(Y,{value:"all",children:"All"}),e.jsx(Y,{value:"complete",children:"Has Pricing"}),e.jsx(Y,{value:"no_pricing",children:"No Pricing"}),e.jsx(Y,{value:"manual",children:"Manual Price"}),e.jsx(Y,{value:"needs_review",children:"Needs Review"})]})]}),e.jsx(Oe,{control:e.jsx(Ie,{checked:F,onChange:t=>B(t.target.checked)}),label:"Has Promo Deal"}),e.jsx(c,{sx:{flex:1}}),r.length>0&&e.jsxs(c,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsxs(s,{variant:"body2",color:"text.secondary",children:[r.length," selected"]}),e.jsx(C,{size:"small",variant:"contained",startIcon:N?e.jsx(ue,{size:14}):e.jsx($s,{size:14}),onClick:ke,disabled:N,children:"Analyze"}),e.jsx(C,{size:"small",variant:"outlined",onClick:()=>_e("buy_list"),children:"Move to Buy List"}),e.jsx(C,{size:"small",variant:"outlined",color:"error",onClick:()=>h([]),children:e.jsx(Ts,{size:14})})]}),e.jsx(ze,{title:"Refresh products (clears cache)",children:e.jsx(Se,{onClick:()=>{y(!0),T("Refreshing products...","info")},children:e.jsx(Vs,{size:18})})}),e.jsx(Se,{onClick:Te,disabled:!se("export_data"),title:se("export_data")?"Export data":"Export requires Starter or higher",children:e.jsx(Xs,{size:18})})]}),P?e.jsx(c,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(ue,{})}):D.length===0?e.jsxs(he,{sx:{p:4,textAlign:"center"},children:[e.jsx(xs,{size:48,color:ee.gray[400]}),e.jsx(s,{variant:"h6",sx:{mt:2},children:"No deals found"}),e.jsx(s,{color:"text.secondary",sx:{mb:2},children:"Upload a CSV or Excel file or add ASINs manually to get started"}),e.jsx(C,{variant:"contained",startIcon:e.jsx(rs,{size:16}),onClick:()=>M(!0),children:"Add Your First ASIN"})]}):e.jsxs(he,{children:[e.jsxs(c,{sx:{display:{xs:"none",md:"grid"},gridTemplateColumns:"40px 140px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.paper"},children:[e.jsx(Ie,{size:"small",checked:r.length===D.length&&D.length>0,indeterminate:r.length>0&&r.length<D.length,onChange:fe}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"ASIN"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"Product"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"Supplier"}),e.jsx(s,{variant:"caption",color:"text.secondary",align:"right",children:"MOQ"}),e.jsx(s,{variant:"caption",color:"text.secondary",align:"right",children:"Unit $"}),e.jsx(s,{variant:"caption",color:"text.secondary",align:"right",children:"Total $"}),e.jsx(s,{variant:"caption",color:"text.secondary",align:"right",children:"ROI"}),e.jsx(s,{variant:"caption",color:"text.secondary",align:"right",children:"Profit"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"Stage"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"Actions"})]}),e.jsx(c,{sx:{display:{xs:"none",md:"block"}},children:D.map(t=>e.jsx(fs,{deal:t,selected:r.includes(t.deal_id),onSelect:()=>xe(t.deal_id),onClick:()=>i(`/deals/${t.deal_id}`),onUpdateMoq:Ue,onDelete:b,onSetAsin:Me,onSelectAsin:x=>ie({open:!0,product:x}),onEnterAsin:x=>_({open:!0,product:x,asinInput:""}),onOpenManualPrice:(x,m)=>le({open:!0,deal:x,analysis:m}),analysis:t.analysis},t.deal_id))}),e.jsx(c,{sx:{display:{xs:"flex",md:"none"},flexDirection:"column",gap:2,p:2},children:D.map(t=>e.jsxs(he,{sx:{p:2,border:r.includes(t.deal_id)?`2px solid ${ee.purple.main}`:"1px solid",borderColor:r.includes(t.deal_id)?ee.purple.main:"divider",cursor:"pointer"},onClick:()=>i(`/deals/${t.deal_id}`),children:[e.jsxs(c,{display:"flex",justifyContent:"space-between",alignItems:"start",mb:2,children:[e.jsxs(c,{display:"flex",gap:2,flex:1,children:[t.image_url&&e.jsx(c,{component:"img",src:t.image_url,sx:{width:64,height:64,borderRadius:1,objectFit:"cover"}}),e.jsxs(c,{flex:1,children:[e.jsx(s,{variant:"body2",fontWeight:600,mb:.5,children:t.title||(t.roi===void 0&&t.profit===void 0?"Pending analysis...":"Unknown Product")}),e.jsx(s,{variant:"caption",fontFamily:"monospace",color:"text.secondary",children:t.asin})]})]}),e.jsx(Ie,{size:"small",checked:r.includes(t.deal_id),onClick:x=>{x.stopPropagation(),xe(t.deal_id)}})]}),e.jsxs(c,{display:"flex",justifyContent:"space-between",gap:2,flexWrap:"wrap",children:[e.jsxs(c,{children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"ROI"}),e.jsx(s,{variant:"body2",fontWeight:600,color:t.roi>=30?"success.main":"text.primary",children:t.roi?`${t.roi.toFixed(0)}%`:"-"})]}),e.jsxs(c,{children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Profit"}),e.jsxs(s,{variant:"body2",fontWeight:600,color:t.profit>0?"success.main":"error.main",children:["$",t.profit?t.profit.toFixed(2):"-"]})]}),e.jsxs(c,{children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Cost"}),e.jsxs(s,{variant:"body2",children:["$",(t.buy_cost||0).toFixed(2)]})]}),e.jsx(de,{label:t.stage||"new",size:"small",sx:{height:22,fontSize:11}})]})]},t.deal_id))})]}),e.jsx(ot,{open:z,onClose:()=>M(!1),onAdded:()=>{M(!1),y()},suppliers:w}),e.jsx(rt,{open:G,onClose:()=>H(!1),onComplete:$e}),e.jsx(at,{open:E.open,onClose:()=>le({open:!1,deal:null,analysis:null}),deal:E.deal,analysis:E.analysis,onSave:()=>{y(!0)}}),e.jsxs(me,{open:ne.open,onClose:()=>ie({open:!1,product:null}),maxWidth:"md",fullWidth:!0,children:[e.jsx(ge,{children:"Choose the Correct ASIN"}),e.jsx(pe,{children:ne.product&&e.jsxs(e.Fragment,{children:[e.jsxs(oe,{severity:"info",sx:{mb:2},children:["Multiple products found for UPC ",e.jsx("strong",{children:ne.product.upc}),". Select the one that matches your supplier's product."]}),e.jsx(c,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:2,mt:2},children:(te=ne.product.potential_asins)==null?void 0:te.map(t=>e.jsxs(he,{sx:{cursor:"pointer","&:hover":{boxShadow:6},border:"2px solid transparent",transition:"all 0.2s"},onClick:()=>Ae(ne.product.product_id||ne.product.id,t.asin),children:[t.image&&e.jsx(c,{component:"img",src:t.image,alt:t.title,sx:{width:"100%",height:200,objectFit:"contain",p:2,bgcolor:"background.default"}}),e.jsxs(pe,{children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:t.title||"Unknown Product"}),e.jsxs(s,{variant:"body2",color:"text.secondary",fontFamily:"monospace",children:["ASIN: ",t.asin]}),t.brand&&e.jsxs(s,{variant:"body2",color:"text.secondary",children:["Brand: ",t.brand]}),t.category&&e.jsxs(s,{variant:"caption",color:"text.secondary",children:["Category: ",t.category]}),e.jsx(C,{variant:"contained",fullWidth:!0,sx:{mt:2},onClick:x=>{x.stopPropagation(),Ae(ne.product.product_id||ne.product.id,t.asin)},children:"Select This One"})]})]},t.asin))})]})}),e.jsx(je,{children:e.jsx(C,{onClick:()=>ie({open:!1,product:null}),children:"Cancel"})})]}),e.jsxs(me,{open:J.open,onClose:()=>_({open:!1,product:null,asinInput:""}),children:[e.jsx(ge,{children:"Enter ASIN Manually"}),e.jsx(pe,{children:J.product&&e.jsxs(e.Fragment,{children:[e.jsxs(oe,{severity:"info",sx:{mb:2},children:["No ASIN found for UPC ",e.jsx("strong",{children:J.product.upc}),". Please enter the Amazon ASIN manually."]}),e.jsx(re,{autoFocus:!0,margin:"dense",label:"ASIN (10 characters)",type:"text",fullWidth:!0,value:J.asinInput,onChange:t=>_({...J,asinInput:t.target.value.toUpperCase().slice(0,10)}),inputProps:{maxLength:10,style:{fontFamily:"monospace",fontSize:14}},helperText:"Example: B07VRZ8TK3"})]})}),e.jsxs(je,{children:[e.jsx(C,{onClick:()=>_({open:!1,product:null,asinInput:""}),children:"Cancel"}),e.jsx(C,{onClick:Re,variant:"contained",disabled:J.asinInput.length!==10,children:"Save ASIN"})]})]}),e.jsxs(me,{open:v.open,onClose:()=>!v.deleting&&Q({open:!1,deal:null,deleting:!1}),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ge,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ds,{size:24,style:{color:ee.warning.main}}),"Delete Product"]}),e.jsxs(pe,{children:[e.jsx(oe,{severity:"warning",sx:{mb:2},children:"This action cannot be undone. All analysis data, pricing history, and related information will be permanently lost."}),v.deal&&e.jsxs(c,{children:[e.jsx(s,{variant:"body1",fontWeight:600,gutterBottom:!0,children:"Are you sure you want to delete this product?"}),e.jsxs(c,{sx:{mt:2,p:2,bgcolor:"background.default",borderRadius:1},children:[e.jsx(s,{variant:"body2",color:"text.secondary",children:"ASIN:"}),e.jsx(s,{variant:"body2",fontFamily:"monospace",fontWeight:600,children:v.deal.asin}),v.deal.title&&e.jsxs(e.Fragment,{children:[e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Product:"}),e.jsx(s,{variant:"body2",children:v.deal.title})]}),(v.deal.roi!==void 0||v.deal.profit!==void 0)&&e.jsxs(e.Fragment,{children:[e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Analysis Data:"}),e.jsxs(s,{variant:"body2",children:[v.deal.roi!==void 0&&`ROI: ${(Pe=v.deal.roi)==null?void 0:Pe.toFixed(0)}%`,v.deal.roi!==void 0&&v.deal.profit!==void 0&&" | ",v.deal.profit!==void 0&&`Profit: $${(ye=v.deal.profit)==null?void 0:ye.toFixed(2)}`]})]})]}),e.jsx(s,{variant:"body2",color:"error.main",sx:{mt:2,fontWeight:600},children:"⚠️ All analysis data, profit calculations, and product history will be permanently deleted."})]})]}),e.jsxs(je,{children:[e.jsx(C,{onClick:()=>Q({open:!1,deal:null,deleting:!1}),disabled:v.deleting,children:"Cancel"}),e.jsx(C,{onClick:W,variant:"contained",color:"error",disabled:v.deleting,startIcon:v.deleting?e.jsx(ue,{size:16}):e.jsx(hs,{size:16}),children:v.deleting?"Deleting...":"Delete Product"})]})]})]})}function ot({open:i,onClose:u,onAdded:l,suppliers:g}){const[n,p]=o.useState({asin:"",upc:"",identifier_type:"asin",buy_cost:"",is_pack:!1,pack_size:1,wholesale_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),[P,I]=o.useState(!1),{showToast:S}=Ne(),L=async()=>{var d,f;if(!(n.identifier_type==="asin"?n.asin:n.upc)){S("Please enter ASIN or UPC","error");return}const h=n.is_pack?parseFloat(n.wholesale_cost)/n.pack_size:parseFloat(n.buy_cost);if(!h||h<=0){S("Please enter a valid cost","error");return}I(!0);try{await O.post("/products",{asin:n.identifier_type==="asin"?n.asin:null,upc:n.identifier_type==="upc"?n.upc:null,identifier_type:n.identifier_type,buy_cost:h||null,pack_size:n.is_pack?n.pack_size:1,wholesale_cost:n.is_pack?parseFloat(n.wholesale_cost):null,supplier_id:n.supplier_id||null,supplier_name:n.supplier_name||null,moq:parseInt(n.moq)||1,notes:n.notes}),p({asin:"",upc:"",identifier_type:"asin",buy_cost:"",is_pack:!1,pack_size:1,wholesale_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),l()}catch(F){S(((f=(d=F.response)==null?void 0:d.data)==null?void 0:f.detail)||"Failed to add product","error")}finally{I(!1)}};return e.jsxs(me,{open:i,onClose:u,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ge,{children:"Add Product"}),e.jsx(pe,{children:e.jsxs(c,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(c,{sx:{mb:1},children:e.jsx(be,{component:"fieldset",children:e.jsxs(qs,{row:!0,value:n.identifier_type,onChange:r=>p({...n,identifier_type:r.target.value,asin:"",upc:""}),children:[e.jsx(Oe,{value:"asin",control:e.jsx(ts,{}),label:"ASIN"}),e.jsx(Oe,{value:"upc",control:e.jsx(ts,{}),label:"UPC"})]})})}),e.jsx(re,{label:n.identifier_type==="asin"?"ASIN":"UPC",value:n.identifier_type==="asin"?n.asin:n.upc,onChange:r=>p({...n,[n.identifier_type]:n.identifier_type==="asin"?r.target.value.toUpperCase():r.target.value.replace(/[^0-9]/g,"").slice(0,14)}),placeholder:n.identifier_type==="asin"?"B08VBVBS7N":"888003659162",required:!0,fullWidth:!0}),e.jsx(Oe,{control:e.jsx(Ie,{checked:n.is_pack,onChange:r=>p({...n,is_pack:r.target.checked,pack_size:r.target.checked?n.pack_size:1,wholesale_cost:r.target.checked?n.wholesale_cost:""})}),label:"This is a case/pack (multiple units)",sx:{display:"block"}}),n.is_pack?e.jsxs(c,{sx:{p:2,bgcolor:"grey.100",borderRadius:1},children:[e.jsx(s,{variant:"subtitle2",gutterBottom:!0,children:"Case Pricing"}),e.jsxs(c,{display:"flex",gap:2,children:[e.jsx(re,{label:"Pack Size",type:"number",value:n.pack_size,onChange:r=>p({...n,pack_size:Math.max(1,parseInt(r.target.value)||1)}),sx:{width:140},helperText:"Units per case",inputProps:{min:1}}),e.jsx(re,{label:"Case Cost",type:"number",step:"0.01",value:n.wholesale_cost,onChange:r=>p({...n,wholesale_cost:r.target.value}),fullWidth:!0,InputProps:{startAdornment:e.jsx(Ve,{position:"start",children:"$"})},helperText:"Cost for entire case"})]}),n.wholesale_cost&&n.pack_size>0&&e.jsxs(oe,{severity:"success",sx:{mt:2},children:[e.jsxs("strong",{children:["$",(parseFloat(n.wholesale_cost)/n.pack_size).toFixed(4)]})," per unit"]})]}):e.jsx(re,{label:"Unit Cost",type:"number",step:"0.01",value:n.buy_cost,onChange:r=>p({...n,buy_cost:r.target.value}),fullWidth:!0,InputProps:{startAdornment:e.jsx(Ve,{position:"start",children:"$"})},helperText:"Cost per single unit"}),e.jsxs(be,{children:[e.jsx(Ce,{children:"Supplier"}),e.jsxs(we,{value:n.supplier_id,label:"Supplier",onChange:r=>p({...n,supplier_id:r.target.value,supplier_name:""}),children:[e.jsx(Y,{value:"",children:"Select existing..."}),g.map(r=>e.jsx(Y,{value:r.id,children:r.name},r.id))]})]}),e.jsx(re,{label:"Or New Supplier Name",value:n.supplier_name,onChange:r=>p({...n,supplier_name:r.target.value,supplier_id:""}),placeholder:"Enter new supplier name"}),e.jsx(re,{label:"MOQ",type:"number",value:n.moq,onChange:r=>p({...n,moq:r.target.value})}),e.jsx(re,{label:"Notes",multiline:!0,rows:2,value:n.notes,onChange:r=>p({...n,notes:r.target.value})})]})}),e.jsxs(je,{children:[e.jsx(C,{onClick:u,children:"Cancel"}),e.jsx(C,{variant:"contained",onClick:L,disabled:P||!(n.identifier_type==="asin"?n.asin:n.upc)||!n.buy_cost&&!n.wholesale_cost,children:P?e.jsx(ue,{size:20}):"Add Product"})]})]})}export{wt as default};

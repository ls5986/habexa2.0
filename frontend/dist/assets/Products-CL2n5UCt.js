import{t as De,v as Re,r as i,w as Ue,_ as Ne,j as e,y as We,x as qe,z as Le,E as Oe,T as a,c as ge,a3 as Z,o as T,X as se,Y as te,I as Y,$ as re,B as o,O as X,a as C,a4 as we,a5 as pe,a6 as ue,p as G,K as _e,a7 as ae,a8 as ne,a9 as le,aa as K,q as O,a0 as Ve,ab as Je,D as He,k as ke,u as Qe,P as ze,e as Ge,M as Ke,S as Xe,Z as Ye,ac as Ze,C as de,R as es,h as ye,d as xe,J as ss}from"./index-DDnPEUpM.js";import{C as Ae}from"./Collapse-a6mhRePF.js";import{D as ie,P as fe}from"./plus-Ce53r8zA.js";import{S as ts}from"./SupplierFormModal-Du7Pd3YO.js";import{T as rs,a as be}from"./Tabs-DUviKOEk.js";import{C as as}from"./clock-CpYHeToi.js";import{I as Ie,R as ns}from"./refresh-cw-Dt-uEKm-.js";import{C as he}from"./Checkbox-YJBIZ0Xw.js";import{E as ls}from"./external-link-C0U1Th68.js";import"./SwitchBase-BymON1Oy.js";function is(c){return De("MuiAlertTitle",c)}Re("MuiAlertTitle",["root"]);const os=["className"],cs=c=>{const{classes:x}=c;return Oe({root:["root"]},is,x)},ds=We(a,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(c,x)=>x.root})(({theme:c})=>({fontWeight:c.typography.fontWeightMedium,marginTop:-2})),ee=i.forwardRef(function(x,u){const _=Ue({props:x,name:"MuiAlertTitle"}),{className:d}=_,m=Ne(_,os),v=_,y=cs(v);return e.jsx(ds,qe({gutterBottom:!0,component:"div",ownerState:v,ref:u,className:Le(y.root,d)},m))});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=ge("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=ge("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=ge("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),Pe=Z(e.jsx("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),me=Z(e.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),Fe=Z(e.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),Te=Z(e.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),hs=Z(e.jsx("path",{d:"M8 5v14l11-7z"}),"PlayArrow"),ve=Z(e.jsx("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"}),"Upload");function ms({open:c,onClose:x,onComplete:u}){var P,j,U,B,D,s;const[_,d]=i.useState([]),[m,v]=i.useState(""),[y,b]=i.useState(""),[l,p]=i.useState(!1),[k,h]=i.useState(!1),[w,$]=i.useState(null),[E,I]=i.useState(null),[n,F]=i.useState(null),[R,M]=i.useState(!1),[N,z]=i.useState(null),[W,q]=i.useState(!1);i.useEffect(()=>{c&&(g(),V())},[c]),i.useEffect(()=>{if(!E)return;const t=setInterval(async()=>{try{const r=await T.get(`/jobs/${E}`);F(r.data),(r.data.status==="completed"||r.data.status==="failed")&&(clearInterval(t),M(!1),r.data.status==="completed"&&u&&setTimeout(()=>{u(r.data.result)},500))}catch(r){console.error("Error polling job:",r),clearInterval(t),M(!1)}},2e3);return()=>clearInterval(t)},[E,u]);const g=async()=>{try{const t=await T.get("/suppliers");d(t.data.suppliers||t.data||[])}catch(t){console.error("Error fetching suppliers:",t)}},V=()=>{v(""),b(""),p(!1),$(null),I(null),F(null),M(!1),z(null),q(!1)},H=async()=>{var t,r;if(y.trim()){h(!0);try{const A=(await T.post("/suppliers",{name:y.trim()})).data;d([..._,A]),v(A.id),p(!1),b("")}catch(f){z(((r=(t=f.response)==null?void 0:t.data)==null?void 0:r.detail)||"Failed to create supplier")}finally{h(!1)}}},J=t=>{var A;const r=(A=t.target.files)==null?void 0:A[0];if(!r)return;const f=r.name.toLowerCase().slice(r.name.lastIndexOf("."));if(![".csv",".xlsx",".xls"].includes(f)){z("Please upload a .csv or .xlsx file");return}$(r),z(null)},Q=async()=>{var t,r;if(!w||!m){z("Please select a supplier and file");return}M(!0),z(null);try{const f=new FormData;f.append("file",w),f.append("supplier_id",m);const A=await T.post("/products/upload",f,{headers:{"Content-Type":"multipart/form-data"}});I(A.data.job_id)}catch(f){z(((r=(t=f.response)==null?void 0:t.data)==null?void 0:r.detail)||"Upload failed"),M(!1)}},S=((P=_.find(t=>t.id===m))==null?void 0:P.name)||"";return e.jsxs(se,{open:c,onClose:x,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(te,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:["Upload Price List",e.jsx(Y,{onClick:x,size:"small",children:e.jsx(me,{fontSize:"small"})})]}),e.jsxs(re,{children:[(n==null?void 0:n.status)==="completed"&&e.jsx(o,{children:e.jsxs(X,{severity:"success",sx:{mb:2},children:[e.jsx(ee,{children:"Upload Complete"}),e.jsxs(a,{variant:"body2",sx:{mt:1},children:["Supplier: ",e.jsx("strong",{children:(j=n.result)==null?void 0:j.supplier_name})]}),e.jsxs(a,{variant:"body2",children:["Products created: ",e.jsx("strong",{children:((U=n.result)==null?void 0:U.products_created)||0})]}),e.jsxs(a,{variant:"body2",children:["Deals processed: ",e.jsx("strong",{children:((B=n.result)==null?void 0:B.deals_processed)||0})]}),((s=(D=n.result)==null?void 0:D.errors)==null?void 0:s.length)>0&&e.jsxs(o,{sx:{mt:2},children:[e.jsxs(C,{size:"small",onClick:()=>q(!W),endIcon:W?e.jsx(Fe,{}):e.jsx(Te,{}),children:[n.result.errors.length," errors"]}),e.jsx(Ae,{in:W,children:e.jsx(we,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:n.result.errors.map((t,r)=>e.jsx(pe,{children:e.jsx(ue,{primary:t,primaryTypographyProps:{variant:"caption"}})},r))})})]})]})}),(n==null?void 0:n.status)==="failed"&&e.jsxs(X,{severity:"error",sx:{mb:2},children:[e.jsx(ee,{children:"Upload Failed"}),e.jsx(a,{variant:"body2",children:n.error})]}),((n==null?void 0:n.status)==="processing"||(n==null?void 0:n.status)==="pending"||(n==null?void 0:n.status)==="parsing")&&e.jsxs(o,{sx:{mb:2},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(G,{size:20}),e.jsx(a,{variant:"body1",children:n.status==="parsing"?"Parsing file...":`Processing for ${S}...`})]}),e.jsx(_e,{variant:"determinate",value:n.progress||0,sx:{mb:1,height:8,borderRadius:1}}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:[n.processed_items||0," / ",n.total_items||"?"," rows"]})]}),!n&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{sx:{mb:3},children:[e.jsxs(ae,{fullWidth:!0,sx:{mb:2},children:[e.jsx(ne,{children:"Supplier *"}),e.jsxs(le,{value:m,label:"Supplier *",onChange:t=>v(t.target.value),children:[e.jsx(K,{value:"",children:"Select supplier..."}),_.map(t=>e.jsx(K,{value:t.id,children:t.name},t.id))]})]}),l?e.jsxs(o,{sx:{display:"flex",gap:1},children:[e.jsx(O,{fullWidth:!0,size:"small",label:"New supplier name",value:y,onChange:t=>b(t.target.value),onKeyDown:t=>t.key==="Enter"&&H(),autoFocus:!0}),e.jsx(C,{variant:"contained",size:"small",onClick:H,disabled:k||!y.trim(),children:k?e.jsx(G,{size:16}):"Add"}),e.jsx(Y,{size:"small",onClick:()=>{p(!1),b("")},children:e.jsx(me,{fontSize:"small"})})]}):e.jsx(C,{variant:"outlined",size:"small",startIcon:e.jsx(Pe,{}),onClick:()=>p(!0),fullWidth:!0,children:"Add New Supplier"})]}),e.jsxs(o,{sx:{mb:2},children:[e.jsx("input",{type:"file",id:"file-upload",hidden:!0,accept:".csv,.xlsx,.xls",onChange:J}),e.jsx("label",{htmlFor:"file-upload",children:e.jsx(o,{sx:{border:"2px dashed",borderColor:w?"primary.main":"divider",borderRadius:2,p:4,textAlign:"center",cursor:"pointer",bgcolor:w?"primary.50":"background.paper","&:hover":{borderColor:"primary.main",bgcolor:"action.hover"}},children:w?e.jsxs(o,{children:[e.jsx(a,{variant:"body1",fontWeight:"600",children:w.name}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:[(w.size/1024).toFixed(1)," KB"]}),e.jsx(a,{variant:"caption",color:"primary",sx:{display:"block",mt:1},children:"Click to change"})]}):e.jsxs(o,{children:[e.jsx(ve,{sx:{fontSize:32,color:"text.secondary",mb:1}}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Drop CSV or Excel file here"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:".csv, .xlsx, .xls"})]})})})]}),N&&e.jsx(X,{severity:"error",sx:{mb:2},children:N}),e.jsx(a,{variant:"caption",color:"text.secondary",sx:{display:"block",textAlign:"center"},children:"All products in this file will be assigned to the selected supplier"})]})]}),e.jsx(ie,{children:(n==null?void 0:n.status)==="completed"?e.jsxs(e.Fragment,{children:[e.jsx(C,{onClick:V,children:"Upload Another"}),e.jsx(C,{variant:"contained",onClick:x,children:"Done"})]}):(n==null?void 0:n.status)==="failed"?e.jsx(C,{onClick:V,children:"Try Again"}):e.jsxs(e.Fragment,{children:[e.jsx(C,{onClick:x,children:"Cancel"}),e.jsx(C,{variant:"contained",onClick:Q,disabled:!w||!m||R,startIcon:R?null:e.jsx(ve,{}),children:R?e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(G,{size:16}),"Starting..."]}):`Upload to ${S||"Supplier"}`})]})})]})}function gs({open:c,onClose:x,productsWithoutSuppliers:u=[],groupedByFile:_={},productCount:d=0,onConfirm:m}){const{suppliers:v,loading:y,refetch:b}=Ve(),{showToast:l}=Je(),[p,k]=i.useState(""),[h,w]=i.useState(!1),[$,E]=i.useState(!1);i.useEffect(()=>{c&&v.length>0&&!p&&k(v[0].id)},[c,v,p]);const I=async()=>{var n,F,R,M,N;if(!p){l("Please select a supplier","error");return}E(!0);try{const z=u.map(g=>(g==null?void 0:g.id)||(g==null?void 0:g.product_id)).filter(g=>g&&!g.toString().startsWith("placeholder-"));if(z.length===0){const V=(await T.post("/products/assign-supplier",{supplier_id:p,assign_all_pending:!0})).data.total||u.length;l(`Assigned supplier to ${V} products`,"success"),setTimeout(()=>{m(p),x()},1e3);return}const q=(await T.post("/products/assign-supplier",{product_ids:z,supplier_id:p})).data.total;l(`Assigned supplier to ${q} products`,"success"),setTimeout(()=>{m(p),x()},1e3)}catch(z){console.error("Failed to assign suppliers:",z);const W=((R=(F=(n=z.response)==null?void 0:n.data)==null?void 0:F.detail)==null?void 0:R.message)||((N=(M=z.response)==null?void 0:M.data)==null?void 0:N.detail)||"Failed to assign suppliers";l(W,"error")}finally{E(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(se,{open:c,onClose:x,maxWidth:"sm",fullWidth:!0,children:[e.jsx(te,{children:e.jsx(a,{variant:"h6",fontWeight:600,children:"Select Supplier for Analysis"})}),e.jsxs(re,{children:[e.jsxs(X,{severity:"warning",sx:{mb:3},children:[e.jsxs(a,{variant:"body2",fontWeight:600,gutterBottom:!0,children:[d||u.length," product",(d||u.length)!==1?"s":""," ",(d||u.length)===1?"has":"have"," no supplier assigned."]}),e.jsx(a,{variant:"body2",children:"Analysis requires a supplier to track where products come from. Please select a supplier to assign to these products."})]}),e.jsx(o,{sx:{mb:2},children:e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ne,{children:"Supplier"}),e.jsx(le,{value:p,onChange:n=>k(n.target.value),label:"Supplier",disabled:$||y,children:v.map(n=>e.jsx(K,{value:n.id,children:n.name},n.id))})]})}),e.jsx(o,{sx:{display:"flex",justifyContent:"center",mb:2},children:e.jsx(C,{startIcon:e.jsx(Pe,{}),onClick:()=>w(!0),variant:"outlined",size:"small",children:"Create New Supplier"})}),e.jsx(He,{sx:{my:2}}),Object.keys(_).length>0?e.jsxs(o,{sx:{mb:2},children:[e.jsx(a,{variant:"body2",fontWeight:600,gutterBottom:!0,children:"Products grouped by file:"}),Object.entries(_).map(([n,F])=>e.jsxs(o,{sx:{mb:1,p:1,bgcolor:"action.hover",borderRadius:1},children:[e.jsxs(a,{variant:"caption",fontWeight:600,display:"block",children:[n,": ",F.length," product",F.length!==1?"s":""]}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:[F.slice(0,5).map(R=>R.asin).join(", "),F.length>5&&` ... and ${F.length-5} more`]})]},n))]}):u.length>0&&e.jsxs(a,{variant:"caption",color:"text.secondary",children:["Products: ",u.slice(0,10).map(n=>n.asin).join(", "),u.length>10&&` ... and ${u.length-10} more`]})]}),e.jsxs(ie,{children:[e.jsx(C,{onClick:x,disabled:$,children:"Cancel"}),e.jsx(C,{onClick:I,variant:"contained",disabled:!p||$,children:$?"Assigning...":`Assign to ${d||u.length} Product${(d||u.length)!==1?"s":""}`})]})]}),e.jsx(ts,{open:h,onClose:async()=>{w(!1),b&&await b()},supplier:null})]})}function Se({productIds:c=null,analyzeAllPending:x=!1,onComplete:u=null,buttonText:_="Analyze All",className:d=""}){const{hasFeature:m,promptUpgrade:v}=ke(),[y,b]=i.useState(null),[l,p]=i.useState(null),[k,h]=i.useState(!1),[w,$]=i.useState(!1),[E,I]=i.useState(!1),[n,F]=i.useState(!1),[R,M]=i.useState([]),[N,z]=i.useState({}),[W,q]=i.useState(0);i.useEffect(()=>{if(!y)return;const S=setInterval(async()=>{var P;try{const j=await T.get(`/jobs/${y}`);p(j.data),(j.data.status==="completed"||j.data.status==="failed"||j.data.status==="cancelled")&&(clearInterval(S),j.data.status==="completed"&&u&&u(j.data))}catch(j){console.error("Error polling job:",j),((P=j.response)==null?void 0:P.status)===404&&clearInterval(S)}},2e3);return()=>clearInterval(S)},[y,u]);const g=async()=>{var S,P,j,U,B,D;if(!m("bulk_analyze")){v("bulk_analyze");return}h(!0);try{const s={};c?s.product_ids=c:x&&(s.analyze_all_pending=!0);const t=await T.post("/batch/analyze",s);b(t.data.job_id),p({status:"pending",total_items:t.data.total,progress:0}),$(!0)}catch(s){console.error("Error starting batch:",s),console.error("Error response:",(S=s.response)==null?void 0:S.data),console.error("Error response detail:",(j=(P=s.response)==null?void 0:P.data)==null?void 0:j.detail);const t=(B=(U=s.response)==null?void 0:U.data)==null?void 0:B.detail;let r=t;if(typeof t=="string")try{r=JSON.parse(t)}catch{r={message:t}}if(console.log("Parsed error object:",r),r&&typeof r=="object"&&r.error==="products_missing_suppliers"){console.log("Products without suppliers:",r.products),console.log("Grouped by file:",r.grouped_by_file),console.log("Count:",r.count);const f=r.count||((D=r.products)==null?void 0:D.length)||0,A=r.products||[];q(f);let L=A;f>0&&A.length===0&&(L=Array(Math.min(f,100)).fill(null).map((je,oe)=>({id:`placeholder-${oe}`,asin:"...",title:"Product details loading..."}))),M(L),z(r.grouped_by_file||{}),F(!0)}else{const f=(r==null?void 0:r.message)||(t==null?void 0:t.message)||(typeof t=="string"?t:JSON.stringify(t))||"Failed to start analysis";console.error("Showing error alert:",f),alert(f)}}finally{h(!1)}},V=async S=>{F(!1),M([]),setTimeout(()=>{g()},2e3)},H=async()=>{var S,P;if(y)try{await T.post(`/jobs/${y}/cancel`),p(j=>({...j,status:"cancelled"})),setTimeout(()=>{$(!1),J()},1e3)}catch(j){console.error("Error cancelling:",j);const U=((P=(S=j.response)==null?void 0:S.data)==null?void 0:P.detail)||j.message||"Failed to cancel job";alert(`Failed to cancel: ${U}`)}},J=()=>{b(null),p(null),$(!1),I(!1)};if(w&&l){const S=l.status==="processing"||l.status==="pending",P=l.status==="completed",j=l.status==="failed",U=l.status==="cancelled",B=l.errors||[],D=S&&l.processed_items>0?Math.ceil((l.total_items-l.processed_items)/5):0;return e.jsxs(se,{open:w,onClose:S?void 0:J,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(te,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(a,{variant:"h6",children:[S&&"Analyzing Products...",P&&"Analysis Complete",j&&"Analysis Failed",U&&"Analysis Cancelled"]}),!S&&e.jsx(Y,{onClick:J,size:"small",children:e.jsx(me,{})})]}),e.jsxs(re,{children:[e.jsxs(o,{sx:{mb:2},children:[e.jsx(_e,{variant:"determinate",value:l.progress||0,sx:{mb:1,height:8,borderRadius:1},color:P?"success":j?"error":"primary"}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:[l.processed_items||0," / ",l.total_items||0," products"]})]}),e.jsxs(o,{sx:{mb:2},children:[l.success_count>0&&e.jsxs(a,{variant:"body2",color:"success.main",sx:{mb:.5},children:["✓ Success: ",l.success_count]}),l.error_count>0&&e.jsxs(a,{variant:"body2",color:"error.main",sx:{mb:.5},children:["✗ Errors: ",l.error_count]})]}),S&&D>0&&e.jsxs(a,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:2},children:["~",D," seconds remaining"]}),P&&e.jsxs(X,{severity:"success",sx:{mb:2},children:[e.jsx(ee,{children:"Analysis Complete"}),e.jsxs(a,{variant:"body2",children:["Successfully analyzed ",l.success_count," products",l.error_count>0&&", {job.error_count} errors"]})]}),j&&e.jsxs(X,{severity:"error",sx:{mb:2},children:[e.jsx(ee,{children:"Analysis Failed"}),e.jsx(a,{variant:"body2",children:B[0]||"Unknown error"})]}),B.length>0&&e.jsxs(o,{sx:{mt:2},children:[e.jsxs(C,{size:"small",onClick:()=>I(!E),endIcon:E?e.jsx(Fe,{}):e.jsx(Te,{}),children:["View ",B.length," ",B.length===1?"error":"errors"]}),e.jsx(Ae,{in:E,children:e.jsxs(we,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:[B.slice(0,20).map((s,t)=>e.jsx(pe,{children:e.jsx(ue,{primary:s,primaryTypographyProps:{variant:"caption"}})},t)),B.length>20&&e.jsx(pe,{children:e.jsx(ue,{primary:`... and ${B.length-20} more errors`,primaryTypographyProps:{variant:"caption",color:"text.secondary"}})})]})})]})]}),e.jsxs(ie,{children:[S&&e.jsx(C,{onClick:H,color:"error",children:"Cancel"}),!S&&e.jsx(C,{onClick:J,variant:"contained",children:P?"Done":"Close"})]})]})}const Q=m("bulk_analyze");return e.jsxs(e.Fragment,{children:[e.jsx(C,{variant:"contained",onClick:g,disabled:k||!Q,startIcon:k?e.jsx(G,{size:16}):e.jsx(hs,{}),className:d,title:Q?"":"Bulk analysis requires Starter or higher",children:k?"Starting...":_}),e.jsx(gs,{open:n,onClose:()=>{F(!1),M([]),z({})},productsWithoutSuppliers:R,groupedByFile:N,productCount:W,onConfirm:V})]})}const js=[{id:"new",label:"New",icon:ze,color:"#7C3AED"},{id:"analyzing",label:"Analyzing",icon:as,color:"#F59E0B"},{id:"reviewed",label:"Reviewed",icon:Ge,color:"#3B82F6"},{id:"buy_list",label:"Buy List",icon:Ke,color:"#10B981"},{id:"ordered",label:"Ordered",icon:ps,color:"#6B7280"}];function Ce(c,x){const[u,_]=i.useState(c);return i.useEffect(()=>{const d=setTimeout(()=>{_(c)},x);return()=>{clearTimeout(d)}},[c,x]),u}const $e=es.memo(({deal:c,selected:x,onSelect:u,onClick:_,onUpdateMoq:d})=>{const m=c.roi||0,v=c.profit||0,y=c.moq||1,b=c.buy_cost||0,l=c.total_investment||y*b,p=y*v,[k,h]=i.useState(!1),[w,$]=i.useState(y),E=()=>{d(c.deal_id,w),h(!1)};return e.jsxs(o,{sx:{display:"grid",gridTemplateColumns:"40px 110px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",alignItems:"center","&:hover":{bgcolor:"action.hover"},cursor:"pointer"},onClick:_,children:[e.jsx(he,{size:"small",checked:x,onClick:I=>I.stopPropagation(),onChange:u}),e.jsx(a,{variant:"body2",fontFamily:"monospace",fontSize:12,children:c.asin}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,minWidth:0},children:[c.image_url?e.jsx(o,{component:"img",src:c.image_url,sx:{width:32,height:32,borderRadius:1,objectFit:"cover",flexShrink:0}}):e.jsx(o,{sx:{width:32,height:32,bgcolor:"#252540",borderRadius:1}}),e.jsx(a,{variant:"body2",noWrap:!0,sx:{minWidth:0},children:c.title||"Pending analysis..."})]}),e.jsx(a,{variant:"body2",color:"text.secondary",noWrap:!0,children:c.supplier_name||"Unknown"}),e.jsx(o,{sx:{textAlign:"right"},onClick:I=>I.stopPropagation(),children:k?e.jsx(O,{size:"small",type:"number",value:w,onChange:I=>$(parseInt(I.target.value)||1),onBlur:E,onKeyDown:I=>I.key==="Enter"&&E(),autoFocus:!0,sx:{width:50},inputProps:{min:1,style:{textAlign:"right",padding:"4px"}}}):e.jsx(xe,{label:y,size:"small",onClick:()=>h(!0),sx:{minWidth:40,cursor:"pointer",bgcolor:"#2D2D4A","&:hover":{bgcolor:"#3D3D5A"}}})}),e.jsxs(a,{variant:"body2",align:"right",color:"text.secondary",children:["$",b.toFixed(2)]}),e.jsxs(a,{variant:"body2",align:"right",fontWeight:"600",color:l>500?"warning.main":"text.primary",children:["$",l.toFixed(2)]}),e.jsx(a,{variant:"body2",align:"right",fontWeight:"600",color:m>=30?"success.main":m>0?"warning.main":"error.main",children:m?`${m.toFixed(0)}%`:"-"}),e.jsx(ss,{title:`Total: $${p.toFixed(2)}`,children:e.jsxs(a,{variant:"body2",align:"right",color:v>0?"success.main":"error.main",children:["$",v?v.toFixed(2):"-"]})}),e.jsx(xe,{label:c.stage||"new",size:"small",sx:{height:22,fontSize:11}}),e.jsx(Y,{size:"small",component:"a",href:`https://amazon.com/dp/${c.asin}`,target:"_blank",onClick:I=>I.stopPropagation(),children:e.jsx(ls,{size:14})})]})});$e.displayName="DealRow";function Is(){const c=Qe(),x=i.useRef(!1),[u,_]=i.useState([]),[d,m]=i.useState({stages:{},total:0}),[v,y]=i.useState(!0),[b,l]=i.useState(null),[p,k]=i.useState([]),[h,w]=i.useState({minRoi:"",minProfit:"",search:"",supplier:""}),[$,E]=i.useState([]),[I,n]=i.useState(!1),[F,R]=i.useState(!1),[M,N]=i.useState(!1),{hasFeature:z,promptUpgrade:W}=ke(),q=Ce(h.search,500),g=i.useCallback(async()=>{if(!x.current){x.current=!0,y(!0);try{const s=new URLSearchParams;b&&s.append("stage",b),h.minRoi&&s.append("min_roi",h.minRoi),h.minProfit&&s.append("min_profit",h.minProfit),q&&s.append("search",q),h.supplier&&s.append("supplier_id",h.supplier),s.append("limit","100");const[t,r]=await Promise.all([T.get(`/products?${s}`),T.get("/products/stats")]);_(t.data.deals||t.data||[]),m(r.data||{stages:{},total:0})}catch(s){console.error("Failed to fetch:",s)}finally{y(!1),x.current=!1}}},[b,h.minRoi,h.minProfit,q,h.supplier]),V=i.useCallback(async()=>{try{const s=await T.get("/suppliers");E(s.data.suppliers||s.data||[])}catch(s){console.error("Failed to fetch suppliers:",s)}},[]);i.useEffect(()=>{g(),V()},[]);const H=Ce(b,300);i.useEffect(()=>{H!==void 0&&g()},[H]);const J=s=>{s.target.checked?k(u.map(t=>t.deal_id)):k([])},Q=s=>{k(t=>t.includes(s)?t.filter(r=>r!==s):[...t,s])},S=async()=>{var s,t;if(p.length){N(!0);try{const r=await T.post("/products/bulk-analyze",{deal_ids:p});alert(`Queued ${r.data.queued} products for analysis`),k([]),g()}catch(r){console.error("Bulk analyze failed:",r),alert("Bulk analyze failed: "+(((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.detail)||r.message))}finally{N(!1)}}},P=async s=>{var t,r;if(p.length)try{await T.post("/products/bulk-stage",{deal_ids:p,stage:s}),k([]),g()}catch(f){console.error("Bulk move failed:",f),alert("Failed to move deals: "+(((r=(t=f.response)==null?void 0:t.data)==null?void 0:r.detail)||f.message))}},j=s=>{setTimeout(()=>{g()},2e3),console.log("Upload complete:",s)},U=async()=>{var s,t;if(!z("export_data")){W("export_data");return}try{const r=b?`?stage=${b}`:"",A=(await T.get(`/products/export${r}`)).data.rows||[];if(!A.length)return;const L=Object.keys(A[0]),je=[L.join(","),...A.map(Me=>L.map(Be=>`"${Me[Be]||""}"`).join(","))].join(`
`),oe=new Blob([je],{type:"text/csv"}),Ee=URL.createObjectURL(oe),ce=document.createElement("a");ce.href=Ee,ce.download=`deals-${b||"all"}-${Date.now()}.csv`,ce.click()}catch(r){console.error("Export failed:",r),alert("Export failed: "+(((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.detail)||r.message))}},B=async(s,t)=>{var r,f;try{await T.patch(`/products/deal/${s}`,{moq:t}),_(A=>A.map(L=>L.deal_id===s?{...L,moq:t,total_investment:(L.buy_cost||0)*t}:L))}catch(A){console.error("Failed to update MOQ:",A),alert("Failed to update MOQ: "+(((f=(r=A.response)==null?void 0:r.data)==null?void 0:f.detail)||A.message))}},D=i.useMemo(()=>u,[u]);return e.jsxs(o,{sx:{p:3},children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(a,{variant:"h4",fontWeight:"700",children:"Products"}),e.jsxs(o,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(Se,{analyzeAllPending:!0,buttonText:"Analyze All Pending",onComplete:()=>setTimeout(()=>g(),1e3)}),p.length>0&&e.jsx(Se,{productIds:p,buttonText:`Analyze ${p.length} Selected`,onComplete:()=>{k([]),setTimeout(()=>g(),1e3)}}),e.jsx(C,{variant:"outlined",startIcon:e.jsx(xs,{size:16}),onClick:()=>R(!0),children:"Upload File"}),e.jsx(C,{variant:"contained",startIcon:e.jsx(fe,{size:16}),onClick:()=>n(!0),children:"Add ASIN"})]})]}),e.jsx(o,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(rs,{value:b||"all",onChange:(s,t)=>l(t==="all"?null:t),children:[e.jsx(be,{value:"all",label:`All (${d.total||0})`}),js.map(s=>{var t;return e.jsx(be,{value:s.id,label:`${s.label} (${((t=d.stages)==null?void 0:t[s.id])||0})`,icon:e.jsx(s.icon,{size:14}),iconPosition:"start"},s.id)})]})}),e.jsxs(o,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(O,{size:"small",placeholder:"Search ASIN...",value:h.search,onChange:s=>w({...h,search:s.target.value}),InputProps:{startAdornment:e.jsx(Ie,{position:"start",children:e.jsx(Xe,{size:16})})},sx:{width:200}}),e.jsx(O,{size:"small",placeholder:"Min ROI %",type:"number",value:h.minRoi,onChange:s=>w({...h,minRoi:s.target.value}),onBlur:()=>setTimeout(()=>g(),500),sx:{width:100}}),e.jsx(O,{size:"small",placeholder:"Min Profit $",type:"number",value:h.minProfit,onChange:s=>w({...h,minProfit:s.target.value}),onBlur:()=>setTimeout(()=>g(),500),sx:{width:100}}),e.jsxs(ae,{size:"small",sx:{width:150},children:[e.jsx(ne,{children:"Supplier"}),e.jsxs(le,{value:h.supplier,label:"Supplier",onChange:s=>{w({...h,supplier:s.target.value}),setTimeout(()=>g(),500)},children:[e.jsx(K,{value:"",children:"All"}),$.map(s=>e.jsx(K,{value:s.id,children:s.name},s.id))]})]}),e.jsx(o,{sx:{flex:1}}),p.length>0&&e.jsxs(o,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsxs(a,{variant:"body2",color:"text.secondary",children:[p.length," selected"]}),e.jsx(C,{size:"small",variant:"contained",startIcon:M?e.jsx(G,{size:14}):e.jsx(Ye,{size:14}),onClick:S,disabled:M,children:"Analyze"}),e.jsx(C,{size:"small",variant:"outlined",onClick:()=>P("buy_list"),children:"Move to Buy List"}),e.jsx(C,{size:"small",variant:"outlined",color:"error",onClick:()=>k([]),children:e.jsx(Ze,{size:14})})]}),e.jsx(Y,{onClick:g,children:e.jsx(ns,{size:18})}),e.jsx(Y,{onClick:U,disabled:!z("export_data"),title:z("export_data")?"Export data":"Export requires Starter or higher",children:e.jsx(us,{size:18})})]}),v?e.jsx(o,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(G,{})}):D.length===0?e.jsxs(de,{sx:{p:4,textAlign:"center"},children:[e.jsx(ze,{size:48,color:"#8B8B9B"}),e.jsx(a,{variant:"h6",sx:{mt:2},children:"No deals found"}),e.jsx(a,{color:"text.secondary",sx:{mb:2},children:"Upload a CSV or Excel file or add ASINs manually to get started"}),e.jsx(C,{variant:"contained",startIcon:e.jsx(fe,{size:16}),onClick:()=>n(!0),children:"Add Your First ASIN"})]}):e.jsxs(de,{children:[e.jsxs(o,{sx:{display:{xs:"none",md:"grid"},gridTemplateColumns:"40px 110px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.paper"},children:[e.jsx(he,{size:"small",checked:p.length===D.length&&D.length>0,indeterminate:p.length>0&&p.length<D.length,onChange:J}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"ASIN"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Product"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Supplier"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"MOQ"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"Unit $"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"Total $"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"ROI"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"Profit"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Stage"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Actions"})]}),e.jsx(o,{sx:{display:{xs:"none",md:"block"}},children:D.map(s=>e.jsx($e,{deal:s,selected:p.includes(s.deal_id),onSelect:()=>Q(s.deal_id),onClick:()=>c(`/deals/${s.deal_id}`),onUpdateMoq:B},s.deal_id))}),e.jsx(o,{sx:{display:{xs:"flex",md:"none"},flexDirection:"column",gap:2,p:2},children:D.map(s=>e.jsxs(de,{sx:{p:2,border:p.includes(s.deal_id)?`2px solid ${ye.purple.main}`:"1px solid",borderColor:p.includes(s.deal_id)?ye.purple.main:"divider",cursor:"pointer"},onClick:()=>c(`/deals/${s.deal_id}`),children:[e.jsxs(o,{display:"flex",justifyContent:"space-between",alignItems:"start",mb:2,children:[e.jsxs(o,{display:"flex",gap:2,flex:1,children:[s.image_url&&e.jsx(o,{component:"img",src:s.image_url,sx:{width:64,height:64,borderRadius:1,objectFit:"cover"}}),e.jsxs(o,{flex:1,children:[e.jsx(a,{variant:"body2",fontWeight:600,mb:.5,children:s.title||"Pending analysis..."}),e.jsx(a,{variant:"caption",fontFamily:"monospace",color:"text.secondary",children:s.asin})]})]}),e.jsx(he,{size:"small",checked:p.includes(s.deal_id),onClick:t=>{t.stopPropagation(),Q(s.deal_id)}})]}),e.jsxs(o,{display:"flex",justifyContent:"space-between",gap:2,flexWrap:"wrap",children:[e.jsxs(o,{children:[e.jsx(a,{variant:"caption",color:"text.secondary",children:"ROI"}),e.jsx(a,{variant:"body2",fontWeight:600,color:s.roi>=30?"success.main":"text.primary",children:s.roi?`${s.roi.toFixed(0)}%`:"-"})]}),e.jsxs(o,{children:[e.jsx(a,{variant:"caption",color:"text.secondary",children:"Profit"}),e.jsxs(a,{variant:"body2",fontWeight:600,color:s.profit>0?"success.main":"error.main",children:["$",s.profit?s.profit.toFixed(2):"-"]})]}),e.jsxs(o,{children:[e.jsx(a,{variant:"caption",color:"text.secondary",children:"Cost"}),e.jsxs(a,{variant:"body2",children:["$",(s.buy_cost||0).toFixed(2)]})]}),e.jsx(xe,{label:s.stage||"new",size:"small",sx:{height:22,fontSize:11}})]})]},s.deal_id))})]}),e.jsx(ys,{open:I,onClose:()=>n(!1),onAdded:()=>{n(!1),g()},suppliers:$}),e.jsx(ms,{open:F,onClose:()=>R(!1),onComplete:j})]})}function ys({open:c,onClose:x,onAdded:u,suppliers:_}){const[d,m]=i.useState({asin:"",buy_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),[v,y]=i.useState(!1),b=async()=>{var l,p;if(d.asin){y(!0);try{await T.post("/products",{asin:d.asin,buy_cost:d.buy_cost?parseFloat(d.buy_cost):null,supplier_id:d.supplier_id||null,supplier_name:d.supplier_name||null,moq:parseInt(d.moq)||1,notes:d.notes}),m({asin:"",buy_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),u()}catch(k){alert(((p=(l=k.response)==null?void 0:l.data)==null?void 0:p.detail)||"Failed to add product")}finally{y(!1)}}};return e.jsxs(se,{open:c,onClose:x,maxWidth:"sm",fullWidth:!0,children:[e.jsx(te,{children:"Add Product"}),e.jsx(re,{children:e.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(O,{label:"ASIN",value:d.asin,onChange:l=>m({...d,asin:l.target.value.toUpperCase()}),placeholder:"B08VBVBS7N",required:!0}),e.jsx(O,{label:"Buy Cost",type:"number",value:d.buy_cost,onChange:l=>m({...d,buy_cost:l.target.value}),InputProps:{startAdornment:e.jsx(Ie,{position:"start",children:"$"})}}),e.jsxs(ae,{children:[e.jsx(ne,{children:"Supplier"}),e.jsxs(le,{value:d.supplier_id,label:"Supplier",onChange:l=>m({...d,supplier_id:l.target.value,supplier_name:""}),children:[e.jsx(K,{value:"",children:"Select existing..."}),_.map(l=>e.jsx(K,{value:l.id,children:l.name},l.id))]})]}),e.jsx(O,{label:"Or New Supplier Name",value:d.supplier_name,onChange:l=>m({...d,supplier_name:l.target.value,supplier_id:""}),placeholder:"Enter new supplier name"}),e.jsx(O,{label:"MOQ",type:"number",value:d.moq,onChange:l=>m({...d,moq:l.target.value})}),e.jsx(O,{label:"Notes",multiline:!0,rows:2,value:d.notes,onChange:l=>m({...d,notes:l.target.value})})]})}),e.jsxs(ie,{children:[e.jsx(C,{onClick:x,children:"Cancel"}),e.jsx(C,{variant:"contained",onClick:b,disabled:v||!d.asin,children:v?e.jsx(G,{size:20}):"Add Product"})]})]})}export{Is as default};

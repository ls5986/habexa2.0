import{_ as bs,$ as Ss,r as o,a0 as _s,a1 as Cs,a2 as qe,j as e,a3 as ls,E as ws,a4 as ks,c as Xe,K as Fe,B as c,T as s,C as he,b as We,d as de,F as oe,x as cs,h as X,A as ds,o as L,O as me,Q as ge,I as Se,V as pe,a as C,a5 as ps,a6 as Ge,a7 as Qe,p as ue,a8 as be,a9 as Ce,aa as we,ab as Q,q as re,W as As,M as Ne,D as Ps,k as us,s as Ve,u as zs,P as xs,e as Is,y as Fs,t as Ns,ac as Oe,ad as Ie,Z as $s,ae as Ts,w as ze,R as Us}from"./index-D5Lu9gvQ.js";import{S as Ms,a as Rs,b as Es,c as De,d as Be}from"./Stepper-BzrxEvi4.js";import{C as Je}from"./Collapse-WYaAk9rd.js";import{G as B}from"./Grid-DPuG7YDF.js";import{T as Ws,a as Ds,b as es,c as ae}from"./TableRow-BE0jwtZO.js";import{C as Ze}from"./clock-CZH3VvAN.js";import{C as Bs}from"./check-circle-DwNv_QXB.js";import{C as Ye}from"./Close-aDtmQvkI.js";import{A as He}from"./AlertTitle-CSrKTPOG.js";import{D as je}from"./DialogActions-hQt4FAcL.js";import{S as Ls}from"./SupplierFormModal-D2fgu_qz.js";import{h as ss,R as qs,a as ts}from"./errorHandler-2xpqys1u.js";import{P as rs}from"./plus-xqXYkinT.js";import{T as Os,a as ns}from"./Tabs-DoXgWvWH.js";import{R as Vs}from"./refresh-cw-N5a38MT3.js";import{T as hs}from"./trash-2-DuEjtvlx.js";import{E as Hs}from"./external-link-DKqSwrhW.js";function Js(i){return bs("MuiStepContent",i)}Ss("MuiStepContent",["root","last","transition"]);const Ks=["children","className","TransitionComponent","transitionDuration","TransitionProps"],Gs=i=>{const{classes:u,last:l}=i;return ks({root:["root",l&&"last"],transition:["transition"]},Js,u)},Qs=ls("div",{name:"MuiStepContent",slot:"Root",overridesResolver:(i,u)=>{const{ownerState:l}=i;return[u.root,l.last&&u.last]}})(({ownerState:i,theme:u})=>qe({marginLeft:12,paddingLeft:20,paddingRight:8,borderLeft:u.vars?`1px solid ${u.vars.palette.StepContent.border}`:`1px solid ${u.palette.mode==="light"?u.palette.grey[400]:u.palette.grey[600]}`},i.last&&{borderLeft:"none"})),Zs=ls(Je,{name:"MuiStepContent",slot:"Transition",overridesResolver:(i,u)=>u.transition})({}),Le=o.forwardRef(function(u,l){const m=_s({props:u,name:"MuiStepContent"}),{children:a,className:d,TransitionComponent:I=Je,transitionDuration:F="auto",TransitionProps:y}=m,M=Cs(m,Ks),{orientation:r}=o.useContext(Ms),{active:g,last:p,expanded:j}=o.useContext(Rs),z=qe({},m,{last:p}),q=Gs(z);let k=F;return F==="auto"&&!I.muiSupportAuto&&(k=void 0),e.jsx(Qs,qe({className:ws(q.root,d),ref:l,ownerState:z},M,{children:e.jsx(Zs,qe({as:I,in:g||j,className:q.transition,ownerState:z,timeout:k,unmountOnExit:!0},y,{children:a}))}))});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ys=Xe("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xs=Xe("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=Xe("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),ms=Fe(e.jsx("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),gs=Fe(e.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),js=Fe(e.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),st=Fe(e.jsx("path",{d:"M8 5v14l11-7z"}),"PlayArrow"),as=Fe(e.jsx("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"}),"Upload");function tt({job:i,parsedData:u,conversionData:l,pricingData:m,keepaData:a}){var F,y,M;const d=r=>{var p;if(!i)return"pending";if(i.status==="completed")return"completed";if(i.status==="failed")return"error";const g=((p=i.metadata)==null?void 0:p.current_stage)||i.stage||"parse";return r==="parse"?g==="parse"?"active":"completed":r==="convert"?g==="parse"?"pending":g==="convert"?"active":"completed":r==="pricing"?["parse","convert"].includes(g)?"pending":g==="pricing"||g==="analyzing"?"active":"completed":r==="keepa"?["parse","convert","pricing","analyzing"].includes(g)?"pending":g==="keepa"?"active":"completed":"pending"},I=r=>{switch(r){case"completed":return e.jsx(Bs,{size:20,color:X.success.main});case"active":return e.jsx(Ze,{size:20,color:X.warning.main});case"error":return e.jsx(ds,{size:20,color:X.error.main});default:return e.jsx(Ze,{size:20,color:X.gray[400]})}};return e.jsxs(c,{sx:{mt:2},children:[e.jsxs(Es,{orientation:"vertical",children:[e.jsxs(De,{active:d("parse")==="active",completed:d("parse")==="completed",children:[e.jsx(Be,{StepIconComponent:()=>I(d("parse")),error:d("parse")==="error",children:e.jsx(s,{variant:"subtitle1",fontWeight:600,children:"Stage 0: Parse Excel"})}),e.jsx(Le,{children:u?e.jsx(he,{variant:"outlined",sx:{mt:1,bgcolor:"background.paper"},children:e.jsxs(We,{children:[e.jsxs(B,{container:!0,spacing:2,children:[e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Total Rows"}),e.jsx(s,{variant:"h6",children:u.total_rows||0})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Valid UPCs"}),e.jsx(s,{variant:"h6",children:u.valid_upcs||0})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Products with Promo"}),e.jsx(s,{variant:"h6",children:u.products_with_promo||0})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Format Detected"}),e.jsx(de,{label:u.format||"Standard",size:"small"})]}),u.pack_distribution&&e.jsxs(B,{item:!0,xs:12,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Pack Sizes"}),e.jsx(s,{variant:"body2",children:u.pack_distribution})]})]}),u.preview&&u.preview.length>0&&e.jsxs(c,{sx:{mt:2},children:[e.jsxs(s,{variant:"caption",color:"text.secondary",sx:{mb:1,display:"block"},children:["Preview (First ",Math.min(5,u.preview.length)," rows):"]}),e.jsx(Ws,{size:"small",children:e.jsxs(Ds,{children:[e.jsxs(es,{children:[e.jsx(ae,{children:e.jsx("strong",{children:"UPC"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Brand"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Pack"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Buy Cost"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Promo"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Promo Qty"})}),e.jsx(ae,{children:e.jsx("strong",{children:"Promo %"})})]}),u.preview.slice(0,5).map((r,g)=>{var p,j,z;return e.jsxs(es,{children:[e.jsx(ae,{children:(p=r.upc)==null?void 0:p.slice(0,12)}),e.jsx(ae,{children:(j=r.brand)==null?void 0:j.slice(0,15)}),e.jsx(ae,{children:r.pack_size}),e.jsxs(ae,{children:["$",((z=r.buy_cost)==null?void 0:z.toFixed(4))||"N/A"]}),e.jsx(ae,{children:r.has_promo?"✓":"—"}),e.jsx(ae,{children:r.promo_qty||"—"}),e.jsx(ae,{children:r.promo_percent?`${r.promo_percent}%`:"—"})]},g)})]})})]})]})}):e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Parsing file..."})})]}),e.jsxs(De,{active:d("convert")==="active",completed:d("convert")==="completed",children:[e.jsx(Be,{StepIconComponent:()=>I(d("convert")),error:d("convert")==="error",children:e.jsx(s,{variant:"subtitle1",fontWeight:600,children:"Stage 1: UPC → ASIN Conversion"})}),e.jsx(Le,{children:l?e.jsx(he,{variant:"outlined",sx:{mt:1,bgcolor:"background.paper"},children:e.jsxs(We,{children:[e.jsxs(B,{container:!0,spacing:2,children:[e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Total UPCs"}),e.jsx(s,{variant:"h6",children:l.total_upcs||0})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"ASINs Found"}),e.jsxs(s,{variant:"h6",color:"success.main",children:[l.asins_found||0," ✅"]})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Not Found"}),e.jsxs(s,{variant:"h6",color:"warning.main",children:[l.not_found||0," ⚠️"]})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Conversion Rate"}),e.jsxs(s,{variant:"h6",children:[((F=l.conversion_rate)==null?void 0:F.toFixed(1))||0,"%"]})]})]}),l.not_found>0&&e.jsxs(oe,{severity:"warning",sx:{mt:2},children:[l.not_found," products need manual ASIN entry"]})]})}):e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Converting UPCs to ASINs..."})})]}),e.jsxs(De,{active:d("pricing")==="active",completed:d("pricing")==="completed",children:[e.jsx(Be,{StepIconComponent:()=>I(d("pricing")),error:d("pricing")==="error",children:e.jsx(s,{variant:"subtitle1",fontWeight:600,children:"Stage 2: SP-API Pricing & Fees"})}),e.jsx(Le,{children:m?e.jsx(he,{variant:"outlined",sx:{mt:1,bgcolor:"background.paper"},children:e.jsx(We,{children:e.jsxs(B,{container:!0,spacing:2,children:[e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Products Analyzed"}),e.jsx(s,{variant:"h6",children:m.analyzed||0})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Profitable (ROI ≥ 30%)"}),e.jsxs(s,{variant:"h6",color:"success.main",children:[m.profitable||0," ✅"]})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Not Profitable"}),e.jsxs(s,{variant:"h6",color:"error.main",children:[m.not_profitable||0," ✗"]})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Average ROI"}),e.jsxs(s,{variant:"h6",children:[((y=m.avg_roi)==null?void 0:y.toFixed(1))||0,"%"]})]}),m.best_roi&&e.jsxs(B,{item:!0,xs:12,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Best ROI"}),e.jsxs(s,{variant:"body2",children:[(M=m.best_roi.value)==null?void 0:M.toFixed(1),"% (ASIN: ",m.best_roi.asin,")"]})]})]})})}):e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Fetching pricing and fees..."})})]}),e.jsxs(De,{active:d("keepa")==="active",completed:d("keepa")==="completed",children:[e.jsx(Be,{StepIconComponent:()=>I(d("keepa")),error:d("keepa")==="error",children:e.jsx(s,{variant:"subtitle1",fontWeight:600,children:"Stage 3: Keepa Deep Analysis"})}),e.jsx(Le,{children:a?e.jsx(he,{variant:"outlined",sx:{mt:1,bgcolor:"background.paper"},children:e.jsx(We,{children:e.jsxs(B,{container:!0,spacing:2,children:[e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Products Analyzed"}),e.jsx(s,{variant:"h6",children:a.analyzed||0})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Still Profitable at Worst"}),e.jsxs(s,{variant:"h6",color:"success.main",children:[a.still_profitable||0," ✅"]})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Risky"}),e.jsxs(s,{variant:"h6",color:"warning.main",children:[a.risky||0," ⚠️"]})]}),e.jsxs(B,{item:!0,xs:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Amazon is Seller"}),e.jsxs(s,{variant:"h6",color:"warning.main",children:[a.amazon_seller||0," ⚠️"]})]})]})})}):e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Fetching Keepa data for profitable products..."})})]})]}),i&&i.progress!==void 0&&e.jsxs(c,{sx:{mt:3},children:[e.jsx(cs,{variant:"determinate",value:i.progress||0,sx:{height:8,borderRadius:1}}),e.jsxs(s,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:[i.processed_items||0," / ",i.total_items||"?"," items processed"]})]})]})}function rt({open:i,onClose:u,onComplete:l}){var _,U,P,se,f,$,G,v,V,le,fe,xe,ke,_e,$e,Te,Ue,Me,Ae,Re;const[m,a]=o.useState([]),[d,I]=o.useState(""),[F,y]=o.useState(""),[M,r]=o.useState(!1),[g,p]=o.useState(!1),[j,z]=o.useState(null),[q,k]=o.useState(null),[n,W]=o.useState(null),[O,Z]=o.useState(!1),[H,A]=o.useState(null),[D,S]=o.useState(!1);o.useEffect(()=>{i&&(N(),ee())},[i]),o.useEffect(()=>{if(!i||!q||(n==null?void 0:n.status)==="completed"||(n==null?void 0:n.status)==="failed")return;const b=setInterval(async()=>{var R,E,te,Pe;try{const t=(await L.get(`/jobs/${q}`)).data;if(W(t),t.status==="completed"||t.status==="failed"){if(clearInterval(b),Z(!1),t.status==="failed"){const x=((R=t.errors)==null?void 0:R[0])||t.error||"Upload failed. Please check the errors.";A(x)}t.status==="completed"&&l&&setTimeout(()=>{l(t.result)},500)}}catch(ye){if(console.error("Error polling job:",ye),((E=ye.response)==null?void 0:E.status)===404){clearInterval(b),Z(!1),W(null),A("Job not found. The upload may have been cancelled or deleted.");return}clearInterval(b),Z(!1),A(((Pe=(te=ye.response)==null?void 0:te.data)==null?void 0:Pe.detail)||"Failed to check job status. Please refresh the page.")}},3e3);return()=>clearInterval(b)},[i,q,n==null?void 0:n.status,l]);const N=async()=>{try{const b=await L.get("/suppliers");a(b.data.suppliers||b.data||[])}catch(b){console.error("Error fetching suppliers:",b)}},ee=()=>{I(""),y(""),r(!1),z(null),k(null),W(null),Z(!1),A(null),S(!1)},ce=async()=>{var b,R;if(F.trim()){p(!0);try{const te=(await L.post("/suppliers",{name:F.trim()})).data;a([...m,te]),I(te.id),r(!1),y("")}catch(E){A(((R=(b=E.response)==null?void 0:b.data)==null?void 0:R.detail)||"Failed to create supplier")}finally{p(!1)}}},ne=b=>{var te;const R=(te=b.target.files)==null?void 0:te[0];if(!R)return;const E=R.name.toLowerCase().slice(R.name.lastIndexOf("."));if(![".csv",".xlsx",".xls"].includes(E)){A("Please upload a .csv or .xlsx file");return}z(R),A(null)},ie=async()=>{var b,R;if(console.log("handleUpload called"),console.log("file:",j),console.log("selectedSupplier:",d),console.log("Button should be enabled:",!!j&&!!d),!j||!d){A("Please select a supplier and file");return}Z(!0),A(null);try{const E=new FormData;E.append("file",j),E.append("supplier_id",d);const te=await L.post("/products/upload",E,{headers:{"Content-Type":"multipart/form-data"}});k(te.data.job_id)}catch(E){console.error("Upload error:",E);const te=((R=(b=E.response)==null?void 0:b.data)==null?void 0:R.detail)||E.message||"Upload failed. Please try again.";A(te),Z(!1),k(null)}},J=((_=m.find(b=>b.id===d))==null?void 0:_.name)||"";return e.jsxs(me,{open:i,onClose:u,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ge,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:["Upload Price List",e.jsx(Se,{onClick:u,size:"small",children:e.jsx(Ye,{fontSize:"small"})})]}),e.jsxs(pe,{children:[(n==null?void 0:n.status)==="completed"&&e.jsx(c,{children:e.jsxs(oe,{severity:n.error_count>0&&n.success_count===0?"error":n.error_count>0?"warning":"success",sx:{mb:2},children:[e.jsx(He,{children:n.error_count>0&&n.success_count===0?"Upload Completed with Errors":n.error_count>0?"Upload Completed with Some Errors":"Upload Complete"}),e.jsxs(s,{variant:"body2",sx:{mt:1},children:["Supplier: ",e.jsx("strong",{children:((U=n.metadata)==null?void 0:U.supplier_name)||((P=n.result)==null?void 0:P.supplier_name)||"Unknown"})]}),e.jsxs(s,{variant:"body2",children:["Products created: ",e.jsx("strong",{children:((se=n.result)==null?void 0:se.products_created)||n.success_count||0})]}),e.jsxs(s,{variant:"body2",children:["Deals processed: ",e.jsx("strong",{children:((f=n.result)==null?void 0:f.deals_processed)||n.success_count||0})]}),(n.error_count>0||(($=n.errors)==null?void 0:$.length)>0||((v=(G=n.result)==null?void 0:G.errors)==null?void 0:v.length)>0)&&e.jsxs(c,{sx:{mt:2},children:[e.jsxs(s,{variant:"body2",color:"text.secondary",sx:{mb:1},children:[n.error_count||((V=n.errors)==null?void 0:V.length)||((fe=(le=n.result)==null?void 0:le.errors)==null?void 0:fe.length)," row(s) had errors"]}),e.jsxs(C,{size:"small",onClick:()=>S(!D),endIcon:D?e.jsx(gs,{}):e.jsx(js,{}),children:[D?"Hide":"Show"," Errors"]}),e.jsx(Je,{in:D,children:e.jsx(ps,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:(n.errors||((xe=n.result)==null?void 0:xe.errors)||[]).map((b,R)=>e.jsx(Ge,{children:e.jsx(Qe,{primary:b,primaryTypographyProps:{variant:"caption"}})},R))})})]})]})}),(n==null?void 0:n.status)==="failed"&&e.jsxs(oe,{severity:"error",sx:{mb:2},children:[e.jsx(He,{children:"Upload Failed"}),e.jsx(s,{variant:"body2",children:n.error})]}),((n==null?void 0:n.status)==="processing"||(n==null?void 0:n.status)==="pending"||(n==null?void 0:n.status)==="parsing"||(n==null?void 0:n.status)==="analyzing")&&e.jsxs(c,{sx:{mb:2},children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(ue,{size:20}),e.jsx(s,{variant:"body1",children:n.status==="parsing"?"Parsing file...":n.status==="analyzing"?"Analyzing products...":`Processing for ${J}...`})]}),e.jsx(tt,{job:n,parsedData:((ke=n.metadata)==null?void 0:ke.parsed_data)||((_e=n.result)==null?void 0:_e.parsed_data),conversionData:(($e=n.metadata)==null?void 0:$e.conversion_data)||((Te=n.result)==null?void 0:Te.conversion_data),pricingData:((Ue=n.metadata)==null?void 0:Ue.pricing_data)||((Me=n.result)==null?void 0:Me.pricing_data),keepaData:((Ae=n.metadata)==null?void 0:Ae.keepa_data)||((Re=n.result)==null?void 0:Re.keepa_data)})]}),!n&&e.jsxs(e.Fragment,{children:[e.jsxs(c,{sx:{mb:3},children:[e.jsxs(be,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Ce,{children:"Supplier *"}),e.jsxs(we,{value:d,label:"Supplier *",onChange:b=>{const R=b.target.value;console.log("Selected supplier ID:",R),I(R)},renderValue:b=>{if(!b)return e.jsx("em",{style:{color:"#999"},children:"Select supplier..."});const R=m.find(E=>E.id===b);return(R==null?void 0:R.name)||"Unknown"},sx:{width:"100%","& .MuiSelect-select":{overflow:"visible",textOverflow:"ellipsis",whiteSpace:"nowrap",paddingRight:"32px"}},MenuProps:{PaperProps:{sx:{maxHeight:300,"& .MuiMenuItem-root":{whiteSpace:"normal",wordBreak:"break-word"}}}},children:[e.jsx(Q,{value:"",children:"Select supplier..."}),m.map(b=>e.jsx(Q,{value:b.id,children:b.name},b.id))]})]}),M?e.jsxs(c,{sx:{display:"flex",gap:1},children:[e.jsx(re,{fullWidth:!0,size:"small",label:"New supplier name",value:F,onChange:b=>y(b.target.value),onKeyDown:b=>b.key==="Enter"&&ce(),autoFocus:!0}),e.jsx(C,{variant:"contained",size:"small",onClick:ce,disabled:g||!F.trim(),children:g?e.jsx(ue,{size:16}):"Add"}),e.jsx(Se,{size:"small",onClick:()=>{r(!1),y("")},children:e.jsx(Ye,{fontSize:"small"})})]}):e.jsx(C,{variant:"outlined",size:"small",startIcon:e.jsx(ms,{}),onClick:()=>r(!0),fullWidth:!0,children:"Add New Supplier"})]}),e.jsxs(c,{sx:{mb:2},children:[e.jsx("input",{type:"file",id:"file-upload",hidden:!0,accept:".csv,.xlsx,.xls",onChange:ne}),e.jsx("label",{htmlFor:"file-upload",children:e.jsx(c,{sx:{border:"2px dashed",borderColor:j?"primary.main":"divider",borderRadius:2,p:4,textAlign:"center",cursor:"pointer",bgcolor:j?"primary.50":"background.paper","&:hover":{borderColor:"primary.main",bgcolor:"action.hover"}},children:j?e.jsxs(c,{children:[e.jsx(s,{variant:"body1",fontWeight:"600",children:j.name}),e.jsxs(s,{variant:"caption",color:"text.secondary",children:[(j.size/1024).toFixed(1)," KB"]}),e.jsx(s,{variant:"caption",color:"primary",sx:{display:"block",mt:1},children:"Click to change"})]}):e.jsxs(c,{children:[e.jsx(as,{sx:{fontSize:32,color:"text.secondary",mb:1}}),e.jsx(s,{variant:"body2",color:"text.secondary",children:"Drop CSV or Excel file here"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:".csv, .xlsx, .xls"})]})})})]}),H&&e.jsx(oe,{severity:"error",sx:{mb:2},children:H}),e.jsx(s,{variant:"caption",color:"text.secondary",sx:{display:"block",textAlign:"center"},children:"All products in this file will be assigned to the selected supplier"})]})]}),e.jsx(je,{children:(n==null?void 0:n.status)==="completed"?e.jsxs(e.Fragment,{children:[e.jsx(C,{onClick:ee,children:"Upload Another"}),e.jsx(C,{variant:"contained",onClick:u,children:"Done"})]}):(n==null?void 0:n.status)==="failed"?e.jsx(C,{onClick:ee,children:"Try Again"}):e.jsxs(e.Fragment,{children:[e.jsx(C,{onClick:u,children:"Cancel"}),e.jsx(C,{variant:"contained",onClick:ie,disabled:!j||!d||O,startIcon:O?null:e.jsx(as,{}),sx:{"&:disabled":{opacity:.5}},children:O?e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ue,{size:16}),"Starting..."]}):`Upload to ${J||"Supplier"}`})]})})]})}function nt({open:i,onClose:u,productsWithoutSuppliers:l=[],groupedByFile:m={},productCount:a=0,onConfirm:d}){const{suppliers:I,loading:F,refetch:y}=As(),{showToast:M}=Ne(),[r,g]=o.useState(""),[p,j]=o.useState(!1),[z,q]=o.useState(!1);o.useEffect(()=>{i&&I.length>0&&!r&&g(I[0].id)},[i,I,r]);const k=async()=>{var n,W,O,Z,H;if(!r){M("Please select a supplier","error");return}q(!0);try{const A=l.map(N=>(N==null?void 0:N.id)||(N==null?void 0:N.product_id)).filter(N=>N&&!N.toString().startsWith("placeholder-"));if(A.length===0){const ee=(await L.post("/products/assign-supplier",{supplier_id:r,assign_all_pending:!0})).data.total||l.length;M(`Assigned supplier to ${ee} products`,"success"),setTimeout(()=>{d(r),u()},1e3);return}const S=(await L.post("/products/assign-supplier",{product_ids:A,supplier_id:r})).data.total;M(`Assigned supplier to ${S} products`,"success"),setTimeout(()=>{d(r),u()},1e3)}catch(A){console.error("Failed to assign suppliers:",A);const D=((O=(W=(n=A.response)==null?void 0:n.data)==null?void 0:W.detail)==null?void 0:O.message)||((H=(Z=A.response)==null?void 0:Z.data)==null?void 0:H.detail)||"Failed to assign suppliers";M(D,"error")}finally{q(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(me,{open:i,onClose:u,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ge,{children:e.jsx(s,{variant:"h6",fontWeight:600,children:"Select Supplier for Analysis"})}),e.jsxs(pe,{children:[e.jsxs(oe,{severity:"warning",sx:{mb:3},children:[e.jsxs(s,{variant:"body2",fontWeight:600,gutterBottom:!0,children:[a||l.length," product",(a||l.length)!==1?"s":""," ",(a||l.length)===1?"has":"have"," no supplier assigned."]}),e.jsx(s,{variant:"body2",children:"Analysis requires a supplier to track where products come from. Please select a supplier to assign to these products."})]}),e.jsx(c,{sx:{mb:2},children:e.jsxs(be,{fullWidth:!0,children:[e.jsx(Ce,{children:"Supplier"}),e.jsx(we,{value:r,onChange:n=>g(n.target.value),label:"Supplier",disabled:z||F,children:I.map(n=>e.jsx(Q,{value:n.id,children:n.name},n.id))})]})}),e.jsx(c,{sx:{display:"flex",justifyContent:"center",mb:2},children:e.jsx(C,{startIcon:e.jsx(ms,{}),onClick:()=>j(!0),variant:"outlined",size:"small",children:"Create New Supplier"})}),e.jsx(Ps,{sx:{my:2}}),Object.keys(m).length>0?e.jsxs(c,{sx:{mb:2},children:[e.jsx(s,{variant:"body2",fontWeight:600,gutterBottom:!0,children:"Products grouped by file:"}),Object.entries(m).map(([n,W])=>e.jsxs(c,{sx:{mb:1,p:1,bgcolor:"action.hover",borderRadius:1},children:[e.jsxs(s,{variant:"caption",fontWeight:600,display:"block",children:[n,": ",W.length," product",W.length!==1?"s":""]}),e.jsxs(s,{variant:"caption",color:"text.secondary",children:[W.slice(0,5).map(O=>O.asin).join(", "),W.length>5&&` ... and ${W.length-5} more`]})]},n))]}):l.length>0&&e.jsxs(s,{variant:"caption",color:"text.secondary",children:["Products: ",l.slice(0,10).map(n=>n.asin).join(", "),l.length>10&&` ... and ${l.length-10} more`]})]}),e.jsxs(je,{children:[e.jsx(C,{onClick:u,disabled:z,children:"Cancel"}),e.jsx(C,{onClick:k,variant:"contained",disabled:!r||z,children:z?"Assigning...":`Assign to ${a||l.length} Product${(a||l.length)!==1?"s":""}`})]})]}),e.jsx(Ls,{open:p,onClose:async()=>{j(!1),y&&await y()},supplier:null})]})}function is({productIds:i=null,analyzeAllPending:u=!1,onComplete:l=null,buttonText:m="Analyze All",className:a=""}){const{hasFeature:d,promptUpgrade:I}=us(),{showToast:F}=Ne(),[y,M]=o.useState(null),[r,g]=o.useState(null),[p,j]=o.useState(!1),[z,q]=o.useState(!1),[k,n]=o.useState(!1),[W,O]=o.useState(!1),[Z,H]=o.useState([]),[A,D]=o.useState({}),[S,N]=o.useState(0);o.useEffect(()=>{if(!y)return;const _=setInterval(async()=>{var U;try{const P=await L.get(`/jobs/${y}`);g(P.data),(P.data.status==="completed"||P.data.status==="failed"||P.data.status==="cancelled")&&(clearInterval(_),P.data.status==="completed"&&l&&l(P.data))}catch(P){console.error("Error polling job:",P),((U=P.response)==null?void 0:U.status)===404&&clearInterval(_)}},2e3);return()=>clearInterval(_)},[y,l]);const ee=async()=>{var _,U,P,se,f,$;if(!d("bulk_analyze")){I("bulk_analyze");return}j(!0);try{const G={};i?G.product_ids=i:u&&(G.analyze_all_pending=!0);const v=await L.post("/batch/analyze",G);M(v.data.job_id),g({status:"pending",total_items:v.data.total,progress:0}),q(!0)}catch(G){console.error("Error starting batch:",G),console.error("Error response:",(_=G.response)==null?void 0:_.data),console.error("Error response detail:",(P=(U=G.response)==null?void 0:U.data)==null?void 0:P.detail);const v=(f=(se=G.response)==null?void 0:se.data)==null?void 0:f.detail;let V=v;if(typeof v=="string")try{V=JSON.parse(v)}catch{V={message:v}}if(console.log("Parsed error object:",V),V&&typeof V=="object"&&V.error==="products_missing_suppliers"){console.log("Products without suppliers:",V.products),console.log("Grouped by file:",V.grouped_by_file),console.log("Count:",V.count);const le=V.count||(($=V.products)==null?void 0:$.length)||0,fe=V.products||[];N(le);let xe=fe;le>0&&fe.length===0&&(xe=Array(Math.min(le,100)).fill(null).map((ke,_e)=>({id:`placeholder-${_e}`,asin:"...",title:"Product details loading..."}))),H(xe),D(V.grouped_by_file||{}),O(!0)}else{const le=(V==null?void 0:V.message)||(v==null?void 0:v.message)||(typeof v=="string"?v:JSON.stringify(v))||"Failed to start analysis";console.error("Showing error toast:",le),F(le,"error")}}finally{j(!1)}},ce=async _=>{O(!1),H([]),setTimeout(()=>{ee()},2e3)},ne=async()=>{var _,U;if(y)try{await L.post(`/jobs/${y}/cancel`),g(P=>({...P,status:"cancelled"})),setTimeout(()=>{q(!1),ie()},1e3)}catch(P){console.error("Error cancelling:",P);const se=((U=(_=P.response)==null?void 0:_.data)==null?void 0:U.detail)||P.message||"Failed to cancel job";F(`Failed to cancel: ${se}`,"error")}},ie=()=>{M(null),g(null),q(!1),n(!1)};if(z&&r){const _=r.status==="processing"||r.status==="pending",U=r.status==="completed",P=r.status==="failed",se=r.status==="cancelled",f=r.errors||[],$=_&&r.processed_items>0?Math.ceil((r.total_items-r.processed_items)/5):0;return e.jsxs(me,{open:z,onClose:_?void 0:ie,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ge,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(s,{variant:"h6",children:[_&&"Analyzing Products...",U&&"Analysis Complete",P&&"Analysis Failed",se&&"Analysis Cancelled"]}),!_&&e.jsx(Se,{onClick:ie,size:"small",children:e.jsx(Ye,{})})]}),e.jsxs(pe,{children:[e.jsxs(c,{sx:{mb:2},children:[e.jsx(cs,{variant:"determinate",value:r.progress||0,sx:{mb:1,height:8,borderRadius:1},color:U?"success":P?"error":"primary"}),e.jsxs(s,{variant:"body2",color:"text.secondary",children:[r.processed_items||0," / ",r.total_items||0," products"]})]}),e.jsxs(c,{sx:{mb:2},children:[r.success_count>0&&e.jsxs(s,{variant:"body2",color:"success.main",sx:{mb:.5},children:["✓ Success: ",r.success_count]}),r.error_count>0&&e.jsxs(s,{variant:"body2",color:"error.main",sx:{mb:.5},children:["✗ Errors: ",r.error_count]})]}),_&&$>0&&e.jsxs(s,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:2},children:["~",$," seconds remaining"]}),U&&e.jsxs(oe,{severity:"success",sx:{mb:2},children:[e.jsx(He,{children:"Analysis Complete"}),e.jsxs(s,{variant:"body2",children:["Successfully analyzed ",r.success_count," products",r.error_count>0&&", {job.error_count} errors"]})]}),P&&e.jsxs(oe,{severity:"error",sx:{mb:2},children:[e.jsx(He,{children:"Analysis Failed"}),e.jsx(s,{variant:"body2",children:f[0]||"Unknown error"})]}),f.length>0&&e.jsxs(c,{sx:{mt:2},children:[e.jsxs(C,{size:"small",onClick:()=>n(!k),endIcon:k?e.jsx(gs,{}):e.jsx(js,{}),children:["View ",f.length," ",f.length===1?"error":"errors"]}),e.jsx(Je,{in:k,children:e.jsxs(ps,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:[f.slice(0,20).map((G,v)=>e.jsx(Ge,{children:e.jsx(Qe,{primary:G,primaryTypographyProps:{variant:"caption"}})},v)),f.length>20&&e.jsx(Ge,{children:e.jsx(Qe,{primary:`... and ${f.length-20} more errors`,primaryTypographyProps:{variant:"caption",color:"text.secondary"}})})]})})]})]}),e.jsxs(je,{children:[_&&e.jsx(C,{onClick:ne,color:"error",children:"Cancel"}),!_&&e.jsx(C,{onClick:ie,variant:"contained",children:U?"Done":"Close"})]})]})}const J=d("bulk_analyze");return e.jsxs(e.Fragment,{children:[e.jsx(C,{variant:"contained",onClick:ee,disabled:p||!J,startIcon:p?e.jsx(ue,{size:16}):e.jsx(st,{}),className:a,title:J?"":"Bulk analysis requires Starter or higher",children:p?"Starting...":m}),e.jsx(nt,{open:W,onClose:()=>{O(!1),H([]),D({})},productsWithoutSuppliers:Z,groupedByFile:A,productCount:S,onConfirm:ce})]})}const at=({open:i,onClose:u,deal:l,analysis:m,onSave:a})=>{var j,z,q;const[d,I]=o.useState(""),[F,y]=o.useState(!1),{showToast:M}=Ne(),r=o.useMemo(()=>{var S,N;if(!d||!l)return null;const k=parseFloat(d);if(isNaN(k)||k<=0)return null;const n=l.buy_cost||((N=(S=l.product_sources)==null?void 0:S[0])==null?void 0:N.buy_cost)||0,W=k*.15+4.5,O=.35*.5,H=n+O+.1,A=k-W-H,D=H>0?A/H*100:0;return{fees:W,profit:A,roi:D,landed:H}},[d,l]),g=async()=>{var k,n;if(!(!d||!(m!=null&&m.id))){y(!0);try{await L.patch(`/analysis/${m.id}/manual-price`,{sell_price:parseFloat(d)}),M("Manual price saved successfully","success"),a(),u(),I("")}catch(W){M(((n=(k=W.response)==null?void 0:k.data)==null?void 0:n.detail)||"Failed to save manual price","error")}finally{y(!1)}}},p=k=>({no_active_offers:"No active sellers on Amazon",no_response:"No response from Amazon API",gated:"Product is gated/restricted",invalid_asin:"ASIN may be invalid",unknown:"Unknown reason"})[k]||k||"Unknown";return e.jsxs(me,{open:i,onClose:u,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ge,{children:"Enter Manual Sell Price"}),e.jsxs(pe,{children:[e.jsx(oe,{severity:"warning",sx:{mb:2},children:"No pricing data available from Amazon. You can enter a manual sell price based on your research."}),e.jsx(s,{variant:"subtitle2",gutterBottom:!0,children:(l==null?void 0:l.title)||"Unknown Product"}),e.jsxs(s,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:["ASIN: ",l==null?void 0:l.asin," | Buy Cost: $",(l==null?void 0:l.buy_cost)||((z=(j=l==null?void 0:l.product_sources)==null?void 0:j[0])==null?void 0:z.buy_cost)||"0.00"]}),(m==null?void 0:m.pricing_status_reason)&&e.jsx(de,{label:`Reason: ${p(m.pricing_status_reason)}`,size:"small",color:"warning",sx:{mb:2}}),(m==null?void 0:m.fba_lowest_365d)&&e.jsxs(oe,{severity:"info",sx:{mb:2},children:["Keepa shows historical FBA low of $",(q=m.fba_lowest_365d)==null?void 0:q.toFixed(2),m.amazon_was_seller&&" (Amazon was a seller)"]}),e.jsx(re,{label:"Sell Price",type:"number",step:"0.01",value:d,onChange:k=>I(k.target.value),fullWidth:!0,InputProps:{startAdornment:e.jsx(Ve,{position:"start",children:"$"})},sx:{mt:2},autoFocus:!0}),r&&e.jsxs(c,{sx:{mt:2,p:2,bgcolor:"grey.100",borderRadius:1},children:[e.jsx(s,{variant:"subtitle2",gutterBottom:!0,children:"Estimated (fees are approximate):"}),e.jsxs(s,{variant:"body2",children:["Fees: ~$",r.fees.toFixed(2)]}),e.jsxs(s,{variant:"body2",children:["Landed Cost: $",r.landed.toFixed(2)]}),e.jsxs(s,{variant:"body2",children:["Profit: $",r.profit.toFixed(2)]}),e.jsxs(s,{variant:"body1",fontWeight:"bold",color:r.roi>=30?"success.main":r.roi>0?"warning.main":"error.main",sx:{mt:1},children:["ROI: ",r.roi.toFixed(1),"%"]})]}),e.jsx(s,{variant:"caption",color:"text.secondary",sx:{mt:2,display:"block"},children:"Note: Fees are estimated at ~15% referral + $4.50 FBA. Re-analyze when product has active offers for accurate fees."})]}),e.jsxs(je,{children:[e.jsx(C,{onClick:u,children:"Cancel"}),e.jsx(C,{onClick:g,variant:"contained",disabled:!d||F||isNaN(parseFloat(d))||parseFloat(d)<=0,children:F?e.jsx(ue,{size:20}):"Save Manual Price"})]})]})},it=[{id:"new",label:"New",icon:xs,color:X.purple.main},{id:"analyzing",label:"Analyzing",icon:Ze,color:X.warning.main},{id:"reviewed",label:"Reviewed",icon:Is,color:X.info.main},{id:"buy_list",label:"Buy List",icon:Fs,color:X.success.main},{id:"ordered",label:"Ordered",icon:Ys,color:X.gray[400]}];function os(i,u){const[l,m]=o.useState(i);return o.useEffect(()=>{const a=setTimeout(()=>{m(i)},u);return()=>{clearTimeout(a)}},[i,u]),l}const fs=Us.memo(({deal:i,selected:u,onSelect:l,onClick:m,onUpdateMoq:a,onDelete:d,onSetAsin:I,onOpenManualPrice:F,onSelectAsin:y,onEnterAsin:M,analysis:r})=>{const g=i.roi||0,p=i.profit||0,j=i.moq||1,z=i.buy_cost||0,q=i.total_investment||j*z,k=j*p,n=i.asin_status||"found",W=n==="not_found"||!i.asin,O=n==="multiple_found",Z=i.potential_asins||[],H=i.is_variation&&i.variation_count>1,A=r||{},D=A.pricing_status||"complete",S=A.needs_review||D==="no_pricing",[N,ee]=o.useState(!1),[ce,ne]=o.useState(j),[ie,J]=o.useState(!1),[_,U]=o.useState(""),P=()=>{a(i.deal_id,ce),ee(!1)},se=()=>{_.length===10&&(I(i.product_id,_),J(!1),U(""))};return e.jsxs(c,{sx:{display:"grid",gridTemplateColumns:"40px 140px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",alignItems:"center","&:hover":{bgcolor:"action.hover"},cursor:"pointer"},onClick:m,children:[e.jsx(Ie,{size:"small",checked:u,onClick:f=>f.stopPropagation(),onChange:l}),e.jsx(c,{sx:{display:"flex",flexDirection:"column",gap:.5},children:O?e.jsxs(c,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[e.jsx(de,{label:`Choose ASIN (${Z.length})`,color:"warning",size:"small",onClick:f=>{f.stopPropagation(),y&&y(i)},sx:{fontSize:10,height:20,cursor:"pointer","&:hover":{bgcolor:"warning.dark"}}}),i.upc&&e.jsxs(s,{variant:"caption",color:"text.secondary",fontSize:9,children:["UPC: ",i.upc]})]}):W?e.jsxs(e.Fragment,{children:[ie?e.jsxs(c,{sx:{display:"flex",gap:.5,alignItems:"center"},children:[e.jsx(re,{size:"small",placeholder:"Enter ASIN",value:_,onChange:f=>U(f.target.value.toUpperCase().slice(0,10)),onClick:f=>f.stopPropagation(),sx:{width:100,fontSize:11},inputProps:{style:{fontSize:11,fontFamily:"monospace"}}}),e.jsx(C,{size:"small",variant:"contained",onClick:f=>{f.stopPropagation(),se()},disabled:_.length!==10,sx:{minWidth:40,height:28,fontSize:10},children:"Save"})]}):e.jsx(c,{sx:{display:"flex",gap:.5,alignItems:"center"},children:e.jsx(de,{label:"Enter ASIN",color:"error",size:"small",onClick:f=>{f.stopPropagation(),M&&M(i)},sx:{fontSize:10,height:20,cursor:"pointer","&:hover":{bgcolor:"error.dark"}}})}),i.upc&&e.jsxs(s,{variant:"caption",color:"text.secondary",fontSize:10,children:["UPC: ",i.upc]})]}):e.jsxs(e.Fragment,{children:[e.jsx(s,{variant:"body2",fontFamily:"monospace",fontSize:12,children:i.asin}),H&&e.jsx(de,{label:`Variation (${i.variation_count})`,size:"small",variant:"outlined",sx:{fontSize:9,height:18,mt:.5}}),i.upc&&e.jsxs(s,{variant:"caption",color:"text.secondary",fontSize:9,children:["UPC: ",i.upc]})]})}),e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,minWidth:0},children:[i.image_url?e.jsx(c,{component:"img",src:i.image_url,sx:{width:32,height:32,borderRadius:1,objectFit:"cover",flexShrink:0}}):e.jsx(c,{sx:{width:32,height:32,bgcolor:X.navy.light,borderRadius:1}}),e.jsx(s,{variant:"body2",noWrap:!0,sx:{minWidth:0},children:i.title||(i.roi===void 0&&i.profit===void 0?"Pending analysis...":"Unknown Product")})]}),e.jsx(s,{variant:"body2",color:"text.secondary",noWrap:!0,children:i.supplier_name||"Unknown"}),e.jsx(c,{sx:{textAlign:"right"},onClick:f=>f.stopPropagation(),children:N?e.jsx(re,{size:"small",type:"number",value:ce,onChange:f=>ne(parseInt(f.target.value)||1),onBlur:P,onKeyDown:f=>f.key==="Enter"&&P(),autoFocus:!0,sx:{width:50},inputProps:{min:1,style:{textAlign:"right",padding:"4px"}}}):e.jsx(de,{label:j,size:"small",onClick:()=>ee(!0),sx:{minWidth:40,cursor:"pointer",bgcolor:X.gray[300],"&:hover":{bgcolor:X.navy.light}}})}),e.jsxs(c,{sx:{textAlign:"right"},children:[e.jsxs(s,{variant:"body2",color:"text.secondary",children:["$",(z||0).toFixed(2)]}),i.has_promo&&i.promo_percent&&e.jsx(de,{label:`${i.promo_percent}% OFF`,color:"success",size:"small",sx:{fontWeight:"bold",fontSize:9,height:18,mt:.5}})]}),e.jsxs(s,{variant:"body2",align:"right",fontWeight:"600",color:(q||0)>500?"warning.main":"text.primary",children:["$",(q||0).toFixed(2)]}),e.jsx(s,{variant:"body2",align:"right",fontWeight:"600",color:g>=30?"success.main":g>0?"warning.main":"error.main",children:g?`${g.toFixed(0)}%`:"-"}),e.jsx(ze,{title:`Total: $${(k||0).toFixed(2)}`,children:e.jsxs(s,{variant:"body2",align:"right",color:(p||0)>0?"success.main":"error.main",children:["$",p?p.toFixed(2):"-"]})}),e.jsxs(c,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[S&&e.jsx(ze,{title:`Reason: ${A.pricing_status_reason||"No pricing data"}`,children:e.jsx(de,{label:D==="manual"?"Manual":"No Pricing",color:D==="manual"?"info":"warning",size:"small",onClick:f=>{f.stopPropagation(),D==="no_pricing"&&F&&F(i,A)},sx:{height:18,fontSize:9,cursor:D==="no_pricing"?"pointer":"default","&:hover":D==="no_pricing"?{bgcolor:"warning.dark"}:{}}})}),e.jsx(de,{label:i.stage||"new",size:"small",sx:{height:22,fontSize:11}})]}),e.jsxs(c,{sx:{display:"flex",gap:.5,alignItems:"center"},onClick:f=>f.stopPropagation(),children:[e.jsx(ze,{title:"View on Amazon",children:e.jsx(Se,{size:"small",component:"a",href:`https://amazon.com/dp/${i.asin}`,target:"_blank",children:e.jsx(Hs,{size:14})})}),e.jsx(ze,{title:"Delete product",children:e.jsx(Se,{size:"small",onClick:f=>{f.stopPropagation(),d(i)},sx:{color:"error.main"},children:e.jsx(hs,{size:14})})})]})]})});fs.displayName="DealRow";function wt(){var te,Pe,ye;const i=zs(),u=o.useRef(!1),[l,m]=o.useState([]),[a,d]=o.useState({stages:{},total:0}),[I,F]=o.useState(!0),[y,M]=o.useState(null),[r,g]=o.useState([]),[p,j]=o.useState({minRoi:"",minProfit:"",search:"",supplier:"",asinStatus:"all",pricingStatus:"all"}),[z,q]=o.useState(!1),[k,n]=o.useState([]),[W,O]=o.useState(!1),[Z,H]=o.useState(!1),[A,D]=o.useState(!1),[S,N]=o.useState({open:!1,deal:null}),[ee,ce]=o.useState({open:!1,deal:null,analysis:null}),[ne,ie]=o.useState({open:!1,product:null}),[J,_]=o.useState({open:!1,product:null,asinInput:""}),[U,P]=o.useState({all:0,found:0,not_found:0,multiple_found:0,manual:0}),{hasFeature:se,promptUpgrade:f}=us(),{showToast:$}=Ne(),G=os(p.search,500),v=o.useCallback(async(t=!1)=>{var x,h,T;if(!u.current){u.current=!0,F(!0);try{const w=new URLSearchParams;y&&w.append("stage",y),p.minRoi&&w.append("min_roi",p.minRoi),p.minProfit&&w.append("min_profit",p.minProfit),G&&w.append("search",G),p.supplier&&w.append("supplier_id",p.supplier),p.asinStatus&&p.asinStatus!=="all"&&w.append("asin_status",p.asinStatus),w.append("limit","100"),t&&w.append("_t",Date.now().toString());const[Y,Ke]=await Promise.all([L.get(`/products?${w}`),L.get(`/products/stats${t?`?_t=${Date.now()}`:""}`)]);let K=[];Array.isArray(Y.data)?K=Y.data:Array.isArray((x=Y.data)==null?void 0:x.deals)?K=Y.data.deals:Array.isArray((h=Y.data)==null?void 0:h.data)&&(K=Y.data.data),m(K);const ve=Ke.data||{stages:{},total:0};d({...ve,stages:{...{new:0,analyzing:0,reviewed:0,top_products:0,buy_list:0,ordered:0},...ve.stages||{}},total:ve.total||0}),(T=Y.data)!=null&&T.counts&&P(Y.data.counts),console.log("Products loaded:",K.length,"items"),K.length>0&&(console.log("First product fields:",Object.keys(K[0])),console.log("First product sample:",{asin:K[0].asin,title:K[0].title,stage:K[0].stage,status:K[0].status,product_status:K[0].product_status,analysis_status:K[0].analysis_status,roi:K[0].roi,profit:K[0].profit,deal_score:K[0].deal_score})),console.log("Stats data:",ve),K.length===0&&ve.total===0&&console.warn("No products found - view might be empty or missing")}catch(w){console.error("Failed to fetch:",w),$("Failed to load products. Please try refreshing.","error")}finally{F(!1),u.current=!1}}},[y,p.minRoi,p.minProfit,G,p.supplier,p.asinStatus,$]),V=o.useCallback(async()=>{var t,x;try{const h=await L.get("/suppliers");let T=[];Array.isArray(h.data)?T=h.data:Array.isArray((t=h.data)==null?void 0:t.suppliers)?T=h.data.suppliers:Array.isArray((x=h.data)==null?void 0:x.data)&&(T=h.data.data),n(T)}catch(h){console.error("Failed to fetch suppliers:",h)}},[]);o.useEffect(()=>{v(),V()},[]);const le=os(y,300);o.useEffect(()=>{le!==void 0&&v()},[le]);const fe=t=>{if(t.target.checked){const x=Array.isArray(l)?l:[];g(x.map(h=>h.deal_id))}else g([])},xe=t=>{g(x=>x.includes(t)?x.filter(h=>h!==t):[...x,t])},ke=async()=>{if(r.length){D(!0);try{const t=await L.post("/products/bulk-analyze",{deal_ids:r});$(`Queued ${t.data.queued} products for analysis`,"success"),g([]),v()}catch(t){ss(t,$)}finally{D(!1)}}},_e=async t=>{if(r.length)try{await L.post("/products/bulk-stage",{deal_ids:r,stage:t}),g([]),v()}catch(x){ss(x,$)}},$e=t=>{v(!0),$(`Upload complete! ${(t==null?void 0:t.products_created)||0} products created.`,"success")},Te=async()=>{var t,x;if(!se("export_data")){f("export_data");return}try{const h=y?`?stage=${y}`:"",w=(await L.get(`/products/export${h}`)).data.rows||[];if(!w.length)return;const Y=Object.keys(w[0]),Ke=[Y.join(","),...w.map(ys=>Y.map(vs=>`"${ys[vs]||""}"`).join(","))].join(`
`),K=new Blob([Ke],{type:"text/csv"}),ve=URL.createObjectURL(K),Ee=document.createElement("a");Ee.href=ve,Ee.download=`deals-${y||"all"}-${Date.now()}.csv`,Ee.click()}catch(h){console.error("Export failed:",h),$("Export failed: "+(((x=(t=h.response)==null?void 0:t.data)==null?void 0:x.detail)||h.message),"error")}},Ue=async(t,x)=>{var h,T;try{await L.patch(`/products/deal/${t}`,{moq:x}),m(w=>w.map(Y=>Y.deal_id===t?{...Y,moq:x,total_investment:(Y.buy_cost||0)*x}:Y))}catch(w){console.error("Failed to update MOQ:",w),$("Failed to update MOQ: "+(((T=(h=w.response)==null?void 0:h.data)==null?void 0:T.detail)||w.message),"error")}},Me=async(t,x)=>{var h,T;try{await L.patch(`/products/${t}/asin`,{asin:x}),$("ASIN set successfully. Product is now ready for analysis.","success"),v(!0)}catch(w){console.error("Failed to set ASIN:",w),$("Failed to set ASIN: "+(((T=(h=w.response)==null?void 0:h.data)==null?void 0:T.detail)||w.message),"error")}},Ae=async(t,x)=>{var h,T;try{await L.post(`/products/${t}/select-asin`,{asin:x}),$("ASIN selected and queued for analysis","success"),ie({open:!1,product:null}),v(!0)}catch(w){console.error("Failed to select ASIN:",w),$("Failed to select ASIN: "+(((T=(h=w.response)==null?void 0:h.data)==null?void 0:T.detail)||w.message),"error")}},Re=async()=>{var t,x;if(!(!J.product||J.asinInput.length!==10))try{await L.patch(`/products/${J.product.product_id||J.product.id}/manual-asin`,{asin:J.asinInput.toUpperCase()}),$("ASIN set and queued for analysis","success"),_({open:!1,product:null,asinInput:""}),v(!0)}catch(h){console.error("Failed to set manual ASIN:",h),$("Failed to set ASIN: "+(((x=(t=h.response)==null?void 0:t.data)==null?void 0:x.detail)||h.message),"error")}},b=t=>{N({open:!0,deal:t,deleting:!1})},R=async()=>{var t,x;if(S.deal){N(h=>({...h,deleting:!0}));try{await L.delete(`/products/deal/${S.deal.deal_id}`),$(`Product "${S.deal.asin}" deleted successfully`,"success"),m(h=>h.filter(T=>T.deal_id!==S.deal.deal_id)),g(h=>h.filter(T=>T!==S.deal.deal_id)),setTimeout(()=>v(!0),500),N({open:!1,deal:null,deleting:!1})}catch(h){console.error("Failed to delete product:",h);const T=((x=(t=h.response)==null?void 0:t.data)==null?void 0:x.detail)||h.message||"Failed to delete product";$(T,"error"),N(w=>({...w,deleting:!1}))}}},E=o.useMemo(()=>{let t=l;return z&&(t=t.filter(x=>x.has_promo===!0)),p.pricingStatus&&p.pricingStatus!=="all"&&(t=t.filter(x=>{const h=x.analysis||{},T=h.pricing_status||"complete";return p.pricingStatus==="needs_review"?h.needs_review||T==="no_pricing":T===p.pricingStatus})),t},[l,z,p.pricingStatus]);return e.jsxs(c,{sx:{p:3},children:[e.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(s,{variant:"h4",fontWeight:"700",children:"Products"}),e.jsxs(c,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(is,{analyzeAllPending:!0,buttonText:"Analyze All Pending",onComplete:()=>setTimeout(()=>v(),1e3)}),r.length>0&&e.jsx(is,{productIds:r,buttonText:`Analyze ${r.length} Selected`,onComplete:()=>{g([]),setTimeout(()=>v(),1e3)}}),e.jsx(C,{variant:"outlined",startIcon:e.jsx(et,{size:16}),onClick:()=>H(!0),children:"Upload File"}),e.jsx(C,{variant:"contained",startIcon:e.jsx(rs,{size:16}),onClick:()=>O(!0),children:"Add ASIN"})]})]}),e.jsx(c,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(Os,{value:y||"all",onChange:(t,x)=>M(x==="all"?null:x),children:[e.jsx(ns,{value:"all",label:`All (${a.total||0})`}),it.map(t=>{var x;return e.jsx(ns,{value:t.id,label:`${t.label} (${((x=a.stages)==null?void 0:x[t.id])||0})`,icon:e.jsx(t.icon,{size:14}),iconPosition:"start"},t.id)})]})}),e.jsxs(c,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(re,{size:"small",placeholder:"Search ASIN...",value:p.search,onChange:t=>j({...p,search:t.target.value}),InputProps:{startAdornment:e.jsx(Ve,{position:"start",children:e.jsx(Ns,{size:16})})},sx:{width:200}}),e.jsx(re,{size:"small",placeholder:"Min ROI %",type:"number",value:p.minRoi,onChange:t=>j({...p,minRoi:t.target.value}),onBlur:()=>setTimeout(()=>v(),500),sx:{width:100}}),e.jsx(re,{size:"small",placeholder:"Min Profit $",type:"number",value:p.minProfit,onChange:t=>j({...p,minProfit:t.target.value}),onBlur:()=>setTimeout(()=>v(),500),sx:{width:100}}),e.jsxs(be,{size:"small",sx:{width:150},children:[e.jsx(Ce,{children:"Supplier"}),e.jsxs(we,{value:p.supplier,label:"Supplier",onChange:t=>{j({...p,supplier:t.target.value}),setTimeout(()=>v(),500)},children:[e.jsx(Q,{value:"",children:"All"}),k.map(t=>e.jsx(Q,{value:t.id,children:t.name},t.id))]})]}),e.jsxs(be,{size:"small",sx:{width:180},children:[e.jsx(Ce,{children:"ASIN Status"}),e.jsxs(we,{value:p.asinStatus,label:"ASIN Status",onChange:t=>{j({...p,asinStatus:t.target.value}),setTimeout(()=>v(),500)},children:[e.jsxs(Q,{value:"all",children:["All Products (",U.all||0,")"]}),e.jsxs(Q,{value:"found",children:["ASIN Found (",U.found||0,")"]}),e.jsxs(Q,{value:"multiple_found",children:["Needs Selection (",U.multiple_found||0,")"]}),e.jsxs(Q,{value:"not_found",children:["Needs ASIN (",U.not_found||0,")"]}),e.jsxs(Q,{value:"manual",children:["Manual Entry (",U.manual||0,")"]})]})]}),e.jsxs(be,{size:"small",sx:{width:150},children:[e.jsx(Ce,{children:"Pricing Status"}),e.jsxs(we,{value:p.pricingStatus,label:"Pricing Status",onChange:t=>{j({...p,pricingStatus:t.target.value})},children:[e.jsx(Q,{value:"all",children:"All"}),e.jsx(Q,{value:"complete",children:"Has Pricing"}),e.jsx(Q,{value:"no_pricing",children:"No Pricing"}),e.jsx(Q,{value:"manual",children:"Manual Price"}),e.jsx(Q,{value:"needs_review",children:"Needs Review"})]})]}),e.jsx(Oe,{control:e.jsx(Ie,{checked:z,onChange:t=>q(t.target.checked)}),label:"Has Promo Deal"}),e.jsx(c,{sx:{flex:1}}),r.length>0&&e.jsxs(c,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsxs(s,{variant:"body2",color:"text.secondary",children:[r.length," selected"]}),e.jsx(C,{size:"small",variant:"contained",startIcon:A?e.jsx(ue,{size:14}):e.jsx($s,{size:14}),onClick:ke,disabled:A,children:"Analyze"}),e.jsx(C,{size:"small",variant:"outlined",onClick:()=>_e("buy_list"),children:"Move to Buy List"}),e.jsx(C,{size:"small",variant:"outlined",color:"error",onClick:()=>g([]),children:e.jsx(Ts,{size:14})})]}),e.jsx(ze,{title:"Refresh products (clears cache)",children:e.jsx(Se,{onClick:()=>{v(!0),$("Refreshing products...","info")},children:e.jsx(Vs,{size:18})})}),e.jsx(Se,{onClick:Te,disabled:!se("export_data"),title:se("export_data")?"Export data":"Export requires Starter or higher",children:e.jsx(Xs,{size:18})})]}),I?e.jsx(c,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(ue,{})}):E.length===0?e.jsxs(he,{sx:{p:4,textAlign:"center"},children:[e.jsx(xs,{size:48,color:X.gray[400]}),e.jsx(s,{variant:"h6",sx:{mt:2},children:"No deals found"}),e.jsx(s,{color:"text.secondary",sx:{mb:2},children:"Upload a CSV or Excel file or add ASINs manually to get started"}),e.jsx(C,{variant:"contained",startIcon:e.jsx(rs,{size:16}),onClick:()=>O(!0),children:"Add Your First ASIN"})]}):e.jsxs(he,{children:[e.jsxs(c,{sx:{display:{xs:"none",md:"grid"},gridTemplateColumns:"40px 140px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.paper"},children:[e.jsx(Ie,{size:"small",checked:r.length===E.length&&E.length>0,indeterminate:r.length>0&&r.length<E.length,onChange:fe}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"ASIN"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"Product"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"Supplier"}),e.jsx(s,{variant:"caption",color:"text.secondary",align:"right",children:"MOQ"}),e.jsx(s,{variant:"caption",color:"text.secondary",align:"right",children:"Unit $"}),e.jsx(s,{variant:"caption",color:"text.secondary",align:"right",children:"Total $"}),e.jsx(s,{variant:"caption",color:"text.secondary",align:"right",children:"ROI"}),e.jsx(s,{variant:"caption",color:"text.secondary",align:"right",children:"Profit"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"Stage"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"Actions"})]}),e.jsx(c,{sx:{display:{xs:"none",md:"block"}},children:E.map(t=>e.jsx(fs,{deal:t,selected:r.includes(t.deal_id),onSelect:()=>xe(t.deal_id),onClick:()=>i(`/deals/${t.deal_id}`),onUpdateMoq:Ue,onDelete:b,onSetAsin:Me,onSelectAsin:x=>ie({open:!0,product:x}),onEnterAsin:x=>_({open:!0,product:x,asinInput:""}),onOpenManualPrice:(x,h)=>ce({open:!0,deal:x,analysis:h}),analysis:t.analysis},t.deal_id))}),e.jsx(c,{sx:{display:{xs:"flex",md:"none"},flexDirection:"column",gap:2,p:2},children:E.map(t=>e.jsxs(he,{sx:{p:2,border:r.includes(t.deal_id)?`2px solid ${X.purple.main}`:"1px solid",borderColor:r.includes(t.deal_id)?X.purple.main:"divider",cursor:"pointer"},onClick:()=>i(`/deals/${t.deal_id}`),children:[e.jsxs(c,{display:"flex",justifyContent:"space-between",alignItems:"start",mb:2,children:[e.jsxs(c,{display:"flex",gap:2,flex:1,children:[t.image_url&&e.jsx(c,{component:"img",src:t.image_url,sx:{width:64,height:64,borderRadius:1,objectFit:"cover"}}),e.jsxs(c,{flex:1,children:[e.jsx(s,{variant:"body2",fontWeight:600,mb:.5,children:t.title||(t.roi===void 0&&t.profit===void 0?"Pending analysis...":"Unknown Product")}),e.jsx(s,{variant:"caption",fontFamily:"monospace",color:"text.secondary",children:t.asin})]})]}),e.jsx(Ie,{size:"small",checked:r.includes(t.deal_id),onClick:x=>{x.stopPropagation(),xe(t.deal_id)}})]}),e.jsxs(c,{display:"flex",justifyContent:"space-between",gap:2,flexWrap:"wrap",children:[e.jsxs(c,{children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"ROI"}),e.jsx(s,{variant:"body2",fontWeight:600,color:t.roi>=30?"success.main":"text.primary",children:t.roi?`${t.roi.toFixed(0)}%`:"-"})]}),e.jsxs(c,{children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Profit"}),e.jsxs(s,{variant:"body2",fontWeight:600,color:t.profit>0?"success.main":"error.main",children:["$",t.profit?t.profit.toFixed(2):"-"]})]}),e.jsxs(c,{children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Cost"}),e.jsxs(s,{variant:"body2",children:["$",(t.buy_cost||0).toFixed(2)]})]}),e.jsx(de,{label:t.stage||"new",size:"small",sx:{height:22,fontSize:11}})]})]},t.deal_id))})]}),e.jsx(ot,{open:W,onClose:()=>O(!1),onAdded:()=>{O(!1),v()},suppliers:k}),e.jsx(rt,{open:Z,onClose:()=>H(!1),onComplete:$e}),e.jsx(at,{open:ee.open,onClose:()=>ce({open:!1,deal:null,analysis:null}),deal:ee.deal,analysis:ee.analysis,onSave:()=>{v(!0)}}),e.jsxs(me,{open:ne.open,onClose:()=>ie({open:!1,product:null}),maxWidth:"md",fullWidth:!0,children:[e.jsx(ge,{children:"Choose the Correct ASIN"}),e.jsx(pe,{children:ne.product&&e.jsxs(e.Fragment,{children:[e.jsxs(oe,{severity:"info",sx:{mb:2},children:["Multiple products found for UPC ",e.jsx("strong",{children:ne.product.upc}),". Select the one that matches your supplier's product."]}),e.jsx(c,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:2,mt:2},children:(te=ne.product.potential_asins)==null?void 0:te.map(t=>e.jsxs(he,{sx:{cursor:"pointer","&:hover":{boxShadow:6},border:"2px solid transparent",transition:"all 0.2s"},onClick:()=>Ae(ne.product.product_id||ne.product.id,t.asin),children:[t.image&&e.jsx(c,{component:"img",src:t.image,alt:t.title,sx:{width:"100%",height:200,objectFit:"contain",p:2,bgcolor:"background.default"}}),e.jsxs(pe,{children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:t.title||"Unknown Product"}),e.jsxs(s,{variant:"body2",color:"text.secondary",fontFamily:"monospace",children:["ASIN: ",t.asin]}),t.brand&&e.jsxs(s,{variant:"body2",color:"text.secondary",children:["Brand: ",t.brand]}),t.category&&e.jsxs(s,{variant:"caption",color:"text.secondary",children:["Category: ",t.category]}),e.jsx(C,{variant:"contained",fullWidth:!0,sx:{mt:2},onClick:x=>{x.stopPropagation(),Ae(ne.product.product_id||ne.product.id,t.asin)},children:"Select This One"})]})]},t.asin))})]})}),e.jsx(je,{children:e.jsx(C,{onClick:()=>ie({open:!1,product:null}),children:"Cancel"})})]}),e.jsxs(me,{open:J.open,onClose:()=>_({open:!1,product:null,asinInput:""}),children:[e.jsx(ge,{children:"Enter ASIN Manually"}),e.jsx(pe,{children:J.product&&e.jsxs(e.Fragment,{children:[e.jsxs(oe,{severity:"info",sx:{mb:2},children:["No ASIN found for UPC ",e.jsx("strong",{children:J.product.upc}),". Please enter the Amazon ASIN manually."]}),e.jsx(re,{autoFocus:!0,margin:"dense",label:"ASIN (10 characters)",type:"text",fullWidth:!0,value:J.asinInput,onChange:t=>_({...J,asinInput:t.target.value.toUpperCase().slice(0,10)}),inputProps:{maxLength:10,style:{fontFamily:"monospace",fontSize:14}},helperText:"Example: B07VRZ8TK3"})]})}),e.jsxs(je,{children:[e.jsx(C,{onClick:()=>_({open:!1,product:null,asinInput:""}),children:"Cancel"}),e.jsx(C,{onClick:Re,variant:"contained",disabled:J.asinInput.length!==10,children:"Save ASIN"})]})]}),e.jsxs(me,{open:S.open,onClose:()=>!S.deleting&&N({open:!1,deal:null,deleting:!1}),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ge,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ds,{size:24,style:{color:X.warning.main}}),"Delete Product"]}),e.jsxs(pe,{children:[e.jsx(oe,{severity:"warning",sx:{mb:2},children:"This action cannot be undone. All analysis data, pricing history, and related information will be permanently lost."}),S.deal&&e.jsxs(c,{children:[e.jsx(s,{variant:"body1",fontWeight:600,gutterBottom:!0,children:"Are you sure you want to delete this product?"}),e.jsxs(c,{sx:{mt:2,p:2,bgcolor:"background.default",borderRadius:1},children:[e.jsx(s,{variant:"body2",color:"text.secondary",children:"ASIN:"}),e.jsx(s,{variant:"body2",fontFamily:"monospace",fontWeight:600,children:S.deal.asin}),S.deal.title&&e.jsxs(e.Fragment,{children:[e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Product:"}),e.jsx(s,{variant:"body2",children:S.deal.title})]}),(S.deal.roi!==void 0||S.deal.profit!==void 0)&&e.jsxs(e.Fragment,{children:[e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Analysis Data:"}),e.jsxs(s,{variant:"body2",children:[S.deal.roi!==void 0&&`ROI: ${(Pe=S.deal.roi)==null?void 0:Pe.toFixed(0)}%`,S.deal.roi!==void 0&&S.deal.profit!==void 0&&" | ",S.deal.profit!==void 0&&`Profit: $${(ye=S.deal.profit)==null?void 0:ye.toFixed(2)}`]})]})]}),e.jsx(s,{variant:"body2",color:"error.main",sx:{mt:2,fontWeight:600},children:"⚠️ All analysis data, profit calculations, and product history will be permanently deleted."})]})]}),e.jsxs(je,{children:[e.jsx(C,{onClick:()=>N({open:!1,deal:null,deleting:!1}),disabled:S.deleting,children:"Cancel"}),e.jsx(C,{onClick:R,variant:"contained",color:"error",disabled:S.deleting,startIcon:S.deleting?e.jsx(ue,{size:16}):e.jsx(hs,{size:16}),children:S.deleting?"Deleting...":"Delete Product"})]})]})]})}function ot({open:i,onClose:u,onAdded:l,suppliers:m}){const[a,d]=o.useState({asin:"",upc:"",identifier_type:"asin",buy_cost:"",is_pack:!1,pack_size:1,wholesale_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),[I,F]=o.useState(!1),{showToast:y}=Ne(),M=async()=>{var p,j;if(!(a.identifier_type==="asin"?a.asin:a.upc)){y("Please enter ASIN or UPC","error");return}const g=a.is_pack?parseFloat(a.wholesale_cost)/a.pack_size:parseFloat(a.buy_cost);if(!g||g<=0){y("Please enter a valid cost","error");return}F(!0);try{await L.post("/products",{asin:a.identifier_type==="asin"?a.asin:null,upc:a.identifier_type==="upc"?a.upc:null,identifier_type:a.identifier_type,buy_cost:g||null,pack_size:a.is_pack?a.pack_size:1,wholesale_cost:a.is_pack?parseFloat(a.wholesale_cost):null,supplier_id:a.supplier_id||null,supplier_name:a.supplier_name||null,moq:parseInt(a.moq)||1,notes:a.notes}),d({asin:"",upc:"",identifier_type:"asin",buy_cost:"",is_pack:!1,pack_size:1,wholesale_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),l()}catch(z){y(((j=(p=z.response)==null?void 0:p.data)==null?void 0:j.detail)||"Failed to add product","error")}finally{F(!1)}};return e.jsxs(me,{open:i,onClose:u,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ge,{children:"Add Product"}),e.jsx(pe,{children:e.jsxs(c,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(c,{sx:{mb:1},children:e.jsx(be,{component:"fieldset",children:e.jsxs(qs,{row:!0,value:a.identifier_type,onChange:r=>d({...a,identifier_type:r.target.value,asin:"",upc:""}),children:[e.jsx(Oe,{value:"asin",control:e.jsx(ts,{}),label:"ASIN"}),e.jsx(Oe,{value:"upc",control:e.jsx(ts,{}),label:"UPC"})]})})}),e.jsx(re,{label:a.identifier_type==="asin"?"ASIN":"UPC",value:a.identifier_type==="asin"?a.asin:a.upc,onChange:r=>d({...a,[a.identifier_type]:a.identifier_type==="asin"?r.target.value.toUpperCase():r.target.value.replace(/[^0-9]/g,"").slice(0,14)}),placeholder:a.identifier_type==="asin"?"B08VBVBS7N":"888003659162",required:!0,fullWidth:!0}),e.jsx(Oe,{control:e.jsx(Ie,{checked:a.is_pack,onChange:r=>d({...a,is_pack:r.target.checked,pack_size:r.target.checked?a.pack_size:1,wholesale_cost:r.target.checked?a.wholesale_cost:""})}),label:"This is a case/pack (multiple units)",sx:{display:"block"}}),a.is_pack?e.jsxs(c,{sx:{p:2,bgcolor:"grey.100",borderRadius:1},children:[e.jsx(s,{variant:"subtitle2",gutterBottom:!0,children:"Case Pricing"}),e.jsxs(c,{display:"flex",gap:2,children:[e.jsx(re,{label:"Pack Size",type:"number",value:a.pack_size,onChange:r=>d({...a,pack_size:Math.max(1,parseInt(r.target.value)||1)}),sx:{width:140},helperText:"Units per case",inputProps:{min:1}}),e.jsx(re,{label:"Case Cost",type:"number",step:"0.01",value:a.wholesale_cost,onChange:r=>d({...a,wholesale_cost:r.target.value}),fullWidth:!0,InputProps:{startAdornment:e.jsx(Ve,{position:"start",children:"$"})},helperText:"Cost for entire case"})]}),a.wholesale_cost&&a.pack_size>0&&e.jsxs(oe,{severity:"success",sx:{mt:2},children:[e.jsxs("strong",{children:["$",(parseFloat(a.wholesale_cost)/a.pack_size).toFixed(4)]})," per unit"]})]}):e.jsx(re,{label:"Unit Cost",type:"number",step:"0.01",value:a.buy_cost,onChange:r=>d({...a,buy_cost:r.target.value}),fullWidth:!0,InputProps:{startAdornment:e.jsx(Ve,{position:"start",children:"$"})},helperText:"Cost per single unit"}),e.jsxs(be,{children:[e.jsx(Ce,{children:"Supplier"}),e.jsxs(we,{value:a.supplier_id,label:"Supplier",onChange:r=>d({...a,supplier_id:r.target.value,supplier_name:""}),children:[e.jsx(Q,{value:"",children:"Select existing..."}),m.map(r=>e.jsx(Q,{value:r.id,children:r.name},r.id))]})]}),e.jsx(re,{label:"Or New Supplier Name",value:a.supplier_name,onChange:r=>d({...a,supplier_name:r.target.value,supplier_id:""}),placeholder:"Enter new supplier name"}),e.jsx(re,{label:"MOQ",type:"number",value:a.moq,onChange:r=>d({...a,moq:r.target.value})}),e.jsx(re,{label:"Notes",multiline:!0,rows:2,value:a.notes,onChange:r=>d({...a,notes:r.target.value})})]})}),e.jsxs(je,{children:[e.jsx(C,{onClick:u,children:"Cancel"}),e.jsx(C,{variant:"contained",onClick:M,disabled:I||!(a.identifier_type==="asin"?a.asin:a.upc)||!a.buy_cost&&!a.wholesale_cost,children:I?e.jsx(ue,{size:20}):"Add Product"})]})]})}export{wt as default};

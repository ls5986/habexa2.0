import{t as Be,v as We,r as i,w as qe,_ as Le,j as e,y as Oe,x as Ve,z as Je,E as He,T as n,c as fe,a3 as se,o as P,X as re,Y as ae,I as ee,$ as ne,B as o,O as Z,a as v,a4 as ke,a5 as he,a6 as me,p as G,K as ze,a7 as le,a8 as ie,a9 as oe,aa as K,q as J,a0 as Qe,ab as ce,D as Ge,k as Ie,u as Ke,h as V,P as Pe,e as Xe,M as Ye,S as Ze,Z as es,ac as ss,C as xe,R as ts,d as ge,J as rs}from"./index-iiuQpHm4.js";import{C as Fe}from"./Collapse-TdTA9cM9.js";import{D as de,P as ve}from"./plus-BCMXk6dC.js";import{S as as}from"./SupplierFormModal-B0gKh75v.js";import{h as Se}from"./errorHandler-l0UVzPhu.js";import{T as ns,a as Ce}from"./Tabs-Ct7BY6q0.js";import{C as ls}from"./clock-Buz3XdbZ.js";import{I as Te}from"./InputAdornment-Db7rGxuS.js";import{R as is}from"./refresh-cw-AFREdOkb.js";import{C as je}from"./Checkbox-CENAIUVG.js";import{E as os}from"./external-link-CvsoqFPL.js";import"./SwitchBase-Drs9y3oo.js";function cs(c){return Be("MuiAlertTitle",c)}We("MuiAlertTitle",["root"]);const ds=["className"],ps=c=>{const{classes:h}=c;return He({root:["root"]},cs,h)},us=Oe(n,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(c,h)=>h.root})(({theme:c})=>({fontWeight:c.typography.fontWeightMedium,marginTop:-2})),te=i.forwardRef(function(h,p){const w=qe({props:h,name:"MuiAlertTitle"}),{className:d}=w,m=Le(w,ds),y=w,S=ps(y);return e.jsx(us,Ve({gutterBottom:!0,component:"div",ownerState:y,ref:p,className:Je(S.root,d)},m))});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=fe("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=fe("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=fe("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),$e=se(e.jsx("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),ye=se(e.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),Ee=se(e.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),Me=se(e.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),gs=se(e.jsx("path",{d:"M8 5v14l11-7z"}),"PlayArrow"),we=se(e.jsx("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"}),"Upload");function js({open:c,onClose:h,onComplete:p}){var b,I,j,O,D,R;const[w,d]=i.useState([]),[m,y]=i.useState(""),[S,g]=i.useState(""),[F,t]=i.useState(!1),[f,u]=i.useState(!1),[C,T]=i.useState(null),[$,A]=i.useState(null),[l,E]=i.useState(null),[M,B]=i.useState(!1),[W,k]=i.useState(null),[L,q]=i.useState(!1);i.useEffect(()=>{c&&(z(),_())},[c]),i.useEffect(()=>{if(!$)return;const s=setInterval(async()=>{try{const r=await P.get(`/jobs/${$}`);E(r.data),(r.data.status==="completed"||r.data.status==="failed")&&(clearInterval(s),B(!1),r.data.status==="completed"&&p&&setTimeout(()=>{p(r.data.result)},500))}catch(r){console.error("Error polling job:",r),clearInterval(s),B(!1)}},2e3);return()=>clearInterval(s)},[$,p]);const z=async()=>{try{const s=await P.get("/suppliers");d(s.data.suppliers||s.data||[])}catch(s){console.error("Error fetching suppliers:",s)}},_=()=>{y(""),g(""),t(!1),T(null),A(null),E(null),B(!1),k(null),q(!1)},X=async()=>{var s,r;if(S.trim()){u(!0);try{const x=(await P.post("/suppliers",{name:S.trim()})).data;d([...w,x]),y(x.id),t(!1),g("")}catch(a){k(((r=(s=a.response)==null?void 0:s.data)==null?void 0:r.detail)||"Failed to create supplier")}finally{u(!1)}}},Y=s=>{var x;const r=(x=s.target.files)==null?void 0:x[0];if(!r)return;const a=r.name.toLowerCase().slice(r.name.lastIndexOf("."));if(![".csv",".xlsx",".xls"].includes(a)){k("Please upload a .csv or .xlsx file");return}T(r),k(null)},H=async()=>{var s,r;if(!C||!m){k("Please select a supplier and file");return}B(!0),k(null);try{const a=new FormData;a.append("file",C),a.append("supplier_id",m);const x=await P.post("/products/upload",a,{headers:{"Content-Type":"multipart/form-data"}});A(x.data.job_id)}catch(a){k(((r=(s=a.response)==null?void 0:s.data)==null?void 0:r.detail)||"Upload failed"),B(!1)}},Q=((b=w.find(s=>s.id===m))==null?void 0:b.name)||"";return e.jsxs(re,{open:c,onClose:h,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ae,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:["Upload Price List",e.jsx(ee,{onClick:h,size:"small",children:e.jsx(ye,{fontSize:"small"})})]}),e.jsxs(ne,{children:[(l==null?void 0:l.status)==="completed"&&e.jsx(o,{children:e.jsxs(Z,{severity:"success",sx:{mb:2},children:[e.jsx(te,{children:"Upload Complete"}),e.jsxs(n,{variant:"body2",sx:{mt:1},children:["Supplier: ",e.jsx("strong",{children:(I=l.result)==null?void 0:I.supplier_name})]}),e.jsxs(n,{variant:"body2",children:["Products created: ",e.jsx("strong",{children:((j=l.result)==null?void 0:j.products_created)||0})]}),e.jsxs(n,{variant:"body2",children:["Deals processed: ",e.jsx("strong",{children:((O=l.result)==null?void 0:O.deals_processed)||0})]}),((R=(D=l.result)==null?void 0:D.errors)==null?void 0:R.length)>0&&e.jsxs(o,{sx:{mt:2},children:[e.jsxs(v,{size:"small",onClick:()=>q(!L),endIcon:L?e.jsx(Ee,{}):e.jsx(Me,{}),children:[l.result.errors.length," errors"]}),e.jsx(Fe,{in:L,children:e.jsx(ke,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:l.result.errors.map((s,r)=>e.jsx(he,{children:e.jsx(me,{primary:s,primaryTypographyProps:{variant:"caption"}})},r))})})]})]})}),(l==null?void 0:l.status)==="failed"&&e.jsxs(Z,{severity:"error",sx:{mb:2},children:[e.jsx(te,{children:"Upload Failed"}),e.jsx(n,{variant:"body2",children:l.error})]}),((l==null?void 0:l.status)==="processing"||(l==null?void 0:l.status)==="pending"||(l==null?void 0:l.status)==="parsing")&&e.jsxs(o,{sx:{mb:2},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(G,{size:20}),e.jsx(n,{variant:"body1",children:l.status==="parsing"?"Parsing file...":`Processing for ${Q}...`})]}),e.jsx(ze,{variant:"determinate",value:l.progress||0,sx:{mb:1,height:8,borderRadius:1}}),e.jsxs(n,{variant:"caption",color:"text.secondary",children:[l.processed_items||0," / ",l.total_items||"?"," rows"]})]}),!l&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{sx:{mb:3},children:[e.jsxs(le,{fullWidth:!0,sx:{mb:2},children:[e.jsx(ie,{children:"Supplier *"}),e.jsxs(oe,{value:m,label:"Supplier *",onChange:s=>y(s.target.value),children:[e.jsx(K,{value:"",children:"Select supplier..."}),w.map(s=>e.jsx(K,{value:s.id,children:s.name},s.id))]})]}),F?e.jsxs(o,{sx:{display:"flex",gap:1},children:[e.jsx(J,{fullWidth:!0,size:"small",label:"New supplier name",value:S,onChange:s=>g(s.target.value),onKeyDown:s=>s.key==="Enter"&&X(),autoFocus:!0}),e.jsx(v,{variant:"contained",size:"small",onClick:X,disabled:f||!S.trim(),children:f?e.jsx(G,{size:16}):"Add"}),e.jsx(ee,{size:"small",onClick:()=>{t(!1),g("")},children:e.jsx(ye,{fontSize:"small"})})]}):e.jsx(v,{variant:"outlined",size:"small",startIcon:e.jsx($e,{}),onClick:()=>t(!0),fullWidth:!0,children:"Add New Supplier"})]}),e.jsxs(o,{sx:{mb:2},children:[e.jsx("input",{type:"file",id:"file-upload",hidden:!0,accept:".csv,.xlsx,.xls",onChange:Y}),e.jsx("label",{htmlFor:"file-upload",children:e.jsx(o,{sx:{border:"2px dashed",borderColor:C?"primary.main":"divider",borderRadius:2,p:4,textAlign:"center",cursor:"pointer",bgcolor:C?"primary.50":"background.paper","&:hover":{borderColor:"primary.main",bgcolor:"action.hover"}},children:C?e.jsxs(o,{children:[e.jsx(n,{variant:"body1",fontWeight:"600",children:C.name}),e.jsxs(n,{variant:"caption",color:"text.secondary",children:[(C.size/1024).toFixed(1)," KB"]}),e.jsx(n,{variant:"caption",color:"primary",sx:{display:"block",mt:1},children:"Click to change"})]}):e.jsxs(o,{children:[e.jsx(we,{sx:{fontSize:32,color:"text.secondary",mb:1}}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Drop CSV or Excel file here"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:".csv, .xlsx, .xls"})]})})})]}),W&&e.jsx(Z,{severity:"error",sx:{mb:2},children:W}),e.jsx(n,{variant:"caption",color:"text.secondary",sx:{display:"block",textAlign:"center"},children:"All products in this file will be assigned to the selected supplier"})]})]}),e.jsx(de,{children:(l==null?void 0:l.status)==="completed"?e.jsxs(e.Fragment,{children:[e.jsx(v,{onClick:_,children:"Upload Another"}),e.jsx(v,{variant:"contained",onClick:h,children:"Done"})]}):(l==null?void 0:l.status)==="failed"?e.jsx(v,{onClick:_,children:"Try Again"}):e.jsxs(e.Fragment,{children:[e.jsx(v,{onClick:h,children:"Cancel"}),e.jsx(v,{variant:"contained",onClick:H,disabled:!C||!m||M,startIcon:M?null:e.jsx(we,{}),children:M?e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(G,{size:16}),"Starting..."]}):`Upload to ${Q||"Supplier"}`})]})})]})}function ys({open:c,onClose:h,productsWithoutSuppliers:p=[],groupedByFile:w={},productCount:d=0,onConfirm:m}){const{suppliers:y,loading:S,refetch:g}=Qe(),{showToast:F}=ce(),[t,f]=i.useState(""),[u,C]=i.useState(!1),[T,$]=i.useState(!1);i.useEffect(()=>{c&&y.length>0&&!t&&f(y[0].id)},[c,y,t]);const A=async()=>{var l,E,M,B,W;if(!t){F("Please select a supplier","error");return}$(!0);try{const k=p.map(z=>(z==null?void 0:z.id)||(z==null?void 0:z.product_id)).filter(z=>z&&!z.toString().startsWith("placeholder-"));if(k.length===0){const _=(await P.post("/products/assign-supplier",{supplier_id:t,assign_all_pending:!0})).data.total||p.length;F(`Assigned supplier to ${_} products`,"success"),setTimeout(()=>{m(t),h()},1e3);return}const q=(await P.post("/products/assign-supplier",{product_ids:k,supplier_id:t})).data.total;F(`Assigned supplier to ${q} products`,"success"),setTimeout(()=>{m(t),h()},1e3)}catch(k){console.error("Failed to assign suppliers:",k);const L=((M=(E=(l=k.response)==null?void 0:l.data)==null?void 0:E.detail)==null?void 0:M.message)||((W=(B=k.response)==null?void 0:B.data)==null?void 0:W.detail)||"Failed to assign suppliers";F(L,"error")}finally{$(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(re,{open:c,onClose:h,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ae,{children:e.jsx(n,{variant:"h6",fontWeight:600,children:"Select Supplier for Analysis"})}),e.jsxs(ne,{children:[e.jsxs(Z,{severity:"warning",sx:{mb:3},children:[e.jsxs(n,{variant:"body2",fontWeight:600,gutterBottom:!0,children:[d||p.length," product",(d||p.length)!==1?"s":""," ",(d||p.length)===1?"has":"have"," no supplier assigned."]}),e.jsx(n,{variant:"body2",children:"Analysis requires a supplier to track where products come from. Please select a supplier to assign to these products."})]}),e.jsx(o,{sx:{mb:2},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ie,{children:"Supplier"}),e.jsx(oe,{value:t,onChange:l=>f(l.target.value),label:"Supplier",disabled:T||S,children:y.map(l=>e.jsx(K,{value:l.id,children:l.name},l.id))})]})}),e.jsx(o,{sx:{display:"flex",justifyContent:"center",mb:2},children:e.jsx(v,{startIcon:e.jsx($e,{}),onClick:()=>C(!0),variant:"outlined",size:"small",children:"Create New Supplier"})}),e.jsx(Ge,{sx:{my:2}}),Object.keys(w).length>0?e.jsxs(o,{sx:{mb:2},children:[e.jsx(n,{variant:"body2",fontWeight:600,gutterBottom:!0,children:"Products grouped by file:"}),Object.entries(w).map(([l,E])=>e.jsxs(o,{sx:{mb:1,p:1,bgcolor:"action.hover",borderRadius:1},children:[e.jsxs(n,{variant:"caption",fontWeight:600,display:"block",children:[l,": ",E.length," product",E.length!==1?"s":""]}),e.jsxs(n,{variant:"caption",color:"text.secondary",children:[E.slice(0,5).map(M=>M.asin).join(", "),E.length>5&&` ... and ${E.length-5} more`]})]},l))]}):p.length>0&&e.jsxs(n,{variant:"caption",color:"text.secondary",children:["Products: ",p.slice(0,10).map(l=>l.asin).join(", "),p.length>10&&` ... and ${p.length-10} more`]})]}),e.jsxs(de,{children:[e.jsx(v,{onClick:h,disabled:T,children:"Cancel"}),e.jsx(v,{onClick:A,variant:"contained",disabled:!t||T,children:T?"Assigning...":`Assign to ${d||p.length} Product${(d||p.length)!==1?"s":""}`})]})]}),e.jsx(as,{open:u,onClose:async()=>{C(!1),g&&await g()},supplier:null})]})}function _e({productIds:c=null,analyzeAllPending:h=!1,onComplete:p=null,buttonText:w="Analyze All",className:d=""}){const{hasFeature:m,promptUpgrade:y}=Ie(),{showToast:S}=ce(),[g,F]=i.useState(null),[t,f]=i.useState(null),[u,C]=i.useState(!1),[T,$]=i.useState(!1),[A,l]=i.useState(!1),[E,M]=i.useState(!1),[B,W]=i.useState([]),[k,L]=i.useState({}),[q,z]=i.useState(0);i.useEffect(()=>{if(!g)return;const b=setInterval(async()=>{var I;try{const j=await P.get(`/jobs/${g}`);f(j.data),(j.data.status==="completed"||j.data.status==="failed"||j.data.status==="cancelled")&&(clearInterval(b),j.data.status==="completed"&&p&&p(j.data))}catch(j){console.error("Error polling job:",j),((I=j.response)==null?void 0:I.status)===404&&clearInterval(b)}},2e3);return()=>clearInterval(b)},[g,p]);const _=async()=>{var b,I,j,O,D,R;if(!m("bulk_analyze")){y("bulk_analyze");return}C(!0);try{const s={};c?s.product_ids=c:h&&(s.analyze_all_pending=!0);const r=await P.post("/batch/analyze",s);F(r.data.job_id),f({status:"pending",total_items:r.data.total,progress:0}),$(!0)}catch(s){console.error("Error starting batch:",s),console.error("Error response:",(b=s.response)==null?void 0:b.data),console.error("Error response detail:",(j=(I=s.response)==null?void 0:I.data)==null?void 0:j.detail);const r=(D=(O=s.response)==null?void 0:O.data)==null?void 0:D.detail;let a=r;if(typeof r=="string")try{a=JSON.parse(r)}catch{a={message:r}}if(console.log("Parsed error object:",a),a&&typeof a=="object"&&a.error==="products_missing_suppliers"){console.log("Products without suppliers:",a.products),console.log("Grouped by file:",a.grouped_by_file),console.log("Count:",a.count);const x=a.count||((R=a.products)==null?void 0:R.length)||0,N=a.products||[];z(x);let U=N;x>0&&N.length===0&&(U=Array(Math.min(x,100)).fill(null).map((be,pe)=>({id:`placeholder-${pe}`,asin:"...",title:"Product details loading..."}))),W(U),L(a.grouped_by_file||{}),M(!0)}else{const x=(a==null?void 0:a.message)||(r==null?void 0:r.message)||(typeof r=="string"?r:JSON.stringify(r))||"Failed to start analysis";console.error("Showing error toast:",x),S(x,"error")}}finally{C(!1)}},X=async b=>{M(!1),W([]),setTimeout(()=>{_()},2e3)},Y=async()=>{var b,I;if(g)try{await P.post(`/jobs/${g}/cancel`),f(j=>({...j,status:"cancelled"})),setTimeout(()=>{$(!1),H()},1e3)}catch(j){console.error("Error cancelling:",j);const O=((I=(b=j.response)==null?void 0:b.data)==null?void 0:I.detail)||j.message||"Failed to cancel job";S(`Failed to cancel: ${O}`,"error")}},H=()=>{F(null),f(null),$(!1),l(!1)};if(T&&t){const b=t.status==="processing"||t.status==="pending",I=t.status==="completed",j=t.status==="failed",O=t.status==="cancelled",D=t.errors||[],R=b&&t.processed_items>0?Math.ceil((t.total_items-t.processed_items)/5):0;return e.jsxs(re,{open:T,onClose:b?void 0:H,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ae,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(n,{variant:"h6",children:[b&&"Analyzing Products...",I&&"Analysis Complete",j&&"Analysis Failed",O&&"Analysis Cancelled"]}),!b&&e.jsx(ee,{onClick:H,size:"small",children:e.jsx(ye,{})})]}),e.jsxs(ne,{children:[e.jsxs(o,{sx:{mb:2},children:[e.jsx(ze,{variant:"determinate",value:t.progress||0,sx:{mb:1,height:8,borderRadius:1},color:I?"success":j?"error":"primary"}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:[t.processed_items||0," / ",t.total_items||0," products"]})]}),e.jsxs(o,{sx:{mb:2},children:[t.success_count>0&&e.jsxs(n,{variant:"body2",color:"success.main",sx:{mb:.5},children:["✓ Success: ",t.success_count]}),t.error_count>0&&e.jsxs(n,{variant:"body2",color:"error.main",sx:{mb:.5},children:["✗ Errors: ",t.error_count]})]}),b&&R>0&&e.jsxs(n,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:2},children:["~",R," seconds remaining"]}),I&&e.jsxs(Z,{severity:"success",sx:{mb:2},children:[e.jsx(te,{children:"Analysis Complete"}),e.jsxs(n,{variant:"body2",children:["Successfully analyzed ",t.success_count," products",t.error_count>0&&", {job.error_count} errors"]})]}),j&&e.jsxs(Z,{severity:"error",sx:{mb:2},children:[e.jsx(te,{children:"Analysis Failed"}),e.jsx(n,{variant:"body2",children:D[0]||"Unknown error"})]}),D.length>0&&e.jsxs(o,{sx:{mt:2},children:[e.jsxs(v,{size:"small",onClick:()=>l(!A),endIcon:A?e.jsx(Ee,{}):e.jsx(Me,{}),children:["View ",D.length," ",D.length===1?"error":"errors"]}),e.jsx(Fe,{in:A,children:e.jsxs(ke,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:[D.slice(0,20).map((s,r)=>e.jsx(he,{children:e.jsx(me,{primary:s,primaryTypographyProps:{variant:"caption"}})},r)),D.length>20&&e.jsx(he,{children:e.jsx(me,{primary:`... and ${D.length-20} more errors`,primaryTypographyProps:{variant:"caption",color:"text.secondary"}})})]})})]})]}),e.jsxs(de,{children:[b&&e.jsx(v,{onClick:Y,color:"error",children:"Cancel"}),!b&&e.jsx(v,{onClick:H,variant:"contained",children:I?"Done":"Close"})]})]})}const Q=m("bulk_analyze");return e.jsxs(e.Fragment,{children:[e.jsx(v,{variant:"contained",onClick:_,disabled:u||!Q,startIcon:u?e.jsx(G,{size:16}):e.jsx(gs,{}),className:d,title:Q?"":"Bulk analysis requires Starter or higher",children:u?"Starting...":w}),e.jsx(ys,{open:E,onClose:()=>{M(!1),W([]),L({})},productsWithoutSuppliers:B,groupedByFile:k,productCount:q,onConfirm:X})]})}const fs=[{id:"new",label:"New",icon:Pe,color:V.purple.main},{id:"analyzing",label:"Analyzing",icon:ls,color:V.warning.main},{id:"reviewed",label:"Reviewed",icon:Xe,color:V.info.main},{id:"buy_list",label:"Buy List",icon:Ye,color:V.success.main},{id:"ordered",label:"Ordered",icon:xs,color:V.gray[400]}];function Ae(c,h){const[p,w]=i.useState(c);return i.useEffect(()=>{const d=setTimeout(()=>{w(c)},h);return()=>{clearTimeout(d)}},[c,h]),p}const De=ts.memo(({deal:c,selected:h,onSelect:p,onClick:w,onUpdateMoq:d})=>{const m=c.roi||0,y=c.profit||0,S=c.moq||1,g=c.buy_cost||0,F=c.total_investment||S*g,t=S*y,[f,u]=i.useState(!1),[C,T]=i.useState(S),$=()=>{d(c.deal_id,C),u(!1)};return e.jsxs(o,{sx:{display:"grid",gridTemplateColumns:"40px 110px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",alignItems:"center","&:hover":{bgcolor:"action.hover"},cursor:"pointer"},onClick:w,children:[e.jsx(je,{size:"small",checked:h,onClick:A=>A.stopPropagation(),onChange:p}),e.jsx(n,{variant:"body2",fontFamily:"monospace",fontSize:12,children:c.asin}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,minWidth:0},children:[c.image_url?e.jsx(o,{component:"img",src:c.image_url,sx:{width:32,height:32,borderRadius:1,objectFit:"cover",flexShrink:0}}):e.jsx(o,{sx:{width:32,height:32,bgcolor:V.navy.light,borderRadius:1}}),e.jsx(n,{variant:"body2",noWrap:!0,sx:{minWidth:0},children:c.title||"Pending analysis..."})]}),e.jsx(n,{variant:"body2",color:"text.secondary",noWrap:!0,children:c.supplier_name||"Unknown"}),e.jsx(o,{sx:{textAlign:"right"},onClick:A=>A.stopPropagation(),children:f?e.jsx(J,{size:"small",type:"number",value:C,onChange:A=>T(parseInt(A.target.value)||1),onBlur:$,onKeyDown:A=>A.key==="Enter"&&$(),autoFocus:!0,sx:{width:50},inputProps:{min:1,style:{textAlign:"right",padding:"4px"}}}):e.jsx(ge,{label:S,size:"small",onClick:()=>u(!0),sx:{minWidth:40,cursor:"pointer",bgcolor:V.gray[300],"&:hover":{bgcolor:V.navy.light}}})}),e.jsxs(n,{variant:"body2",align:"right",color:"text.secondary",children:["$",g.toFixed(2)]}),e.jsxs(n,{variant:"body2",align:"right",fontWeight:"600",color:F>500?"warning.main":"text.primary",children:["$",F.toFixed(2)]}),e.jsx(n,{variant:"body2",align:"right",fontWeight:"600",color:m>=30?"success.main":m>0?"warning.main":"error.main",children:m?`${m.toFixed(0)}%`:"-"}),e.jsx(rs,{title:`Total: $${t.toFixed(2)}`,children:e.jsxs(n,{variant:"body2",align:"right",color:y>0?"success.main":"error.main",children:["$",y?y.toFixed(2):"-"]})}),e.jsx(ge,{label:c.stage||"new",size:"small",sx:{height:22,fontSize:11}}),e.jsx(ee,{size:"small",component:"a",href:`https://amazon.com/dp/${c.asin}`,target:"_blank",onClick:A=>A.stopPropagation(),children:e.jsx(os,{size:14})})]})});De.displayName="DealRow";function $s(){const c=Ke(),h=i.useRef(!1),[p,w]=i.useState([]),[d,m]=i.useState({stages:{},total:0}),[y,S]=i.useState(!0),[g,F]=i.useState(null),[t,f]=i.useState([]),[u,C]=i.useState({minRoi:"",minProfit:"",search:"",supplier:""}),[T,$]=i.useState([]),[A,l]=i.useState(!1),[E,M]=i.useState(!1),[B,W]=i.useState(!1),{hasFeature:k,promptUpgrade:L}=Ie(),{showToast:q}=ce(),z=Ae(u.search,500),_=i.useCallback(async()=>{var s,r;if(!h.current){h.current=!0,S(!0);try{const a=new URLSearchParams;g&&a.append("stage",g),u.minRoi&&a.append("min_roi",u.minRoi),u.minProfit&&a.append("min_profit",u.minProfit),z&&a.append("search",z),u.supplier&&a.append("supplier_id",u.supplier),a.append("limit","100");const[x,N]=await Promise.all([P.get(`/products?${a}`),P.get("/products/stats")]);let U=[];Array.isArray(x.data)?U=x.data:Array.isArray((s=x.data)==null?void 0:s.deals)?U=x.data.deals:Array.isArray((r=x.data)==null?void 0:r.data)&&(U=x.data.data),w(U),m(N.data||{stages:{},total:0})}catch(a){console.error("Failed to fetch:",a)}finally{S(!1),h.current=!1}}},[g,u.minRoi,u.minProfit,z,u.supplier]),X=i.useCallback(async()=>{var s,r;try{const a=await P.get("/suppliers");let x=[];Array.isArray(a.data)?x=a.data:Array.isArray((s=a.data)==null?void 0:s.suppliers)?x=a.data.suppliers:Array.isArray((r=a.data)==null?void 0:r.data)&&(x=a.data.data),$(x)}catch(a){console.error("Failed to fetch suppliers:",a)}},[]);i.useEffect(()=>{_(),X()},[]);const Y=Ae(g,300);i.useEffect(()=>{Y!==void 0&&_()},[Y]);const H=s=>{if(s.target.checked){const r=Array.isArray(p)?p:[];f(r.map(a=>a.deal_id))}else f([])},Q=s=>{f(r=>r.includes(s)?r.filter(a=>a!==s):[...r,s])},b=async()=>{if(t.length){W(!0);try{const s=await P.post("/products/bulk-analyze",{deal_ids:t});q(`Queued ${s.data.queued} products for analysis`,"success"),f([]),_()}catch(s){Se(s,q)}finally{W(!1)}}},I=async s=>{if(t.length)try{await P.post("/products/bulk-stage",{deal_ids:t,stage:s}),f([]),_()}catch(r){Se(r,q)}},j=s=>{setTimeout(()=>{_()},2e3),console.log("Upload complete:",s)},O=async()=>{var s,r;if(!k("export_data")){L("export_data");return}try{const a=g?`?stage=${g}`:"",N=(await P.get(`/products/export${a}`)).data.rows||[];if(!N.length)return;const U=Object.keys(N[0]),be=[U.join(","),...N.map(Ue=>U.map(Ne=>`"${Ue[Ne]||""}"`).join(","))].join(`
`),pe=new Blob([be],{type:"text/csv"}),Re=URL.createObjectURL(pe),ue=document.createElement("a");ue.href=Re,ue.download=`deals-${g||"all"}-${Date.now()}.csv`,ue.click()}catch(a){console.error("Export failed:",a),q("Export failed: "+(((r=(s=a.response)==null?void 0:s.data)==null?void 0:r.detail)||a.message),"error")}},D=async(s,r)=>{var a,x;try{await P.patch(`/products/deal/${s}`,{moq:r}),w(N=>N.map(U=>U.deal_id===s?{...U,moq:r,total_investment:(U.buy_cost||0)*r}:U))}catch(N){console.error("Failed to update MOQ:",N),q("Failed to update MOQ: "+(((x=(a=N.response)==null?void 0:a.data)==null?void 0:x.detail)||N.message),"error")}},R=i.useMemo(()=>p,[p]);return e.jsxs(o,{sx:{p:3},children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(n,{variant:"h4",fontWeight:"700",children:"Products"}),e.jsxs(o,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(_e,{analyzeAllPending:!0,buttonText:"Analyze All Pending",onComplete:()=>setTimeout(()=>_(),1e3)}),t.length>0&&e.jsx(_e,{productIds:t,buttonText:`Analyze ${t.length} Selected`,onComplete:()=>{f([]),setTimeout(()=>_(),1e3)}}),e.jsx(v,{variant:"outlined",startIcon:e.jsx(ms,{size:16}),onClick:()=>M(!0),children:"Upload File"}),e.jsx(v,{variant:"contained",startIcon:e.jsx(ve,{size:16}),onClick:()=>l(!0),children:"Add ASIN"})]})]}),e.jsx(o,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(ns,{value:g||"all",onChange:(s,r)=>F(r==="all"?null:r),children:[e.jsx(Ce,{value:"all",label:`All (${d.total||0})`}),fs.map(s=>{var r;return e.jsx(Ce,{value:s.id,label:`${s.label} (${((r=d.stages)==null?void 0:r[s.id])||0})`,icon:e.jsx(s.icon,{size:14}),iconPosition:"start"},s.id)})]})}),e.jsxs(o,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(J,{size:"small",placeholder:"Search ASIN...",value:u.search,onChange:s=>C({...u,search:s.target.value}),InputProps:{startAdornment:e.jsx(Te,{position:"start",children:e.jsx(Ze,{size:16})})},sx:{width:200}}),e.jsx(J,{size:"small",placeholder:"Min ROI %",type:"number",value:u.minRoi,onChange:s=>C({...u,minRoi:s.target.value}),onBlur:()=>setTimeout(()=>_(),500),sx:{width:100}}),e.jsx(J,{size:"small",placeholder:"Min Profit $",type:"number",value:u.minProfit,onChange:s=>C({...u,minProfit:s.target.value}),onBlur:()=>setTimeout(()=>_(),500),sx:{width:100}}),e.jsxs(le,{size:"small",sx:{width:150},children:[e.jsx(ie,{children:"Supplier"}),e.jsxs(oe,{value:u.supplier,label:"Supplier",onChange:s=>{C({...u,supplier:s.target.value}),setTimeout(()=>_(),500)},children:[e.jsx(K,{value:"",children:"All"}),T.map(s=>e.jsx(K,{value:s.id,children:s.name},s.id))]})]}),e.jsx(o,{sx:{flex:1}}),t.length>0&&e.jsxs(o,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsxs(n,{variant:"body2",color:"text.secondary",children:[t.length," selected"]}),e.jsx(v,{size:"small",variant:"contained",startIcon:B?e.jsx(G,{size:14}):e.jsx(es,{size:14}),onClick:b,disabled:B,children:"Analyze"}),e.jsx(v,{size:"small",variant:"outlined",onClick:()=>I("buy_list"),children:"Move to Buy List"}),e.jsx(v,{size:"small",variant:"outlined",color:"error",onClick:()=>f([]),children:e.jsx(ss,{size:14})})]}),e.jsx(ee,{onClick:_,children:e.jsx(is,{size:18})}),e.jsx(ee,{onClick:O,disabled:!k("export_data"),title:k("export_data")?"Export data":"Export requires Starter or higher",children:e.jsx(hs,{size:18})})]}),y?e.jsx(o,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(G,{})}):R.length===0?e.jsxs(xe,{sx:{p:4,textAlign:"center"},children:[e.jsx(Pe,{size:48,color:V.gray[400]}),e.jsx(n,{variant:"h6",sx:{mt:2},children:"No deals found"}),e.jsx(n,{color:"text.secondary",sx:{mb:2},children:"Upload a CSV or Excel file or add ASINs manually to get started"}),e.jsx(v,{variant:"contained",startIcon:e.jsx(ve,{size:16}),onClick:()=>l(!0),children:"Add Your First ASIN"})]}):e.jsxs(xe,{children:[e.jsxs(o,{sx:{display:{xs:"none",md:"grid"},gridTemplateColumns:"40px 110px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.paper"},children:[e.jsx(je,{size:"small",checked:t.length===R.length&&R.length>0,indeterminate:t.length>0&&t.length<R.length,onChange:H}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"ASIN"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Product"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Supplier"}),e.jsx(n,{variant:"caption",color:"text.secondary",align:"right",children:"MOQ"}),e.jsx(n,{variant:"caption",color:"text.secondary",align:"right",children:"Unit $"}),e.jsx(n,{variant:"caption",color:"text.secondary",align:"right",children:"Total $"}),e.jsx(n,{variant:"caption",color:"text.secondary",align:"right",children:"ROI"}),e.jsx(n,{variant:"caption",color:"text.secondary",align:"right",children:"Profit"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Stage"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:"Actions"})]}),e.jsx(o,{sx:{display:{xs:"none",md:"block"}},children:R.map(s=>e.jsx(De,{deal:s,selected:t.includes(s.deal_id),onSelect:()=>Q(s.deal_id),onClick:()=>c(`/deals/${s.deal_id}`),onUpdateMoq:D},s.deal_id))}),e.jsx(o,{sx:{display:{xs:"flex",md:"none"},flexDirection:"column",gap:2,p:2},children:R.map(s=>e.jsxs(xe,{sx:{p:2,border:t.includes(s.deal_id)?`2px solid ${V.purple.main}`:"1px solid",borderColor:t.includes(s.deal_id)?V.purple.main:"divider",cursor:"pointer"},onClick:()=>c(`/deals/${s.deal_id}`),children:[e.jsxs(o,{display:"flex",justifyContent:"space-between",alignItems:"start",mb:2,children:[e.jsxs(o,{display:"flex",gap:2,flex:1,children:[s.image_url&&e.jsx(o,{component:"img",src:s.image_url,sx:{width:64,height:64,borderRadius:1,objectFit:"cover"}}),e.jsxs(o,{flex:1,children:[e.jsx(n,{variant:"body2",fontWeight:600,mb:.5,children:s.title||"Pending analysis..."}),e.jsx(n,{variant:"caption",fontFamily:"monospace",color:"text.secondary",children:s.asin})]})]}),e.jsx(je,{size:"small",checked:t.includes(s.deal_id),onClick:r=>{r.stopPropagation(),Q(s.deal_id)}})]}),e.jsxs(o,{display:"flex",justifyContent:"space-between",gap:2,flexWrap:"wrap",children:[e.jsxs(o,{children:[e.jsx(n,{variant:"caption",color:"text.secondary",children:"ROI"}),e.jsx(n,{variant:"body2",fontWeight:600,color:s.roi>=30?"success.main":"text.primary",children:s.roi?`${s.roi.toFixed(0)}%`:"-"})]}),e.jsxs(o,{children:[e.jsx(n,{variant:"caption",color:"text.secondary",children:"Profit"}),e.jsxs(n,{variant:"body2",fontWeight:600,color:s.profit>0?"success.main":"error.main",children:["$",s.profit?s.profit.toFixed(2):"-"]})]}),e.jsxs(o,{children:[e.jsx(n,{variant:"caption",color:"text.secondary",children:"Cost"}),e.jsxs(n,{variant:"body2",children:["$",(s.buy_cost||0).toFixed(2)]})]}),e.jsx(ge,{label:s.stage||"new",size:"small",sx:{height:22,fontSize:11}})]})]},s.deal_id))})]}),e.jsx(bs,{open:A,onClose:()=>l(!1),onAdded:()=>{l(!1),_()},suppliers:T}),e.jsx(js,{open:E,onClose:()=>M(!1),onComplete:j})]})}function bs({open:c,onClose:h,onAdded:p,suppliers:w}){const[d,m]=i.useState({asin:"",buy_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),[y,S]=i.useState(!1),{showToast:g}=ce(),F=async()=>{var t,f;if(d.asin){S(!0);try{await P.post("/products",{asin:d.asin,buy_cost:d.buy_cost?parseFloat(d.buy_cost):null,supplier_id:d.supplier_id||null,supplier_name:d.supplier_name||null,moq:parseInt(d.moq)||1,notes:d.notes}),m({asin:"",buy_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),p()}catch(u){g(((f=(t=u.response)==null?void 0:t.data)==null?void 0:f.detail)||"Failed to add product","error")}finally{S(!1)}}};return e.jsxs(re,{open:c,onClose:h,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ae,{children:"Add Product"}),e.jsx(ne,{children:e.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(J,{label:"ASIN",value:d.asin,onChange:t=>m({...d,asin:t.target.value.toUpperCase()}),placeholder:"B08VBVBS7N",required:!0}),e.jsx(J,{label:"Buy Cost",type:"number",value:d.buy_cost,onChange:t=>m({...d,buy_cost:t.target.value}),InputProps:{startAdornment:e.jsx(Te,{position:"start",children:"$"})}}),e.jsxs(le,{children:[e.jsx(ie,{children:"Supplier"}),e.jsxs(oe,{value:d.supplier_id,label:"Supplier",onChange:t=>m({...d,supplier_id:t.target.value,supplier_name:""}),children:[e.jsx(K,{value:"",children:"Select existing..."}),w.map(t=>e.jsx(K,{value:t.id,children:t.name},t.id))]})]}),e.jsx(J,{label:"Or New Supplier Name",value:d.supplier_name,onChange:t=>m({...d,supplier_name:t.target.value,supplier_id:""}),placeholder:"Enter new supplier name"}),e.jsx(J,{label:"MOQ",type:"number",value:d.moq,onChange:t=>m({...d,moq:t.target.value})}),e.jsx(J,{label:"Notes",multiline:!0,rows:2,value:d.notes,onChange:t=>m({...d,notes:t.target.value})})]})}),e.jsxs(de,{children:[e.jsx(v,{onClick:h,children:"Cancel"}),e.jsx(v,{variant:"contained",onClick:F,disabled:y||!d.asin,children:y?e.jsx(G,{size:20}):"Add Product"})]})]})}export{$s as default};

import{t as Be,v as We,r as l,w as qe,_ as Le,j as e,y as Oe,x as Ve,z as Je,E as He,T as a,c as fe,a3 as se,o as P,X as re,Y as ae,I as ee,$ as ne,B as i,O as Z,a as b,a4 as ze,a5 as he,a6 as me,p as G,K as Ae,a7 as le,a8 as ie,a9 as oe,aa as K,q as J,a0 as Qe,ab as ce,D as Ge,k as Ie,u as Ke,h as O,P as Pe,e as Xe,M as Ye,S as Ze,Z as es,ac as ss,C as xe,R as ts,d as ge,J as rs}from"./index-DJeRhYJi.js";import{C as Fe}from"./Collapse-BToHf9p0.js";import{D as de,P as ve}from"./plus-CpQxcSIg.js";import{S as as}from"./SupplierFormModal-BW9PmJhG.js";import{h as Se}from"./errorHandler-l0UVzPhu.js";import{T as ns,a as Ce}from"./Tabs-CErR3Ypt.js";import{C as ls}from"./clock-ZgJdUFyN.js";import{I as Te}from"./InputAdornment-CHJE27Vs.js";import{R as is}from"./refresh-cw-BFMFwtxT.js";import{C as je}from"./Checkbox-CBdW0AXR.js";import{E as os}from"./external-link-DArXF2mN.js";import"./SwitchBase-LM0WE4No.js";function cs(o){return Be("MuiAlertTitle",o)}We("MuiAlertTitle",["root"]);const ds=["className"],ps=o=>{const{classes:x}=o;return He({root:["root"]},cs,x)},us=Oe(a,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(o,x)=>x.root})(({theme:o})=>({fontWeight:o.typography.fontWeightMedium,marginTop:-2})),te=l.forwardRef(function(x,p){const C=qe({props:x,name:"MuiAlertTitle"}),{className:c}=C,h=Le(C,ds),j=C,v=ps(j);return e.jsx(us,Ve({gutterBottom:!0,component:"div",ownerState:j,ref:p,className:Je(v.root,c)},h))});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=fe("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=fe("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=fe("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),$e=se(e.jsx("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),ye=se(e.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),Ee=se(e.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),Me=se(e.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),gs=se(e.jsx("path",{d:"M8 5v14l11-7z"}),"PlayArrow"),we=se(e.jsx("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"}),"Upload");function js({open:o,onClose:x,onComplete:p}){var f,A,g,L,R,U;const[C,c]=l.useState([]),[h,j]=l.useState(""),[v,m]=l.useState(""),[F,t]=l.useState(!1),[y,u]=l.useState(!1),[S,T]=l.useState(null),[$,_]=l.useState(null),[n,E]=l.useState(null),[M,D]=l.useState(!1),[N,k]=l.useState(null),[q,B]=l.useState(!1);l.useEffect(()=>{o&&(z(),w())},[o]),l.useEffect(()=>{if(!$)return;const s=setInterval(async()=>{try{const r=await P.get(`/jobs/${$}`);E(r.data),(r.data.status==="completed"||r.data.status==="failed")&&(clearInterval(s),D(!1),r.data.status==="completed"&&p&&setTimeout(()=>{p(r.data.result)},500))}catch(r){console.error("Error polling job:",r),clearInterval(s),D(!1)}},2e3);return()=>clearInterval(s)},[$,p]);const z=async()=>{try{const s=await P.get("/suppliers");c(s.data.suppliers||s.data||[])}catch(s){console.error("Error fetching suppliers:",s)}},w=()=>{j(""),m(""),t(!1),T(null),_(null),E(null),D(!1),k(null),B(!1)},X=async()=>{var s,r;if(v.trim()){u(!0);try{const I=(await P.post("/suppliers",{name:v.trim()})).data;c([...C,I]),j(I.id),t(!1),m("")}catch(d){k(((r=(s=d.response)==null?void 0:s.data)==null?void 0:r.detail)||"Failed to create supplier")}finally{u(!1)}}},Y=s=>{var I;const r=(I=s.target.files)==null?void 0:I[0];if(!r)return;const d=r.name.toLowerCase().slice(r.name.lastIndexOf("."));if(![".csv",".xlsx",".xls"].includes(d)){k("Please upload a .csv or .xlsx file");return}T(r),k(null)},H=async()=>{var s,r;if(!S||!h){k("Please select a supplier and file");return}D(!0),k(null);try{const d=new FormData;d.append("file",S),d.append("supplier_id",h);const I=await P.post("/products/upload",d,{headers:{"Content-Type":"multipart/form-data"}});_(I.data.job_id)}catch(d){k(((r=(s=d.response)==null?void 0:s.data)==null?void 0:r.detail)||"Upload failed"),D(!1)}},Q=((f=C.find(s=>s.id===h))==null?void 0:f.name)||"";return e.jsxs(re,{open:o,onClose:x,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ae,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:["Upload Price List",e.jsx(ee,{onClick:x,size:"small",children:e.jsx(ye,{fontSize:"small"})})]}),e.jsxs(ne,{children:[(n==null?void 0:n.status)==="completed"&&e.jsx(i,{children:e.jsxs(Z,{severity:"success",sx:{mb:2},children:[e.jsx(te,{children:"Upload Complete"}),e.jsxs(a,{variant:"body2",sx:{mt:1},children:["Supplier: ",e.jsx("strong",{children:(A=n.result)==null?void 0:A.supplier_name})]}),e.jsxs(a,{variant:"body2",children:["Products created: ",e.jsx("strong",{children:((g=n.result)==null?void 0:g.products_created)||0})]}),e.jsxs(a,{variant:"body2",children:["Deals processed: ",e.jsx("strong",{children:((L=n.result)==null?void 0:L.deals_processed)||0})]}),((U=(R=n.result)==null?void 0:R.errors)==null?void 0:U.length)>0&&e.jsxs(i,{sx:{mt:2},children:[e.jsxs(b,{size:"small",onClick:()=>B(!q),endIcon:q?e.jsx(Ee,{}):e.jsx(Me,{}),children:[n.result.errors.length," errors"]}),e.jsx(Fe,{in:q,children:e.jsx(ze,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:n.result.errors.map((s,r)=>e.jsx(he,{children:e.jsx(me,{primary:s,primaryTypographyProps:{variant:"caption"}})},r))})})]})]})}),(n==null?void 0:n.status)==="failed"&&e.jsxs(Z,{severity:"error",sx:{mb:2},children:[e.jsx(te,{children:"Upload Failed"}),e.jsx(a,{variant:"body2",children:n.error})]}),((n==null?void 0:n.status)==="processing"||(n==null?void 0:n.status)==="pending"||(n==null?void 0:n.status)==="parsing")&&e.jsxs(i,{sx:{mb:2},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(G,{size:20}),e.jsx(a,{variant:"body1",children:n.status==="parsing"?"Parsing file...":`Processing for ${Q}...`})]}),e.jsx(Ae,{variant:"determinate",value:n.progress||0,sx:{mb:1,height:8,borderRadius:1}}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:[n.processed_items||0," / ",n.total_items||"?"," rows"]})]}),!n&&e.jsxs(e.Fragment,{children:[e.jsxs(i,{sx:{mb:3},children:[e.jsxs(le,{fullWidth:!0,sx:{mb:2},children:[e.jsx(ie,{children:"Supplier *"}),e.jsxs(oe,{value:h,label:"Supplier *",onChange:s=>j(s.target.value),children:[e.jsx(K,{value:"",children:"Select supplier..."}),C.map(s=>e.jsx(K,{value:s.id,children:s.name},s.id))]})]}),F?e.jsxs(i,{sx:{display:"flex",gap:1},children:[e.jsx(J,{fullWidth:!0,size:"small",label:"New supplier name",value:v,onChange:s=>m(s.target.value),onKeyDown:s=>s.key==="Enter"&&X(),autoFocus:!0}),e.jsx(b,{variant:"contained",size:"small",onClick:X,disabled:y||!v.trim(),children:y?e.jsx(G,{size:16}):"Add"}),e.jsx(ee,{size:"small",onClick:()=>{t(!1),m("")},children:e.jsx(ye,{fontSize:"small"})})]}):e.jsx(b,{variant:"outlined",size:"small",startIcon:e.jsx($e,{}),onClick:()=>t(!0),fullWidth:!0,children:"Add New Supplier"})]}),e.jsxs(i,{sx:{mb:2},children:[e.jsx("input",{type:"file",id:"file-upload",hidden:!0,accept:".csv,.xlsx,.xls",onChange:Y}),e.jsx("label",{htmlFor:"file-upload",children:e.jsx(i,{sx:{border:"2px dashed",borderColor:S?"primary.main":"divider",borderRadius:2,p:4,textAlign:"center",cursor:"pointer",bgcolor:S?"primary.50":"background.paper","&:hover":{borderColor:"primary.main",bgcolor:"action.hover"}},children:S?e.jsxs(i,{children:[e.jsx(a,{variant:"body1",fontWeight:"600",children:S.name}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:[(S.size/1024).toFixed(1)," KB"]}),e.jsx(a,{variant:"caption",color:"primary",sx:{display:"block",mt:1},children:"Click to change"})]}):e.jsxs(i,{children:[e.jsx(we,{sx:{fontSize:32,color:"text.secondary",mb:1}}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Drop CSV or Excel file here"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:".csv, .xlsx, .xls"})]})})})]}),N&&e.jsx(Z,{severity:"error",sx:{mb:2},children:N}),e.jsx(a,{variant:"caption",color:"text.secondary",sx:{display:"block",textAlign:"center"},children:"All products in this file will be assigned to the selected supplier"})]})]}),e.jsx(de,{children:(n==null?void 0:n.status)==="completed"?e.jsxs(e.Fragment,{children:[e.jsx(b,{onClick:w,children:"Upload Another"}),e.jsx(b,{variant:"contained",onClick:x,children:"Done"})]}):(n==null?void 0:n.status)==="failed"?e.jsx(b,{onClick:w,children:"Try Again"}):e.jsxs(e.Fragment,{children:[e.jsx(b,{onClick:x,children:"Cancel"}),e.jsx(b,{variant:"contained",onClick:H,disabled:!S||!h||M,startIcon:M?null:e.jsx(we,{}),children:M?e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(G,{size:16}),"Starting..."]}):`Upload to ${Q||"Supplier"}`})]})})]})}function ys({open:o,onClose:x,productsWithoutSuppliers:p=[],groupedByFile:C={},productCount:c=0,onConfirm:h}){const{suppliers:j,loading:v,refetch:m}=Qe(),{showToast:F}=ce(),[t,y]=l.useState(""),[u,S]=l.useState(!1),[T,$]=l.useState(!1);l.useEffect(()=>{o&&j.length>0&&!t&&y(j[0].id)},[o,j,t]);const _=async()=>{var n,E,M,D,N;if(!t){F("Please select a supplier","error");return}$(!0);try{const k=p.map(z=>(z==null?void 0:z.id)||(z==null?void 0:z.product_id)).filter(z=>z&&!z.toString().startsWith("placeholder-"));if(k.length===0){const w=(await P.post("/products/assign-supplier",{supplier_id:t,assign_all_pending:!0})).data.total||p.length;F(`Assigned supplier to ${w} products`,"success"),setTimeout(()=>{h(t),x()},1e3);return}const B=(await P.post("/products/assign-supplier",{product_ids:k,supplier_id:t})).data.total;F(`Assigned supplier to ${B} products`,"success"),setTimeout(()=>{h(t),x()},1e3)}catch(k){console.error("Failed to assign suppliers:",k);const q=((M=(E=(n=k.response)==null?void 0:n.data)==null?void 0:E.detail)==null?void 0:M.message)||((N=(D=k.response)==null?void 0:D.data)==null?void 0:N.detail)||"Failed to assign suppliers";F(q,"error")}finally{$(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(re,{open:o,onClose:x,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ae,{children:e.jsx(a,{variant:"h6",fontWeight:600,children:"Select Supplier for Analysis"})}),e.jsxs(ne,{children:[e.jsxs(Z,{severity:"warning",sx:{mb:3},children:[e.jsxs(a,{variant:"body2",fontWeight:600,gutterBottom:!0,children:[c||p.length," product",(c||p.length)!==1?"s":""," ",(c||p.length)===1?"has":"have"," no supplier assigned."]}),e.jsx(a,{variant:"body2",children:"Analysis requires a supplier to track where products come from. Please select a supplier to assign to these products."})]}),e.jsx(i,{sx:{mb:2},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(ie,{children:"Supplier"}),e.jsx(oe,{value:t,onChange:n=>y(n.target.value),label:"Supplier",disabled:T||v,children:j.map(n=>e.jsx(K,{value:n.id,children:n.name},n.id))})]})}),e.jsx(i,{sx:{display:"flex",justifyContent:"center",mb:2},children:e.jsx(b,{startIcon:e.jsx($e,{}),onClick:()=>S(!0),variant:"outlined",size:"small",children:"Create New Supplier"})}),e.jsx(Ge,{sx:{my:2}}),Object.keys(C).length>0?e.jsxs(i,{sx:{mb:2},children:[e.jsx(a,{variant:"body2",fontWeight:600,gutterBottom:!0,children:"Products grouped by file:"}),Object.entries(C).map(([n,E])=>e.jsxs(i,{sx:{mb:1,p:1,bgcolor:"action.hover",borderRadius:1},children:[e.jsxs(a,{variant:"caption",fontWeight:600,display:"block",children:[n,": ",E.length," product",E.length!==1?"s":""]}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:[E.slice(0,5).map(M=>M.asin).join(", "),E.length>5&&` ... and ${E.length-5} more`]})]},n))]}):p.length>0&&e.jsxs(a,{variant:"caption",color:"text.secondary",children:["Products: ",p.slice(0,10).map(n=>n.asin).join(", "),p.length>10&&` ... and ${p.length-10} more`]})]}),e.jsxs(de,{children:[e.jsx(b,{onClick:x,disabled:T,children:"Cancel"}),e.jsx(b,{onClick:_,variant:"contained",disabled:!t||T,children:T?"Assigning...":`Assign to ${c||p.length} Product${(c||p.length)!==1?"s":""}`})]})]}),e.jsx(as,{open:u,onClose:async()=>{S(!1),m&&await m()},supplier:null})]})}function _e({productIds:o=null,analyzeAllPending:x=!1,onComplete:p=null,buttonText:C="Analyze All",className:c=""}){const{hasFeature:h,promptUpgrade:j}=Ie(),{showToast:v}=ce(),[m,F]=l.useState(null),[t,y]=l.useState(null),[u,S]=l.useState(!1),[T,$]=l.useState(!1),[_,n]=l.useState(!1),[E,M]=l.useState(!1),[D,N]=l.useState([]),[k,q]=l.useState({}),[B,z]=l.useState(0);l.useEffect(()=>{if(!m)return;const f=setInterval(async()=>{var A;try{const g=await P.get(`/jobs/${m}`);y(g.data),(g.data.status==="completed"||g.data.status==="failed"||g.data.status==="cancelled")&&(clearInterval(f),g.data.status==="completed"&&p&&p(g.data))}catch(g){console.error("Error polling job:",g),((A=g.response)==null?void 0:A.status)===404&&clearInterval(f)}},2e3);return()=>clearInterval(f)},[m,p]);const w=async()=>{var f,A,g,L,R,U;if(!h("bulk_analyze")){j("bulk_analyze");return}S(!0);try{const s={};o?s.product_ids=o:x&&(s.analyze_all_pending=!0);const r=await P.post("/batch/analyze",s);F(r.data.job_id),y({status:"pending",total_items:r.data.total,progress:0}),$(!0)}catch(s){console.error("Error starting batch:",s),console.error("Error response:",(f=s.response)==null?void 0:f.data),console.error("Error response detail:",(g=(A=s.response)==null?void 0:A.data)==null?void 0:g.detail);const r=(R=(L=s.response)==null?void 0:L.data)==null?void 0:R.detail;let d=r;if(typeof r=="string")try{d=JSON.parse(r)}catch{d={message:r}}if(console.log("Parsed error object:",d),d&&typeof d=="object"&&d.error==="products_missing_suppliers"){console.log("Products without suppliers:",d.products),console.log("Grouped by file:",d.grouped_by_file),console.log("Count:",d.count);const I=d.count||((U=d.products)==null?void 0:U.length)||0,W=d.products||[];z(I);let V=W;I>0&&W.length===0&&(V=Array(Math.min(I,100)).fill(null).map((be,pe)=>({id:`placeholder-${pe}`,asin:"...",title:"Product details loading..."}))),N(V),q(d.grouped_by_file||{}),M(!0)}else{const I=(d==null?void 0:d.message)||(r==null?void 0:r.message)||(typeof r=="string"?r:JSON.stringify(r))||"Failed to start analysis";console.error("Showing error toast:",I),v(I,"error")}}finally{S(!1)}},X=async f=>{M(!1),N([]),setTimeout(()=>{w()},2e3)},Y=async()=>{var f,A;if(m)try{await P.post(`/jobs/${m}/cancel`),y(g=>({...g,status:"cancelled"})),setTimeout(()=>{$(!1),H()},1e3)}catch(g){console.error("Error cancelling:",g);const L=((A=(f=g.response)==null?void 0:f.data)==null?void 0:A.detail)||g.message||"Failed to cancel job";v(`Failed to cancel: ${L}`,"error")}},H=()=>{F(null),y(null),$(!1),n(!1)};if(T&&t){const f=t.status==="processing"||t.status==="pending",A=t.status==="completed",g=t.status==="failed",L=t.status==="cancelled",R=t.errors||[],U=f&&t.processed_items>0?Math.ceil((t.total_items-t.processed_items)/5):0;return e.jsxs(re,{open:T,onClose:f?void 0:H,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(ae,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(a,{variant:"h6",children:[f&&"Analyzing Products...",A&&"Analysis Complete",g&&"Analysis Failed",L&&"Analysis Cancelled"]}),!f&&e.jsx(ee,{onClick:H,size:"small",children:e.jsx(ye,{})})]}),e.jsxs(ne,{children:[e.jsxs(i,{sx:{mb:2},children:[e.jsx(Ae,{variant:"determinate",value:t.progress||0,sx:{mb:1,height:8,borderRadius:1},color:A?"success":g?"error":"primary"}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:[t.processed_items||0," / ",t.total_items||0," products"]})]}),e.jsxs(i,{sx:{mb:2},children:[t.success_count>0&&e.jsxs(a,{variant:"body2",color:"success.main",sx:{mb:.5},children:["✓ Success: ",t.success_count]}),t.error_count>0&&e.jsxs(a,{variant:"body2",color:"error.main",sx:{mb:.5},children:["✗ Errors: ",t.error_count]})]}),f&&U>0&&e.jsxs(a,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:2},children:["~",U," seconds remaining"]}),A&&e.jsxs(Z,{severity:"success",sx:{mb:2},children:[e.jsx(te,{children:"Analysis Complete"}),e.jsxs(a,{variant:"body2",children:["Successfully analyzed ",t.success_count," products",t.error_count>0&&", {job.error_count} errors"]})]}),g&&e.jsxs(Z,{severity:"error",sx:{mb:2},children:[e.jsx(te,{children:"Analysis Failed"}),e.jsx(a,{variant:"body2",children:R[0]||"Unknown error"})]}),R.length>0&&e.jsxs(i,{sx:{mt:2},children:[e.jsxs(b,{size:"small",onClick:()=>n(!_),endIcon:_?e.jsx(Ee,{}):e.jsx(Me,{}),children:["View ",R.length," ",R.length===1?"error":"errors"]}),e.jsx(Fe,{in:_,children:e.jsxs(ze,{dense:!0,sx:{maxHeight:200,overflow:"auto",mt:1},children:[R.slice(0,20).map((s,r)=>e.jsx(he,{children:e.jsx(me,{primary:s,primaryTypographyProps:{variant:"caption"}})},r)),R.length>20&&e.jsx(he,{children:e.jsx(me,{primary:`... and ${R.length-20} more errors`,primaryTypographyProps:{variant:"caption",color:"text.secondary"}})})]})})]})]}),e.jsxs(de,{children:[f&&e.jsx(b,{onClick:Y,color:"error",children:"Cancel"}),!f&&e.jsx(b,{onClick:H,variant:"contained",children:A?"Done":"Close"})]})]})}const Q=h("bulk_analyze");return e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"contained",onClick:w,disabled:u||!Q,startIcon:u?e.jsx(G,{size:16}):e.jsx(gs,{}),className:c,title:Q?"":"Bulk analysis requires Starter or higher",children:u?"Starting...":C}),e.jsx(ys,{open:E,onClose:()=>{M(!1),N([]),q({})},productsWithoutSuppliers:D,groupedByFile:k,productCount:B,onConfirm:X})]})}const fs=[{id:"new",label:"New",icon:Pe,color:O.purple.main},{id:"analyzing",label:"Analyzing",icon:ls,color:O.warning.main},{id:"reviewed",label:"Reviewed",icon:Xe,color:O.info.main},{id:"buy_list",label:"Buy List",icon:Ye,color:O.success.main},{id:"ordered",label:"Ordered",icon:xs,color:O.gray[400]}];function ke(o,x){const[p,C]=l.useState(o);return l.useEffect(()=>{const c=setTimeout(()=>{C(o)},x);return()=>{clearTimeout(c)}},[o,x]),p}const Re=ts.memo(({deal:o,selected:x,onSelect:p,onClick:C,onUpdateMoq:c})=>{const h=o.roi||0,j=o.profit||0,v=o.moq||1,m=o.buy_cost||0,F=o.total_investment||v*m,t=v*j,[y,u]=l.useState(!1),[S,T]=l.useState(v),$=()=>{c(o.deal_id,S),u(!1)};return e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:"40px 110px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",alignItems:"center","&:hover":{bgcolor:"action.hover"},cursor:"pointer"},onClick:C,children:[e.jsx(je,{size:"small",checked:x,onClick:_=>_.stopPropagation(),onChange:p}),e.jsx(a,{variant:"body2",fontFamily:"monospace",fontSize:12,children:o.asin}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,minWidth:0},children:[o.image_url?e.jsx(i,{component:"img",src:o.image_url,sx:{width:32,height:32,borderRadius:1,objectFit:"cover",flexShrink:0}}):e.jsx(i,{sx:{width:32,height:32,bgcolor:O.navy.light,borderRadius:1}}),e.jsx(a,{variant:"body2",noWrap:!0,sx:{minWidth:0},children:o.title||"Pending analysis..."})]}),e.jsx(a,{variant:"body2",color:"text.secondary",noWrap:!0,children:o.supplier_name||"Unknown"}),e.jsx(i,{sx:{textAlign:"right"},onClick:_=>_.stopPropagation(),children:y?e.jsx(J,{size:"small",type:"number",value:S,onChange:_=>T(parseInt(_.target.value)||1),onBlur:$,onKeyDown:_=>_.key==="Enter"&&$(),autoFocus:!0,sx:{width:50},inputProps:{min:1,style:{textAlign:"right",padding:"4px"}}}):e.jsx(ge,{label:v,size:"small",onClick:()=>u(!0),sx:{minWidth:40,cursor:"pointer",bgcolor:O.gray[300],"&:hover":{bgcolor:O.navy.light}}})}),e.jsxs(a,{variant:"body2",align:"right",color:"text.secondary",children:["$",m.toFixed(2)]}),e.jsxs(a,{variant:"body2",align:"right",fontWeight:"600",color:F>500?"warning.main":"text.primary",children:["$",F.toFixed(2)]}),e.jsx(a,{variant:"body2",align:"right",fontWeight:"600",color:h>=30?"success.main":h>0?"warning.main":"error.main",children:h?`${h.toFixed(0)}%`:"-"}),e.jsx(rs,{title:`Total: $${t.toFixed(2)}`,children:e.jsxs(a,{variant:"body2",align:"right",color:j>0?"success.main":"error.main",children:["$",j?j.toFixed(2):"-"]})}),e.jsx(ge,{label:o.stage||"new",size:"small",sx:{height:22,fontSize:11}}),e.jsx(ee,{size:"small",component:"a",href:`https://amazon.com/dp/${o.asin}`,target:"_blank",onClick:_=>_.stopPropagation(),children:e.jsx(os,{size:14})})]})});Re.displayName="DealRow";function $s(){const o=Ke(),x=l.useRef(!1),[p,C]=l.useState([]),[c,h]=l.useState({stages:{},total:0}),[j,v]=l.useState(!0),[m,F]=l.useState(null),[t,y]=l.useState([]),[u,S]=l.useState({minRoi:"",minProfit:"",search:"",supplier:""}),[T,$]=l.useState([]),[_,n]=l.useState(!1),[E,M]=l.useState(!1),[D,N]=l.useState(!1),{hasFeature:k,promptUpgrade:q}=Ie(),{showToast:B}=ce(),z=ke(u.search,500),w=l.useCallback(async()=>{if(!x.current){x.current=!0,v(!0);try{const s=new URLSearchParams;m&&s.append("stage",m),u.minRoi&&s.append("min_roi",u.minRoi),u.minProfit&&s.append("min_profit",u.minProfit),z&&s.append("search",z),u.supplier&&s.append("supplier_id",u.supplier),s.append("limit","100");const[r,d]=await Promise.all([P.get(`/products?${s}`),P.get("/products/stats")]);C(r.data.deals||r.data||[]),h(d.data||{stages:{},total:0})}catch(s){console.error("Failed to fetch:",s)}finally{v(!1),x.current=!1}}},[m,u.minRoi,u.minProfit,z,u.supplier]),X=l.useCallback(async()=>{try{const s=await P.get("/suppliers");$(s.data.suppliers||s.data||[])}catch(s){console.error("Failed to fetch suppliers:",s)}},[]);l.useEffect(()=>{w(),X()},[]);const Y=ke(m,300);l.useEffect(()=>{Y!==void 0&&w()},[Y]);const H=s=>{s.target.checked?y(p.map(r=>r.deal_id)):y([])},Q=s=>{y(r=>r.includes(s)?r.filter(d=>d!==s):[...r,s])},f=async()=>{if(t.length){N(!0);try{const s=await P.post("/products/bulk-analyze",{deal_ids:t});B(`Queued ${s.data.queued} products for analysis`,"success"),y([]),w()}catch(s){Se(s,B)}finally{N(!1)}}},A=async s=>{if(t.length)try{await P.post("/products/bulk-stage",{deal_ids:t,stage:s}),y([]),w()}catch(r){Se(r,B)}},g=s=>{setTimeout(()=>{w()},2e3),console.log("Upload complete:",s)},L=async()=>{var s,r;if(!k("export_data")){q("export_data");return}try{const d=m?`?stage=${m}`:"",W=(await P.get(`/products/export${d}`)).data.rows||[];if(!W.length)return;const V=Object.keys(W[0]),be=[V.join(","),...W.map(De=>V.map(Ne=>`"${De[Ne]||""}"`).join(","))].join(`
`),pe=new Blob([be],{type:"text/csv"}),Ue=URL.createObjectURL(pe),ue=document.createElement("a");ue.href=Ue,ue.download=`deals-${m||"all"}-${Date.now()}.csv`,ue.click()}catch(d){console.error("Export failed:",d),B("Export failed: "+(((r=(s=d.response)==null?void 0:s.data)==null?void 0:r.detail)||d.message),"error")}},R=async(s,r)=>{var d,I;try{await P.patch(`/products/deal/${s}`,{moq:r}),C(W=>W.map(V=>V.deal_id===s?{...V,moq:r,total_investment:(V.buy_cost||0)*r}:V))}catch(W){console.error("Failed to update MOQ:",W),B("Failed to update MOQ: "+(((I=(d=W.response)==null?void 0:d.data)==null?void 0:I.detail)||W.message),"error")}},U=l.useMemo(()=>p,[p]);return e.jsxs(i,{sx:{p:3},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(a,{variant:"h4",fontWeight:"700",children:"Products"}),e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(_e,{analyzeAllPending:!0,buttonText:"Analyze All Pending",onComplete:()=>setTimeout(()=>w(),1e3)}),t.length>0&&e.jsx(_e,{productIds:t,buttonText:`Analyze ${t.length} Selected`,onComplete:()=>{y([]),setTimeout(()=>w(),1e3)}}),e.jsx(b,{variant:"outlined",startIcon:e.jsx(ms,{size:16}),onClick:()=>M(!0),children:"Upload File"}),e.jsx(b,{variant:"contained",startIcon:e.jsx(ve,{size:16}),onClick:()=>n(!0),children:"Add ASIN"})]})]}),e.jsx(i,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(ns,{value:m||"all",onChange:(s,r)=>F(r==="all"?null:r),children:[e.jsx(Ce,{value:"all",label:`All (${c.total||0})`}),fs.map(s=>{var r;return e.jsx(Ce,{value:s.id,label:`${s.label} (${((r=c.stages)==null?void 0:r[s.id])||0})`,icon:e.jsx(s.icon,{size:14}),iconPosition:"start"},s.id)})]})}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(J,{size:"small",placeholder:"Search ASIN...",value:u.search,onChange:s=>S({...u,search:s.target.value}),InputProps:{startAdornment:e.jsx(Te,{position:"start",children:e.jsx(Ze,{size:16})})},sx:{width:200}}),e.jsx(J,{size:"small",placeholder:"Min ROI %",type:"number",value:u.minRoi,onChange:s=>S({...u,minRoi:s.target.value}),onBlur:()=>setTimeout(()=>w(),500),sx:{width:100}}),e.jsx(J,{size:"small",placeholder:"Min Profit $",type:"number",value:u.minProfit,onChange:s=>S({...u,minProfit:s.target.value}),onBlur:()=>setTimeout(()=>w(),500),sx:{width:100}}),e.jsxs(le,{size:"small",sx:{width:150},children:[e.jsx(ie,{children:"Supplier"}),e.jsxs(oe,{value:u.supplier,label:"Supplier",onChange:s=>{S({...u,supplier:s.target.value}),setTimeout(()=>w(),500)},children:[e.jsx(K,{value:"",children:"All"}),T.map(s=>e.jsx(K,{value:s.id,children:s.name},s.id))]})]}),e.jsx(i,{sx:{flex:1}}),t.length>0&&e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsxs(a,{variant:"body2",color:"text.secondary",children:[t.length," selected"]}),e.jsx(b,{size:"small",variant:"contained",startIcon:D?e.jsx(G,{size:14}):e.jsx(es,{size:14}),onClick:f,disabled:D,children:"Analyze"}),e.jsx(b,{size:"small",variant:"outlined",onClick:()=>A("buy_list"),children:"Move to Buy List"}),e.jsx(b,{size:"small",variant:"outlined",color:"error",onClick:()=>y([]),children:e.jsx(ss,{size:14})})]}),e.jsx(ee,{onClick:w,children:e.jsx(is,{size:18})}),e.jsx(ee,{onClick:L,disabled:!k("export_data"),title:k("export_data")?"Export data":"Export requires Starter or higher",children:e.jsx(hs,{size:18})})]}),j?e.jsx(i,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(G,{})}):U.length===0?e.jsxs(xe,{sx:{p:4,textAlign:"center"},children:[e.jsx(Pe,{size:48,color:O.gray[400]}),e.jsx(a,{variant:"h6",sx:{mt:2},children:"No deals found"}),e.jsx(a,{color:"text.secondary",sx:{mb:2},children:"Upload a CSV or Excel file or add ASINs manually to get started"}),e.jsx(b,{variant:"contained",startIcon:e.jsx(ve,{size:16}),onClick:()=>n(!0),children:"Add Your First ASIN"})]}):e.jsxs(xe,{children:[e.jsxs(i,{sx:{display:{xs:"none",md:"grid"},gridTemplateColumns:"40px 110px 1fr 120px 80px 80px 80px 90px 80px 80px 60px",p:1.5,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.paper"},children:[e.jsx(je,{size:"small",checked:t.length===U.length&&U.length>0,indeterminate:t.length>0&&t.length<U.length,onChange:H}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"ASIN"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Product"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Supplier"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"MOQ"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"Unit $"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"Total $"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"ROI"}),e.jsx(a,{variant:"caption",color:"text.secondary",align:"right",children:"Profit"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Stage"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Actions"})]}),e.jsx(i,{sx:{display:{xs:"none",md:"block"}},children:U.map(s=>e.jsx(Re,{deal:s,selected:t.includes(s.deal_id),onSelect:()=>Q(s.deal_id),onClick:()=>o(`/deals/${s.deal_id}`),onUpdateMoq:R},s.deal_id))}),e.jsx(i,{sx:{display:{xs:"flex",md:"none"},flexDirection:"column",gap:2,p:2},children:U.map(s=>e.jsxs(xe,{sx:{p:2,border:t.includes(s.deal_id)?`2px solid ${O.purple.main}`:"1px solid",borderColor:t.includes(s.deal_id)?O.purple.main:"divider",cursor:"pointer"},onClick:()=>o(`/deals/${s.deal_id}`),children:[e.jsxs(i,{display:"flex",justifyContent:"space-between",alignItems:"start",mb:2,children:[e.jsxs(i,{display:"flex",gap:2,flex:1,children:[s.image_url&&e.jsx(i,{component:"img",src:s.image_url,sx:{width:64,height:64,borderRadius:1,objectFit:"cover"}}),e.jsxs(i,{flex:1,children:[e.jsx(a,{variant:"body2",fontWeight:600,mb:.5,children:s.title||"Pending analysis..."}),e.jsx(a,{variant:"caption",fontFamily:"monospace",color:"text.secondary",children:s.asin})]})]}),e.jsx(je,{size:"small",checked:t.includes(s.deal_id),onClick:r=>{r.stopPropagation(),Q(s.deal_id)}})]}),e.jsxs(i,{display:"flex",justifyContent:"space-between",gap:2,flexWrap:"wrap",children:[e.jsxs(i,{children:[e.jsx(a,{variant:"caption",color:"text.secondary",children:"ROI"}),e.jsx(a,{variant:"body2",fontWeight:600,color:s.roi>=30?"success.main":"text.primary",children:s.roi?`${s.roi.toFixed(0)}%`:"-"})]}),e.jsxs(i,{children:[e.jsx(a,{variant:"caption",color:"text.secondary",children:"Profit"}),e.jsxs(a,{variant:"body2",fontWeight:600,color:s.profit>0?"success.main":"error.main",children:["$",s.profit?s.profit.toFixed(2):"-"]})]}),e.jsxs(i,{children:[e.jsx(a,{variant:"caption",color:"text.secondary",children:"Cost"}),e.jsxs(a,{variant:"body2",children:["$",(s.buy_cost||0).toFixed(2)]})]}),e.jsx(ge,{label:s.stage||"new",size:"small",sx:{height:22,fontSize:11}})]})]},s.deal_id))})]}),e.jsx(bs,{open:_,onClose:()=>n(!1),onAdded:()=>{n(!1),w()},suppliers:T}),e.jsx(js,{open:E,onClose:()=>M(!1),onComplete:g})]})}function bs({open:o,onClose:x,onAdded:p,suppliers:C}){const[c,h]=l.useState({asin:"",buy_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),[j,v]=l.useState(!1),{showToast:m}=ce(),F=async()=>{var t,y;if(c.asin){v(!0);try{await P.post("/products",{asin:c.asin,buy_cost:c.buy_cost?parseFloat(c.buy_cost):null,supplier_id:c.supplier_id||null,supplier_name:c.supplier_name||null,moq:parseInt(c.moq)||1,notes:c.notes}),h({asin:"",buy_cost:"",supplier_id:"",supplier_name:"",moq:"1",notes:""}),p()}catch(u){m(((y=(t=u.response)==null?void 0:t.data)==null?void 0:y.detail)||"Failed to add product","error")}finally{v(!1)}}};return e.jsxs(re,{open:o,onClose:x,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ae,{children:"Add Product"}),e.jsx(ne,{children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(J,{label:"ASIN",value:c.asin,onChange:t=>h({...c,asin:t.target.value.toUpperCase()}),placeholder:"B08VBVBS7N",required:!0}),e.jsx(J,{label:"Buy Cost",type:"number",value:c.buy_cost,onChange:t=>h({...c,buy_cost:t.target.value}),InputProps:{startAdornment:e.jsx(Te,{position:"start",children:"$"})}}),e.jsxs(le,{children:[e.jsx(ie,{children:"Supplier"}),e.jsxs(oe,{value:c.supplier_id,label:"Supplier",onChange:t=>h({...c,supplier_id:t.target.value,supplier_name:""}),children:[e.jsx(K,{value:"",children:"Select existing..."}),C.map(t=>e.jsx(K,{value:t.id,children:t.name},t.id))]})]}),e.jsx(J,{label:"Or New Supplier Name",value:c.supplier_name,onChange:t=>h({...c,supplier_name:t.target.value,supplier_id:""}),placeholder:"Enter new supplier name"}),e.jsx(J,{label:"MOQ",type:"number",value:c.moq,onChange:t=>h({...c,moq:t.target.value})}),e.jsx(J,{label:"Notes",multiline:!0,rows:2,value:c.notes,onChange:t=>h({...c,notes:t.target.value})})]})}),e.jsxs(de,{children:[e.jsx(b,{onClick:x,children:"Cancel"}),e.jsx(b,{variant:"contained",onClick:F,disabled:j||!c.asin,children:j?e.jsx(G,{size:20}):"Add Product"})]})]})}export{$s as default};
